var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var RendererBase = require("awayjs-stagegl/lib/core/render/RendererBase");
var ContextGLBlendFactor = require("awayjs-stagegl/lib/core/stagegl/ContextGLBlendFactor");
var ContextGLCompareMode = require("awayjs-stagegl/lib/core/stagegl/ContextGLCompareMode");
/**
 * The DepthRenderer class renders 32-bit depth information encoded as RGBA
 *
 * @class away.render.DepthRenderer
 */
var DepthRenderer = (function (_super) {
    __extends(DepthRenderer, _super);
    /**
     * Creates a new DepthRenderer object.
     * @param renderBlended Indicates whether semi-transparent objects should be rendered.
     * @param distanceBased Indicates whether the written depth value is distance-based or projected depth-based
     */
    function DepthRenderer(pass, renderBlended) {
        if (renderBlended === void 0) { renderBlended = false; }
        _super.call(this);
        this._pass = pass;
        this._renderBlended = renderBlended;
        this._iBackgroundR = 1;
        this._iBackgroundG = 1;
        this._iBackgroundB = 1;
    }
    Object.defineProperty(DepthRenderer.prototype, "disableColor", {
        get: function () {
            return this._disableColor;
        },
        set: function (value) {
            this._disableColor = value;
        },
        enumerable: true,
        configurable: true
    });
    DepthRenderer.prototype._iRenderCascades = function (entityCollector, target, numCascades, scissorRects, cameras) {
        this.pCollectRenderables(entityCollector);
        this._pContext.setRenderTarget(target, true, 0);
        this._pContext.clear(1, 1, 1, 1, 1, 0);
        this._pContext.setBlendFactors(ContextGLBlendFactor.ONE, ContextGLBlendFactor.ZERO);
        this._pContext.setDepthTest(true, ContextGLCompareMode.LESS);
        var head = this._pOpaqueRenderableHead;
        var first = true;
        for (var i = numCascades - 1; i >= 0; --i) {
            this._pStage.scissorRect = scissorRects[i];
            this.drawCascadeRenderables(head, cameras[i], first ? null : cameras[i].frustumPlanes);
            first = false;
        }
        //line required for correct rendering when using away3d with starling. DO NOT REMOVE UNLESS STARLING INTEGRATION IS RETESTED!
        this._pContext.setDepthTest(false, ContextGLCompareMode.LESS_EQUAL);
        this._pStage.scissorRect = null;
    };
    DepthRenderer.prototype.drawCascadeRenderables = function (renderable, camera, cullPlanes) {
        var activePass;
        var activeMaterial;
        var context = this._pStage.context;
        var renderable2;
        while (renderable) {
            activeMaterial = context.getMaterial(renderable.material, this._pStage.profile);
            renderable2 = renderable;
            activePass = activeMaterial.getMaterialPass(this._pass, this._pStage.profile);
            //TODO: generalise this test
            if (activePass.key == "")
                this._pContext.calcAnimationCode(renderable.material, activePass);
            renderable.material._iActivatePass(activePass, this._pStage, camera);
            do {
                // if completely in front, it will fall in a different cascade
                // do not use near and far planes
                if (!cullPlanes || renderable2.sourceEntity.worldBounds.isInFrustum(cullPlanes, 4)) {
                    renderable2.material._iRenderPass(activePass, renderable2, this._pStage, camera, this._pRttViewProjectionMatrix);
                }
                else {
                    renderable2.cascaded = true;
                }
                renderable2 = renderable2.next;
            } while (renderable2 && renderable2.material == renderable.material && !renderable2.cascaded);
            renderable.material._iDeactivatePass(activePass, this._pStage);
            renderable = renderable2;
        }
    };
    /**
     * @inheritDoc
     */
    DepthRenderer.prototype.pDraw = function (entityCollector, target) {
        this.pCollectRenderables(entityCollector);
        this._pContext.setBlendFactors(ContextGLBlendFactor.ONE, ContextGLBlendFactor.ZERO);
        this._pContext.setDepthTest(true, ContextGLCompareMode.LESS);
        this.drawRenderables(this._pOpaqueRenderableHead, entityCollector);
        if (this._disableColor)
            this._pContext.setColorMask(false, false, false, false);
        if (this._renderBlended)
            this.drawRenderables(this._pBlendedRenderableHead, entityCollector);
        if (this._disableColor)
            this._pContext.setColorMask(true, true, true, true);
    };
    /**
     * Draw a list of renderables.
     * @param renderables The renderables to draw.
     * @param entityCollector The EntityCollector containing all potentially visible information.
     */
    DepthRenderer.prototype.drawRenderables = function (renderable, entityCollector) {
        var activePass;
        var activeMaterial;
        var context = this._pStage.context;
        var camera = entityCollector.camera;
        var renderable2;
        while (renderable) {
            activeMaterial = context.getMaterial(renderable.material, this._pStage.profile);
            // otherwise this would result in depth rendered anyway because fragment shader kil is ignored
            if (this._disableColor && renderable.material.alphaThreshold != 0) {
                renderable2 = renderable;
                do {
                    renderable2 = renderable2.next;
                } while (renderable2 && renderable2.material == renderable.material);
            }
            else {
                renderable2 = renderable;
                activePass = activeMaterial.getMaterialPass(this._pass, this._pStage.profile);
                //TODO: generalise this test
                if (activePass.key == "")
                    this._pContext.calcAnimationCode(renderable.material, activePass);
                renderable.material._iActivatePass(activePass, this._pStage, camera);
                do {
                    renderable2.material._iRenderPass(activePass, renderable2, this._pStage, camera, this._pRttViewProjectionMatrix);
                    renderable2 = renderable2.next;
                } while (renderable2 && renderable2.material == renderable.material);
                renderable.material._iDeactivatePass(activePass, this._pStage);
            }
            renderable = renderable2;
        }
    };
    return DepthRenderer;
})(RendererBase);
module.exports = DepthRenderer;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcmUvcmVuZGVyL2RlcHRocmVuZGVyZXIudHMiXSwibmFtZXMiOlsiRGVwdGhSZW5kZXJlciIsIkRlcHRoUmVuZGVyZXIuY29uc3RydWN0b3IiLCJEZXB0aFJlbmRlcmVyLmRpc2FibGVDb2xvciIsIkRlcHRoUmVuZGVyZXIuX2lSZW5kZXJDYXNjYWRlcyIsIkRlcHRoUmVuZGVyZXIuZHJhd0Nhc2NhZGVSZW5kZXJhYmxlcyIsIkRlcHRoUmVuZGVyZXIucERyYXciLCJEZXB0aFJlbmRlcmVyLmRyYXdSZW5kZXJhYmxlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBV0EsSUFBTyxZQUFZLFdBQWUsNkNBQTZDLENBQUMsQ0FBQztBQUNqRixJQUFPLG9CQUFvQixXQUFhLHNEQUFzRCxDQUFDLENBQUM7QUFDaEcsSUFBTyxvQkFBb0IsV0FBYSxzREFBc0QsQ0FBQyxDQUFDO0FBS2hHLEFBS0E7Ozs7R0FERztJQUNHLGFBQWE7SUFBU0EsVUFBdEJBLGFBQWFBLFVBQXFCQTtJQU12Q0E7Ozs7T0FJR0E7SUFDSEEsU0FYS0EsYUFBYUEsQ0FXTkEsSUFBcUJBLEVBQUVBLGFBQTZCQTtRQUE3QkMsNkJBQTZCQSxHQUE3QkEscUJBQTZCQTtRQUUvREEsaUJBQU9BLENBQUNBO1FBRVJBLElBQUlBLENBQUNBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBO1FBRWxCQSxJQUFJQSxDQUFDQSxjQUFjQSxHQUFHQSxhQUFhQSxDQUFDQTtRQUNwQ0EsSUFBSUEsQ0FBQ0EsYUFBYUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDdkJBLElBQUlBLENBQUNBLGFBQWFBLEdBQUdBLENBQUNBLENBQUNBO1FBQ3ZCQSxJQUFJQSxDQUFDQSxhQUFhQSxHQUFHQSxDQUFDQSxDQUFDQTtJQUV4QkEsQ0FBQ0E7SUFFREQsc0JBQVdBLHVDQUFZQTthQUF2QkE7WUFFQ0UsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0E7UUFDM0JBLENBQUNBO2FBRURGLFVBQXdCQSxLQUFhQTtZQUVwQ0Us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Q0FBQ0EsVUFBVUEsQ0FBQ0EsUUFBUUEsRUFBRUEsVUFBVUEsQ0FBQ0EsQ0FBQ0E7Z0JBRW5FQSxVQUFVQSxDQUFDQSxRQUFRQSxDQUFDQSxjQUFjQSxDQUFDQSxVQUFVQSxFQUFFQSxJQUFJQSxDQUFDQSxPQUFPQSxFQUFFQSxNQUFNQSxDQUFDQSxDQUFDQTtnQkFFckVBLEdBQUdBLENBQUNBO29CQUNIQSxXQUFXQSxDQUFDQSxRQUFRQSxDQUFDQSxZQUFZQSxDQUFDQSxVQUFVQSxFQUFFQSxXQUFXQSxFQUFFQSxJQUFJQSxDQUFDQSxPQUFPQSxFQUFFQSxNQUFNQSxFQUFFQSxJQUFJQSxDQUFDQSx5QkFBeUJBLENBQUNBLENBQUNBO29CQUVqSEEsV0FBV0EsR0FBR0EsV0FBV0EsQ0FBQ0EsSUFBSUEsQ0FBQ0E7Z0JBRWhDQSxDQUFDQSxRQUFRQSxXQUFXQSxJQUFJQSxXQUFXQSxDQUFDQSxRQUFRQSxJQUFJQSxVQUFVQSxDQUFDQSxRQUFRQSxFQUFFQTtnQkFFckVBLFVBQVVBLENBQUNBLFFBQVFBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsVUFBVUEsRUFBRUEsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7WUFDaEVBLENBQUNBO1lBRURBLFVBQVVBLEdBQUdBLFdBQVdBLENBQUNBO1FBQzFCQSxDQUFDQTtJQUNGQSxDQUFDQTtJQUNGTixvQkFBQ0E7QUFBREEsQ0EzS0EsQUEyS0NBLEVBM0syQixZQUFZLEVBMkt2QztBQUVELEFBQXVCLGlCQUFkLGFBQWEsQ0FBQyIsImZpbGUiOiJjb3JlL3JlbmRlci9EZXB0aFJlbmRlcmVyLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9yb2JiYXRlbWFuL1dlYnN0b3JtUHJvamVjdHMvYXdheWpzLXN0YWdlZ2wvIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IENhbWVyYVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9lbnRpdGllcy9DYW1lcmFcIik7XG5pbXBvcnQgSUVudGl0eVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9lbnRpdGllcy9JRW50aXR5XCIpO1xuaW1wb3J0IFBsYW5lM0RcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvY29yZS9nZW9tL1BsYW5lM0RcIik7XG5pbXBvcnQgUmVjdGFuZ2xlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9jb3JlL2dlb20vUmVjdGFuZ2xlXCIpO1xuaW1wb3J0IEVudGl0eUNvbGxlY3Rvclx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2NvcmUvdHJhdmVyc2UvRW50aXR5Q29sbGVjdG9yXCIpO1xuaW1wb3J0IFNoYWRvd0Nhc3RlckNvbGxlY3Rvclx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvY29yZS90cmF2ZXJzZS9TaGFkb3dDYXN0ZXJDb2xsZWN0b3JcIik7XG5pbXBvcnQgVGV4dHVyZVByb3h5QmFzZVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3RleHR1cmVzL1RleHR1cmVQcm94eUJhc2VcIik7XG5cbmltcG9ydCBNYXRlcmlhbERhdGFcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2NvcmUvcG9vbC9NYXRlcmlhbERhdGFcIik7XG5pbXBvcnQgTWF0ZXJpYWxQYXNzRGF0YVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2NvcmUvcG9vbC9NYXRlcmlhbFBhc3NEYXRhXCIpO1xuaW1wb3J0IFJlbmRlcmFibGVCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvY29yZS9wb29sL1JlbmRlcmFibGVCYXNlXCIpO1xuaW1wb3J0IFJlbmRlcmVyQmFzZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvY29yZS9yZW5kZXIvUmVuZGVyZXJCYXNlXCIpO1xuaW1wb3J0IENvbnRleHRHTEJsZW5kRmFjdG9yXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2NvcmUvc3RhZ2VnbC9Db250ZXh0R0xCbGVuZEZhY3RvclwiKTtcbmltcG9ydCBDb250ZXh0R0xDb21wYXJlTW9kZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9jb3JlL3N0YWdlZ2wvQ29udGV4dEdMQ29tcGFyZU1vZGVcIik7XG5pbXBvcnQgSUNvbnRleHRTdGFnZUdMXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvY29yZS9zdGFnZWdsL0lDb250ZXh0U3RhZ2VHTFwiKTtcbmltcG9ydCBNYXRlcmlhbFBhc3NCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvbWF0ZXJpYWxzL3Bhc3Nlcy9NYXRlcmlhbFBhc3NCYXNlXCIpO1xuXG5cbi8qKlxuICogVGhlIERlcHRoUmVuZGVyZXIgY2xhc3MgcmVuZGVycyAzMi1iaXQgZGVwdGggaW5mb3JtYXRpb24gZW5jb2RlZCBhcyBSR0JBXG4gKlxuICogQGNsYXNzIGF3YXkucmVuZGVyLkRlcHRoUmVuZGVyZXJcbiAqL1xuY2xhc3MgRGVwdGhSZW5kZXJlciBleHRlbmRzIFJlbmRlcmVyQmFzZVxue1xuXHRwcml2YXRlIF9wYXNzOk1hdGVyaWFsUGFzc0Jhc2U7XG5cdHByaXZhdGUgX3JlbmRlckJsZW5kZWQ6Ym9vbGVhbjtcblx0cHJpdmF0ZSBfZGlzYWJsZUNvbG9yOmJvb2xlYW47XG5cblx0LyoqXG5cdCAqIENyZWF0ZXMgYSBuZXcgRGVwdGhSZW5kZXJlciBvYmplY3QuXG5cdCAqIEBwYXJhbSByZW5kZXJCbGVuZGVkIEluZGljYXRlcyB3aGV0aGVyIHNlbWktdHJhbnNwYXJlbnQgb2JqZWN0cyBzaG91bGQgYmUgcmVuZGVyZWQuXG5cdCAqIEBwYXJhbSBkaXN0YW5jZUJhc2VkIEluZGljYXRlcyB3aGV0aGVyIHRoZSB3cml0dGVuIGRlcHRoIHZhbHVlIGlzIGRpc3RhbmNlLWJhc2VkIG9yIHByb2plY3RlZCBkZXB0aC1iYXNlZFxuXHQgKi9cblx0Y29uc3RydWN0b3IocGFzczpNYXRlcmlhbFBhc3NCYXNlLCByZW5kZXJCbGVuZGVkOmJvb2xlYW4gPSBmYWxzZSlcblx0e1xuXHRcdHN1cGVyKCk7XG5cblx0XHR0aGlzLl9wYXNzID0gcGFzcztcblxuXHRcdHRoaXMuX3JlbmRlckJsZW5kZWQgPSByZW5kZXJCbGVuZGVkO1xuXHRcdHRoaXMuX2lCYWNrZ3JvdW5kUiA9IDE7XG5cdFx0dGhpcy5faUJhY2tncm91bmRHID0gMTtcblx0XHR0aGlzLl9pQmFja2dyb3VuZEIgPSAxO1xuXG5cdH1cblxuXHRwdWJsaWMgZ2V0IGRpc2FibGVDb2xvcigpOmJvb2xlYW5cblx0e1xuXHRcdHJldHVybiB0aGlzLl9kaXNhYmxlQ29sb3I7XG5cdH1cblxuXHRwdWJsaWMgc2V0IGRpc2FibGVDb2xvcih2YWx1ZTpib29sZWFuKVxuXHR7XG5cdFx0dGhpcy5fZGlzYWJsZUNvbG9yID0gdmFsdWU7XG5cdH1cblxuXHRwdWJsaWMgX2lSZW5kZXJDYXNjYWRlcyhlbnRpdHlDb2xsZWN0b3I6U2hhZG93Q2FzdGVyQ29sbGVjdG9yLCB0YXJnZXQ6VGV4dHVyZVByb3h5QmFzZSwgbnVtQ2FzY2FkZXM6bnVtYmVyLCBzY2lzc29yUmVjdHM6QXJyYXk8UmVjdGFuZ2xlPiwgY2FtZXJhczpBcnJheTxDYW1lcmE+KVxuXHR7XG5cdFx0dGhpcy5wQ29sbGVjdFJlbmRlcmFibGVzKGVudGl0eUNvbGxlY3Rvcik7XG5cblx0XHR0aGlzLl9wQ29udGV4dC5zZXRSZW5kZXJUYXJnZXQodGFyZ2V0LCB0cnVlLCAwKTtcblx0XHR0aGlzLl9wQ29udGV4dC5jbGVhcigxLCAxLCAxLCAxLCAxLCAwKTtcblxuXHRcdHRoaXMuX3BDb250ZXh0LnNldEJsZW5kRmFjdG9ycyhDb250ZXh0R0xCbGVuZEZhY3Rvci5PTkUsIENvbnRleHRHTEJsZW5kRmFjdG9yLlpFUk8pO1xuXHRcdHRoaXMuX3BDb250ZXh0LnNldERlcHRoVGVzdCh0cnVlLCBDb250ZXh0R0xDb21wYXJlTW9kZS5MRVNTKTtcblxuXHRcdHZhciBoZWFkOlJlbmRlcmFibGVCYXNlID0gdGhpcy5fcE9wYXF1ZVJlbmRlcmFibGVIZWFkO1xuXG5cdFx0dmFyIGZpcnN0OmJvb2xlYW4gPSB0cnVlO1xuXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSBudW1DYXNjYWRlcyAtIDE7IGkgPj0gMDsgLS1pKSB7XG5cdFx0XHR0aGlzLl9wU3RhZ2Uuc2Npc3NvclJlY3QgPSBzY2lzc29yUmVjdHNbaV07XG5cdFx0XHR0aGlzLmRyYXdDYXNjYWRlUmVuZGVyYWJsZXMoaGVhZCwgY2FtZXJhc1tpXSwgZmlyc3Q/IG51bGwgOiBjYW1lcmFzW2ldLmZydXN0dW1QbGFuZXMpO1xuXHRcdFx0Zmlyc3QgPSBmYWxzZTtcblx0XHR9XG5cblx0XHQvL2xpbmUgcmVxdWlyZWQgZm9yIGNvcnJlY3QgcmVuZGVyaW5nIHdoZW4gdXNpbmcgYXdheTNkIHdpdGggc3RhcmxpbmcuIERPIE5PVCBSRU1PVkUgVU5MRVNTIFNUQVJMSU5HIElOVEVHUkFUSU9OIElTIFJFVEVTVEVEIVxuXHRcdHRoaXMuX3BDb250ZXh0LnNldERlcHRoVGVzdChmYWxzZSwgQ29udGV4dEdMQ29tcGFyZU1vZGUuTEVTU19FUVVBTCk7XG5cblx0XHR0aGlzLl9wU3RhZ2Uuc2Npc3NvclJlY3QgPSBudWxsO1xuXG5cdH1cblxuXHRwcml2YXRlIGRyYXdDYXNjYWRlUmVuZGVyYWJsZXMocmVuZGVyYWJsZTpSZW5kZXJhYmxlQmFzZSwgY2FtZXJhOkNhbWVyYSwgY3VsbFBsYW5lczpBcnJheTxQbGFuZTNEPilcblx0e1xuXHRcdHZhciBhY3RpdmVQYXNzOk1hdGVyaWFsUGFzc0RhdGE7XG5cdFx0dmFyIGFjdGl2ZU1hdGVyaWFsOk1hdGVyaWFsRGF0YTtcblx0XHR2YXIgY29udGV4dDpJQ29udGV4dFN0YWdlR0wgPSA8SUNvbnRleHRTdGFnZUdMPiB0aGlzLl9wU3RhZ2UuY29udGV4dDtcblx0XHR2YXIgcmVuZGVyYWJsZTI6UmVuZGVyYWJsZUJhc2U7XG5cblx0XHR3aGlsZSAocmVuZGVyYWJsZSkge1xuXHRcdFx0YWN0aXZlTWF0ZXJpYWwgPSBjb250ZXh0LmdldE1hdGVyaWFsKHJlbmRlcmFibGUubWF0ZXJpYWwsIHRoaXMuX3BTdGFnZS5wcm9maWxlKTtcblxuXHRcdFx0cmVuZGVyYWJsZTIgPSByZW5kZXJhYmxlO1xuXG5cdFx0XHRhY3RpdmVQYXNzID0gYWN0aXZlTWF0ZXJpYWwuZ2V0TWF0ZXJpYWxQYXNzKHRoaXMuX3Bhc3MsIHRoaXMuX3BTdGFnZS5wcm9maWxlKTtcblxuXHRcdFx0Ly9UT0RPOiBnZW5lcmFsaXNlIHRoaXMgdGVzdFxuXHRcdFx0aWYgKGFjdGl2ZVBhc3Mua2V5ID09IFwiXCIpXG5cdFx0XHRcdHRoaXMuX3BDb250ZXh0LmNhbGNBbmltYXRpb25Db2RlKHJlbmRlcmFibGUubWF0ZXJpYWwsIGFjdGl2ZVBhc3MpO1xuXG5cdFx0XHRyZW5kZXJhYmxlLm1hdGVyaWFsLl9pQWN0aXZhdGVQYXNzKGFjdGl2ZVBhc3MsIHRoaXMuX3BTdGFnZSwgY2FtZXJhKTtcblxuXHRcdFx0ZG8ge1xuXHRcdFx0XHQvLyBpZiBjb21wbGV0ZWx5IGluIGZyb250LCBpdCB3aWxsIGZhbGwgaW4gYSBkaWZmZXJlbnQgY2FzY2FkZVxuXHRcdFx0XHQvLyBkbyBub3QgdXNlIG5lYXIgYW5kIGZhciBwbGFuZXNcblx0XHRcdFx0aWYgKCFjdWxsUGxhbmVzIHx8IHJlbmRlcmFibGUyLnNvdXJjZUVudGl0eS53b3JsZEJvdW5kcy5pc0luRnJ1c3R1bShjdWxsUGxhbmVzLCA0KSkge1xuXHRcdFx0XHRcdHJlbmRlcmFibGUyLm1hdGVyaWFsLl9pUmVuZGVyUGFzcyhhY3RpdmVQYXNzLCByZW5kZXJhYmxlMiwgdGhpcy5fcFN0YWdlLCBjYW1lcmEsIHRoaXMuX3BSdHRWaWV3UHJvamVjdGlvbk1hdHJpeCk7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0cmVuZGVyYWJsZTIuY2FzY2FkZWQgPSB0cnVlO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmVuZGVyYWJsZTIgPSByZW5kZXJhYmxlMi5uZXh0O1xuXG5cdFx0XHR9IHdoaWxlIChyZW5kZXJhYmxlMiAmJiByZW5kZXJhYmxlMi5tYXRlcmlhbCA9PSByZW5kZXJhYmxlLm1hdGVyaWFsICYmICFyZW5kZXJhYmxlMi5jYXNjYWRlZCk7XG5cblx0XHRcdHJlbmRlcmFibGUubWF0ZXJpYWwuX2lEZWFjdGl2YXRlUGFzcyhhY3RpdmVQYXNzLCB0aGlzLl9wU3RhZ2UpO1xuXG5cdFx0XHRyZW5kZXJhYmxlID0gcmVuZGVyYWJsZTI7XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIEBpbmhlcml0RG9jXG5cdCAqL1xuXHRwdWJsaWMgcERyYXcoZW50aXR5Q29sbGVjdG9yOkVudGl0eUNvbGxlY3RvciwgdGFyZ2V0OlRleHR1cmVQcm94eUJhc2UpXG5cdHtcblx0XHR0aGlzLnBDb2xsZWN0UmVuZGVyYWJsZXMoZW50aXR5Q29sbGVjdG9yKTtcblxuXHRcdHRoaXMuX3BDb250ZXh0LnNldEJsZW5kRmFjdG9ycyhDb250ZXh0R0xCbGVuZEZhY3Rvci5PTkUsIENvbnRleHRHTEJsZW5kRmFjdG9yLlpFUk8pO1xuXG5cdFx0dGhpcy5fcENvbnRleHQuc2V0RGVwdGhUZXN0KHRydWUsIENvbnRleHRHTENvbXBhcmVNb2RlLkxFU1MpO1xuXG5cdFx0dGhpcy5kcmF3UmVuZGVyYWJsZXModGhpcy5fcE9wYXF1ZVJlbmRlcmFibGVIZWFkLCBlbnRpdHlDb2xsZWN0b3IpO1xuXG5cdFx0aWYgKHRoaXMuX2Rpc2FibGVDb2xvcilcblx0XHRcdHRoaXMuX3BDb250ZXh0LnNldENvbG9yTWFzayhmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSk7XG5cblx0XHRpZiAodGhpcy5fcmVuZGVyQmxlbmRlZClcblx0XHRcdHRoaXMuZHJhd1JlbmRlcmFibGVzKHRoaXMuX3BCbGVuZGVkUmVuZGVyYWJsZUhlYWQsIGVudGl0eUNvbGxlY3Rvcik7XG5cblx0XHRpZiAodGhpcy5fZGlzYWJsZUNvbG9yKVxuXHRcdFx0dGhpcy5fcENvbnRleHQuc2V0Q29sb3JNYXNrKHRydWUsIHRydWUsIHRydWUsIHRydWUpO1xuXHR9XG5cblx0LyoqXG5cdCAqIERyYXcgYSBsaXN0IG9mIHJlbmRlcmFibGVzLlxuXHQgKiBAcGFyYW0gcmVuZGVyYWJsZXMgVGhlIHJlbmRlcmFibGVzIHRvIGRyYXcuXG5cdCAqIEBwYXJhbSBlbnRpdHlDb2xsZWN0b3IgVGhlIEVudGl0eUNvbGxlY3RvciBjb250YWluaW5nIGFsbCBwb3RlbnRpYWxseSB2aXNpYmxlIGluZm9ybWF0aW9uLlxuXHQgKi9cblx0cHJpdmF0ZSBkcmF3UmVuZGVyYWJsZXMocmVuZGVyYWJsZTpSZW5kZXJhYmxlQmFzZSwgZW50aXR5Q29sbGVjdG9yOkVudGl0eUNvbGxlY3Rvcilcblx0e1xuXHRcdHZhciBhY3RpdmVQYXNzOk1hdGVyaWFsUGFzc0RhdGE7XG5cdFx0dmFyIGFjdGl2ZU1hdGVyaWFsOk1hdGVyaWFsRGF0YTtcblx0XHR2YXIgY29udGV4dDpJQ29udGV4dFN0YWdlR0wgPSA8SUNvbnRleHRTdGFnZUdMPiB0aGlzLl9wU3RhZ2UuY29udGV4dDtcblx0XHR2YXIgY2FtZXJhOkNhbWVyYSA9IGVudGl0eUNvbGxlY3Rvci5jYW1lcmE7XG5cdFx0dmFyIHJlbmRlcmFibGUyOlJlbmRlcmFibGVCYXNlO1xuXG5cdFx0d2hpbGUgKHJlbmRlcmFibGUpIHtcblx0XHRcdGFjdGl2ZU1hdGVyaWFsID0gY29udGV4dC5nZXRNYXRlcmlhbChyZW5kZXJhYmxlLm1hdGVyaWFsLCB0aGlzLl9wU3RhZ2UucHJvZmlsZSk7XG5cblx0XHRcdC8vIG90aGVyd2lzZSB0aGlzIHdvdWxkIHJlc3VsdCBpbiBkZXB0aCByZW5kZXJlZCBhbnl3YXkgYmVjYXVzZSBmcmFnbWVudCBzaGFkZXIga2lsIGlzIGlnbm9yZWRcblx0XHRcdGlmICh0aGlzLl9kaXNhYmxlQ29sb3IgJiYgcmVuZGVyYWJsZS5tYXRlcmlhbC5hbHBoYVRocmVzaG9sZCAhPSAwKSB7XG5cdFx0XHRcdHJlbmRlcmFibGUyID0gcmVuZGVyYWJsZTtcblx0XHRcdFx0Ly8gZmFzdCBmb3J3YXJkXG5cdFx0XHRcdGRvIHtcblx0XHRcdFx0XHRyZW5kZXJhYmxlMiA9IHJlbmRlcmFibGUyLm5leHQ7XG5cblx0XHRcdFx0fSB3aGlsZSAocmVuZGVyYWJsZTIgJiYgcmVuZGVyYWJsZTIubWF0ZXJpYWwgPT0gcmVuZGVyYWJsZS5tYXRlcmlhbCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRyZW5kZXJhYmxlMiA9IHJlbmRlcmFibGU7XG5cblx0XHRcdFx0YWN0aXZlUGFzcyA9IGFjdGl2ZU1hdGVyaWFsLmdldE1hdGVyaWFsUGFzcyh0aGlzLl9wYXNzLCB0aGlzLl9wU3RhZ2UucHJvZmlsZSk7XG5cblx0XHRcdFx0Ly9UT0RPOiBnZW5lcmFsaXNlIHRoaXMgdGVzdFxuXHRcdFx0XHRpZiAoYWN0aXZlUGFzcy5rZXkgPT0gXCJcIilcblx0XHRcdFx0XHR0aGlzLl9wQ29udGV4dC5jYWxjQW5pbWF0aW9uQ29kZShyZW5kZXJhYmxlLm1hdGVyaWFsLCBhY3RpdmVQYXNzKTtcblxuXHRcdFx0XHRyZW5kZXJhYmxlLm1hdGVyaWFsLl9pQWN0aXZhdGVQYXNzKGFjdGl2ZVBhc3MsIHRoaXMuX3BTdGFnZSwgY2FtZXJhKTtcblxuXHRcdFx0XHRkbyB7XG5cdFx0XHRcdFx0cmVuZGVyYWJsZTIubWF0ZXJpYWwuX2lSZW5kZXJQYXNzKGFjdGl2ZVBhc3MsIHJlbmRlcmFibGUyLCB0aGlzLl9wU3RhZ2UsIGNhbWVyYSwgdGhpcy5fcFJ0dFZpZXdQcm9qZWN0aW9uTWF0cml4KTtcblxuXHRcdFx0XHRcdHJlbmRlcmFibGUyID0gcmVuZGVyYWJsZTIubmV4dDtcblxuXHRcdFx0XHR9IHdoaWxlIChyZW5kZXJhYmxlMiAmJiByZW5kZXJhYmxlMi5tYXRlcmlhbCA9PSByZW5kZXJhYmxlLm1hdGVyaWFsKTtcblxuXHRcdFx0XHRyZW5kZXJhYmxlLm1hdGVyaWFsLl9pRGVhY3RpdmF0ZVBhc3MoYWN0aXZlUGFzcywgdGhpcy5fcFN0YWdlKTtcblx0XHRcdH1cblxuXHRcdFx0cmVuZGVyYWJsZSA9IHJlbmRlcmFibGUyO1xuXHRcdH1cblx0fVxufVxuXG5leHBvcnQgPSBEZXB0aFJlbmRlcmVyOyJdfQ==