var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var RendererBase = require("awayjs-stagegl/lib/core/render/RendererBase");
var ContextGLBlendFactor = require("awayjs-stagegl/lib/core/stagegl/ContextGLBlendFactor");
var ContextGLCompareMode = require("awayjs-stagegl/lib/core/stagegl/ContextGLCompareMode");
/**
 * The DepthRenderer class renders 32-bit depth information encoded as RGBA
 *
 * @class away.render.DepthRenderer
 */
var DepthRenderer = (function (_super) {
    __extends(DepthRenderer, _super);
    /**
     * Creates a new DepthRenderer object.
     * @param renderBlended Indicates whether semi-transparent objects should be rendered.
     * @param distanceBased Indicates whether the written depth value is distance-based or projected depth-based
     */
    function DepthRenderer(pass, renderBlended) {
        if (renderBlended === void 0) { renderBlended = false; }
        _super.call(this);
        this._pass = pass;
        this._renderBlended = renderBlended;
        this._iBackgroundR = 1;
        this._iBackgroundG = 1;
        this._iBackgroundB = 1;
    }
    Object.defineProperty(DepthRenderer.prototype, "disableColor", {
        get: function () {
            return this._disableColor;
        },
        set: function (value) {
            this._disableColor = value;
        },
        enumerable: true,
        configurable: true
    });
    DepthRenderer.prototype._iRenderCascades = function (entityCollector, target, numCascades, scissorRects, cameras) {
        this.pCollectRenderables(entityCollector);
        this._pContext.setRenderTarget(target, true, 0);
        this._pContext.clear(1, 1, 1, 1, 1, 0);
        this._pContext.setBlendFactors(ContextGLBlendFactor.ONE, ContextGLBlendFactor.ZERO);
        this._pContext.setDepthTest(true, ContextGLCompareMode.LESS);
        var head = this._pOpaqueRenderableHead;
        var first = true;
        for (var i = numCascades - 1; i >= 0; --i) {
            this._pStage.scissorRect = scissorRects[i];
            this.drawCascadeRenderables(head, cameras[i], first ? null : cameras[i].frustumPlanes);
            first = false;
        }
        //line required for correct rendering when using away3d with starling. DO NOT REMOVE UNLESS STARLING INTEGRATION IS RETESTED!
        this._pContext.setDepthTest(false, ContextGLCompareMode.LESS_EQUAL);
        this._pStage.scissorRect = null;
    };
    DepthRenderer.prototype.drawCascadeRenderables = function (renderable, camera, cullPlanes) {
        var activePass;
        var activeMaterial;
        var context = this._pStage.context;
        var renderable2;
        while (renderable) {
            activeMaterial = context.getMaterial(renderable.material, this._pStage.profile);
            renderable2 = renderable;
            activePass = activeMaterial.getMaterialPass(this._pass, this._pStage.profile);
            //TODO: generalise this test
            if (activePass.key == "")
                this._pContext.calcAnimationCode(renderable.material, activePass);
            renderable.material._iActivatePass(activePass, this._pStage, camera);
            do {
                // if completely in front, it will fall in a different cascade
                // do not use near and far planes
                if (!cullPlanes || renderable2.sourceEntity.worldBounds.isInFrustum(cullPlanes, 4)) {
                    renderable2.material._iRenderPass(activePass, renderable2, this._pStage, camera, this._pRttViewProjectionMatrix);
                }
                else {
                    renderable2.cascaded = true;
                }
                renderable2 = renderable2.next;
            } while (renderable2 && renderable2.material == renderable.material && !renderable2.cascaded);
            renderable.material._iDeactivatePass(activePass, this._pStage);
            renderable = renderable2;
        }
    };
    /**
     * @inheritDoc
     */
    DepthRenderer.prototype.pDraw = function (entityCollector, target) {
        this.pCollectRenderables(entityCollector);
        this._pContext.setBlendFactors(ContextGLBlendFactor.ONE, ContextGLBlendFactor.ZERO);
        this._pContext.setDepthTest(true, ContextGLCompareMode.LESS);
        this.drawRenderables(this._pOpaqueRenderableHead, entityCollector);
        if (this._disableColor)
            this._pContext.setColorMask(false, false, false, false);
        if (this._renderBlended)
            this.drawRenderables(this._pBlendedRenderableHead, entityCollector);
        if (this._disableColor)
            this._pContext.setColorMask(true, true, true, true);
    };
    /**
     * Draw a list of renderables.
     * @param renderables The renderables to draw.
     * @param entityCollector The EntityCollector containing all potentially visible information.
     */
    DepthRenderer.prototype.drawRenderables = function (renderable, entityCollector) {
        var activePass;
        var activeMaterial;
        var context = this._pStage.context;
        var camera = entityCollector.camera;
        var renderable2;
        while (renderable) {
            activeMaterial = context.getMaterial(renderable.material, this._pStage.profile);
            // otherwise this would result in depth rendered anyway because fragment shader kil is ignored
            if (this._disableColor && renderable.material.alphaThreshold != 0) {
                renderable2 = renderable;
                do {
                    renderable2 = renderable2.next;
                } while (renderable2 && renderable2.material == renderable.material);
            }
            else {
                renderable2 = renderable;
                activePass = activeMaterial.getMaterialPass(this._pass, this._pStage.profile);
                //TODO: generalise this test
                if (activePass.key == "")
                    this._pContext.calcAnimationCode(renderable.material, activePass);
                renderable.material._iActivatePass(activePass, this._pStage, camera);
                do {
                    renderable2.material._iRenderPass(activePass, renderable2, this._pStage, camera, this._pRttViewProjectionMatrix);
                    renderable2 = renderable2.next;
                } while (renderable2 && renderable2.material == renderable.material);
                renderable.material._iDeactivatePass(activePass, this._pStage);
            }
            renderable = renderable2;
        }
    };
    return DepthRenderer;
})(RendererBase);
module.exports = DepthRenderer;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1zdGFnZWdsL2xpYi9jb3JlL3JlbmRlci9kZXB0aHJlbmRlcmVyLnRzIl0sIm5hbWVzIjpbIkRlcHRoUmVuZGVyZXIiLCJEZXB0aFJlbmRlcmVyLmNvbnN0cnVjdG9yIiwiRGVwdGhSZW5kZXJlci5kaXNhYmxlQ29sb3IiLCJEZXB0aFJlbmRlcmVyLl9pUmVuZGVyQ2FzY2FkZXMiLCJEZXB0aFJlbmRlcmVyLmRyYXdDYXNjYWRlUmVuZGVyYWJsZXMiLCJEZXB0aFJlbmRlcmVyLnBEcmF3IiwiRGVwdGhSZW5kZXJlci5kcmF3UmVuZGVyYWJsZXMiXSwibWFwcGluZ3MiOiI7Ozs7OztBQVlBLElBQU8sWUFBWSxXQUFlLDZDQUE2QyxDQUFDLENBQUM7QUFDakYsSUFBTyxvQkFBb0IsV0FBYSxzREFBc0QsQ0FBQyxDQUFDO0FBQ2hHLElBQU8sb0JBQW9CLFdBQWEsc0RBQXNELENBQUMsQ0FBQztBQUtoRyxBQUtBOzs7O0dBREc7SUFDRyxhQUFhO0lBQVNBLFVBQXRCQSxhQUFhQSxVQUFxQkE7SUFNdkNBOzs7O09BSUdBO0lBQ0hBLFNBWEtBLGFBQWFBLENBV05BLElBQXFCQSxFQUFFQSxhQUE2QkE7UUFBN0JDLDZCQUE2QkEsR0FBN0JBLHFCQUE2QkE7UUFFL0RBLGlCQUFPQSxDQUFDQTtRQUVSQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUVsQkEsSUFBSUEsQ0FBQ0EsY0FBY0EsR0FBR0EsYUFBYUEsQ0FBQ0E7UUFDcENBLElBQUlBLENBQUNBLGFBQWFBLEdBQUdBLENBQUNBLENBQUNBO1FBQ3ZCQSxJQUFJQSxDQUFDQSxhQUFhQSxHQUFHQSxDQUFDQSxDQUFDQTtRQUN2QkEsSUFBSUEsQ0FBQ0EsYUFBYUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7SUFFeEJBLENBQUNBO0lBRURELHNCQUFXQSx1Q0FBWUE7YUFBdkJBO1lBRUNFLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBO1FBQzNCQSxDQUFDQTthQUVERixV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QUFTQSxDQUFDQSxpQkFBaUJBLENBQUNBLFVBQVVBLENBQUNBLFFBQVFBLEVBQUVBLFVBQVVBLENBQUNBLENBQUNBO2dCQUVuRUEsVUFBVUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsVUFBVUEsRUFBRUEsSUFBSUEsQ0FBQ0EsT0FBT0EsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7Z0JBRXJFQSxHQUFHQSxDQUFDQTtvQkFDSEEsV0FBV0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsVUFBVUEsRUFBRUEsV0FBV0EsRUFBRUEsSUFBSUEsQ0FBQ0EsT0FBT0EsRUFBRUEsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EseUJBQXlCQSxDQUFDQSxDQUFDQTtvQkFFakhBLFdBQVdBLEdBQUdBLFdBQVdBLENBQUNBLElBQUlBLENBQUNBO2dCQUVoQ0EsQ0FBQ0EsUUFBUUEsV0FBV0EsSUFBSUEsV0FBV0EsQ0FBQ0EsUUFBUUEsSUFBSUEsVUFBVUEsQ0FBQ0EsUUFBUUEsRUFBRUE7Z0JBRXJFQSxVQUFVQSxDQUFDQSxRQUFRQSxDQUFDQSxnQkFBZ0JBLENBQUNBLFVBQVVBLEVBQUVBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1lBQ2hFQSxDQUFDQTtZQUVEQSxVQUFVQSxHQUFHQSxXQUFXQSxDQUFDQTtRQUMxQkEsQ0FBQ0E7SUFDRkEsQ0FBQ0E7SUFDRk4sb0JBQUNBO0FBQURBLENBM0tBLEFBMktDQSxFQTNLMkIsWUFBWSxFQTJLdkM7QUFFRCxBQUF1QixpQkFBZCxhQUFhLENBQUMiLCJmaWxlIjoiY29yZS9yZW5kZXIvRGVwdGhSZW5kZXJlci5qcyIsInNvdXJjZVJvb3QiOiIuLi8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUGxhbmUzRFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL1BsYW5lM0RcIik7XG5pbXBvcnQgUmVjdGFuZ2xlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9nZW9tL1JlY3RhbmdsZVwiKTtcbmltcG9ydCBUZXh0dXJlUHJveHlCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdGV4dHVyZXMvVGV4dHVyZVByb3h5QmFzZVwiKTtcblxuaW1wb3J0IENhbWVyYVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9DYW1lcmFcIik7XG5pbXBvcnQgSUVudGl0eVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9JRW50aXR5XCIpO1xuaW1wb3J0IEVudGl0eUNvbGxlY3Rvclx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL3RyYXZlcnNlL0VudGl0eUNvbGxlY3RvclwiKTtcbmltcG9ydCBTaGFkb3dDYXN0ZXJDb2xsZWN0b3JcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL3RyYXZlcnNlL1NoYWRvd0Nhc3RlckNvbGxlY3RvclwiKTtcblxuaW1wb3J0IE1hdGVyaWFsRGF0YVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvY29yZS9wb29sL01hdGVyaWFsRGF0YVwiKTtcbmltcG9ydCBNYXRlcmlhbFBhc3NEYXRhXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvY29yZS9wb29sL01hdGVyaWFsUGFzc0RhdGFcIik7XG5pbXBvcnQgUmVuZGVyYWJsZUJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9jb3JlL3Bvb2wvUmVuZGVyYWJsZUJhc2VcIik7XG5pbXBvcnQgUmVuZGVyZXJCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9jb3JlL3JlbmRlci9SZW5kZXJlckJhc2VcIik7XG5pbXBvcnQgQ29udGV4dEdMQmxlbmRGYWN0b3JcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvY29yZS9zdGFnZWdsL0NvbnRleHRHTEJsZW5kRmFjdG9yXCIpO1xuaW1wb3J0IENvbnRleHRHTENvbXBhcmVNb2RlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2NvcmUvc3RhZ2VnbC9Db250ZXh0R0xDb21wYXJlTW9kZVwiKTtcbmltcG9ydCBJQ29udGV4dFN0YWdlR0xcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9jb3JlL3N0YWdlZ2wvSUNvbnRleHRTdGFnZUdMXCIpO1xuaW1wb3J0IE1hdGVyaWFsUGFzc0Jhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9tYXRlcmlhbHMvcGFzc2VzL01hdGVyaWFsUGFzc0Jhc2VcIik7XG5cblxuLyoqXG4gKiBUaGUgRGVwdGhSZW5kZXJlciBjbGFzcyByZW5kZXJzIDMyLWJpdCBkZXB0aCBpbmZvcm1hdGlvbiBlbmNvZGVkIGFzIFJHQkFcbiAqXG4gKiBAY2xhc3MgYXdheS5yZW5kZXIuRGVwdGhSZW5kZXJlclxuICovXG5jbGFzcyBEZXB0aFJlbmRlcmVyIGV4dGVuZHMgUmVuZGVyZXJCYXNlXG57XG5cdHByaXZhdGUgX3Bhc3M6TWF0ZXJpYWxQYXNzQmFzZTtcblx0cHJpdmF0ZSBfcmVuZGVyQmxlbmRlZDpib29sZWFuO1xuXHRwcml2YXRlIF9kaXNhYmxlQ29sb3I6Ym9vbGVhbjtcblxuXHQvKipcblx0ICogQ3JlYXRlcyBhIG5ldyBEZXB0aFJlbmRlcmVyIG9iamVjdC5cblx0ICogQHBhcmFtIHJlbmRlckJsZW5kZWQgSW5kaWNhdGVzIHdoZXRoZXIgc2VtaS10cmFuc3BhcmVudCBvYmplY3RzIHNob3VsZCBiZSByZW5kZXJlZC5cblx0ICogQHBhcmFtIGRpc3RhbmNlQmFzZWQgSW5kaWNhdGVzIHdoZXRoZXIgdGhlIHdyaXR0ZW4gZGVwdGggdmFsdWUgaXMgZGlzdGFuY2UtYmFzZWQgb3IgcHJvamVjdGVkIGRlcHRoLWJhc2VkXG5cdCAqL1xuXHRjb25zdHJ1Y3RvcihwYXNzOk1hdGVyaWFsUGFzc0Jhc2UsIHJlbmRlckJsZW5kZWQ6Ym9vbGVhbiA9IGZhbHNlKVxuXHR7XG5cdFx0c3VwZXIoKTtcblxuXHRcdHRoaXMuX3Bhc3MgPSBwYXNzO1xuXG5cdFx0dGhpcy5fcmVuZGVyQmxlbmRlZCA9IHJlbmRlckJsZW5kZWQ7XG5cdFx0dGhpcy5faUJhY2tncm91bmRSID0gMTtcblx0XHR0aGlzLl9pQmFja2dyb3VuZEcgPSAxO1xuXHRcdHRoaXMuX2lCYWNrZ3JvdW5kQiA9IDE7XG5cblx0fVxuXG5cdHB1YmxpYyBnZXQgZGlzYWJsZUNvbG9yKCk6Ym9vbGVhblxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX2Rpc2FibGVDb2xvcjtcblx0fVxuXG5cdHB1YmxpYyBzZXQgZGlzYWJsZUNvbG9yKHZhbHVlOmJvb2xlYW4pXG5cdHtcblx0XHR0aGlzLl9kaXNhYmxlQ29sb3IgPSB2YWx1ZTtcblx0fVxuXG5cdHB1YmxpYyBfaVJlbmRlckNhc2NhZGVzKGVudGl0eUNvbGxlY3RvcjpTaGFkb3dDYXN0ZXJDb2xsZWN0b3IsIHRhcmdldDpUZXh0dXJlUHJveHlCYXNlLCBudW1DYXNjYWRlczpudW1iZXIsIHNjaXNzb3JSZWN0czpBcnJheTxSZWN0YW5nbGU+LCBjYW1lcmFzOkFycmF5PENhbWVyYT4pXG5cdHtcblx0XHR0aGlzLnBDb2xsZWN0UmVuZGVyYWJsZXMoZW50aXR5Q29sbGVjdG9yKTtcblxuXHRcdHRoaXMuX3BDb250ZXh0LnNldFJlbmRlclRhcmdldCh0YXJnZXQsIHRydWUsIDApO1xuXHRcdHRoaXMuX3BDb250ZXh0LmNsZWFyKDEsIDEsIDEsIDEsIDEsIDApO1xuXG5cdFx0dGhpcy5fcENvbnRleHQuc2V0QmxlbmRGYWN0b3JzKENvbnRleHRHTEJsZW5kRmFjdG9yLk9ORSwgQ29udGV4dEdMQmxlbmRGYWN0b3IuWkVSTyk7XG5cdFx0dGhpcy5fcENvbnRleHQuc2V0RGVwdGhUZXN0KHRydWUsIENvbnRleHRHTENvbXBhcmVNb2RlLkxFU1MpO1xuXG5cdFx0dmFyIGhlYWQ6UmVuZGVyYWJsZUJhc2UgPSB0aGlzLl9wT3BhcXVlUmVuZGVyYWJsZUhlYWQ7XG5cblx0XHR2YXIgZmlyc3Q6Ym9vbGVhbiA9IHRydWU7XG5cblx0XHRmb3IgKHZhciBpOm51bWJlciA9IG51bUNhc2NhZGVzIC0gMTsgaSA+PSAwOyAtLWkpIHtcblx0XHRcdHRoaXMuX3BTdGFnZS5zY2lzc29yUmVjdCA9IHNjaXNzb3JSZWN0c1tpXTtcblx0XHRcdHRoaXMuZHJhd0Nhc2NhZGVSZW5kZXJhYmxlcyhoZWFkLCBjYW1lcmFzW2ldLCBmaXJzdD8gbnVsbCA6IGNhbWVyYXNbaV0uZnJ1c3R1bVBsYW5lcyk7XG5cdFx0XHRmaXJzdCA9IGZhbHNlO1xuXHRcdH1cblxuXHRcdC8vbGluZSByZXF1aXJlZCBmb3IgY29ycmVjdCByZW5kZXJpbmcgd2hlbiB1c2luZyBhd2F5M2Qgd2l0aCBzdGFybGluZy4gRE8gTk9UIFJFTU9WRSBVTkxFU1MgU1RBUkxJTkcgSU5URUdSQVRJT04gSVMgUkVURVNURUQhXG5cdFx0dGhpcy5fcENvbnRleHQuc2V0RGVwdGhUZXN0KGZhbHNlLCBDb250ZXh0R0xDb21wYXJlTW9kZS5MRVNTX0VRVUFMKTtcblxuXHRcdHRoaXMuX3BTdGFnZS5zY2lzc29yUmVjdCA9IG51bGw7XG5cblx0fVxuXG5cdHByaXZhdGUgZHJhd0Nhc2NhZGVSZW5kZXJhYmxlcyhyZW5kZXJhYmxlOlJlbmRlcmFibGVCYXNlLCBjYW1lcmE6Q2FtZXJhLCBjdWxsUGxhbmVzOkFycmF5PFBsYW5lM0Q+KVxuXHR7XG5cdFx0dmFyIGFjdGl2ZVBhc3M6TWF0ZXJpYWxQYXNzRGF0YTtcblx0XHR2YXIgYWN0aXZlTWF0ZXJpYWw6TWF0ZXJpYWxEYXRhO1xuXHRcdHZhciBjb250ZXh0OklDb250ZXh0U3RhZ2VHTCA9IDxJQ29udGV4dFN0YWdlR0w+IHRoaXMuX3BTdGFnZS5jb250ZXh0O1xuXHRcdHZhciByZW5kZXJhYmxlMjpSZW5kZXJhYmxlQmFzZTtcblxuXHRcdHdoaWxlIChyZW5kZXJhYmxlKSB7XG5cdFx0XHRhY3RpdmVNYXRlcmlhbCA9IGNvbnRleHQuZ2V0TWF0ZXJpYWwocmVuZGVyYWJsZS5tYXRlcmlhbCwgdGhpcy5fcFN0YWdlLnByb2ZpbGUpO1xuXG5cdFx0XHRyZW5kZXJhYmxlMiA9IHJlbmRlcmFibGU7XG5cblx0XHRcdGFjdGl2ZVBhc3MgPSBhY3RpdmVNYXRlcmlhbC5nZXRNYXRlcmlhbFBhc3ModGhpcy5fcGFzcywgdGhpcy5fcFN0YWdlLnByb2ZpbGUpO1xuXG5cdFx0XHQvL1RPRE86IGdlbmVyYWxpc2UgdGhpcyB0ZXN0XG5cdFx0XHRpZiAoYWN0aXZlUGFzcy5rZXkgPT0gXCJcIilcblx0XHRcdFx0dGhpcy5fcENvbnRleHQuY2FsY0FuaW1hdGlvbkNvZGUocmVuZGVyYWJsZS5tYXRlcmlhbCwgYWN0aXZlUGFzcyk7XG5cblx0XHRcdHJlbmRlcmFibGUubWF0ZXJpYWwuX2lBY3RpdmF0ZVBhc3MoYWN0aXZlUGFzcywgdGhpcy5fcFN0YWdlLCBjYW1lcmEpO1xuXG5cdFx0XHRkbyB7XG5cdFx0XHRcdC8vIGlmIGNvbXBsZXRlbHkgaW4gZnJvbnQsIGl0IHdpbGwgZmFsbCBpbiBhIGRpZmZlcmVudCBjYXNjYWRlXG5cdFx0XHRcdC8vIGRvIG5vdCB1c2UgbmVhciBhbmQgZmFyIHBsYW5lc1xuXHRcdFx0XHRpZiAoIWN1bGxQbGFuZXMgfHwgcmVuZGVyYWJsZTIuc291cmNlRW50aXR5LndvcmxkQm91bmRzLmlzSW5GcnVzdHVtKGN1bGxQbGFuZXMsIDQpKSB7XG5cdFx0XHRcdFx0cmVuZGVyYWJsZTIubWF0ZXJpYWwuX2lSZW5kZXJQYXNzKGFjdGl2ZVBhc3MsIHJlbmRlcmFibGUyLCB0aGlzLl9wU3RhZ2UsIGNhbWVyYSwgdGhpcy5fcFJ0dFZpZXdQcm9qZWN0aW9uTWF0cml4KTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRyZW5kZXJhYmxlMi5jYXNjYWRlZCA9IHRydWU7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZW5kZXJhYmxlMiA9IHJlbmRlcmFibGUyLm5leHQ7XG5cblx0XHRcdH0gd2hpbGUgKHJlbmRlcmFibGUyICYmIHJlbmRlcmFibGUyLm1hdGVyaWFsID09IHJlbmRlcmFibGUubWF0ZXJpYWwgJiYgIXJlbmRlcmFibGUyLmNhc2NhZGVkKTtcblxuXHRcdFx0cmVuZGVyYWJsZS5tYXRlcmlhbC5faURlYWN0aXZhdGVQYXNzKGFjdGl2ZVBhc3MsIHRoaXMuX3BTdGFnZSk7XG5cblx0XHRcdHJlbmRlcmFibGUgPSByZW5kZXJhYmxlMjtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBwRHJhdyhlbnRpdHlDb2xsZWN0b3I6RW50aXR5Q29sbGVjdG9yLCB0YXJnZXQ6VGV4dHVyZVByb3h5QmFzZSlcblx0e1xuXHRcdHRoaXMucENvbGxlY3RSZW5kZXJhYmxlcyhlbnRpdHlDb2xsZWN0b3IpO1xuXG5cdFx0dGhpcy5fcENvbnRleHQuc2V0QmxlbmRGYWN0b3JzKENvbnRleHRHTEJsZW5kRmFjdG9yLk9ORSwgQ29udGV4dEdMQmxlbmRGYWN0b3IuWkVSTyk7XG5cblx0XHR0aGlzLl9wQ29udGV4dC5zZXREZXB0aFRlc3QodHJ1ZSwgQ29udGV4dEdMQ29tcGFyZU1vZGUuTEVTUyk7XG5cblx0XHR0aGlzLmRyYXdSZW5kZXJhYmxlcyh0aGlzLl9wT3BhcXVlUmVuZGVyYWJsZUhlYWQsIGVudGl0eUNvbGxlY3Rvcik7XG5cblx0XHRpZiAodGhpcy5fZGlzYWJsZUNvbG9yKVxuXHRcdFx0dGhpcy5fcENvbnRleHQuc2V0Q29sb3JNYXNrKGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlKTtcblxuXHRcdGlmICh0aGlzLl9yZW5kZXJCbGVuZGVkKVxuXHRcdFx0dGhpcy5kcmF3UmVuZGVyYWJsZXModGhpcy5fcEJsZW5kZWRSZW5kZXJhYmxlSGVhZCwgZW50aXR5Q29sbGVjdG9yKTtcblxuXHRcdGlmICh0aGlzLl9kaXNhYmxlQ29sb3IpXG5cdFx0XHR0aGlzLl9wQ29udGV4dC5zZXRDb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7XG5cdH1cblxuXHQvKipcblx0ICogRHJhdyBhIGxpc3Qgb2YgcmVuZGVyYWJsZXMuXG5cdCAqIEBwYXJhbSByZW5kZXJhYmxlcyBUaGUgcmVuZGVyYWJsZXMgdG8gZHJhdy5cblx0ICogQHBhcmFtIGVudGl0eUNvbGxlY3RvciBUaGUgRW50aXR5Q29sbGVjdG9yIGNvbnRhaW5pbmcgYWxsIHBvdGVudGlhbGx5IHZpc2libGUgaW5mb3JtYXRpb24uXG5cdCAqL1xuXHRwcml2YXRlIGRyYXdSZW5kZXJhYmxlcyhyZW5kZXJhYmxlOlJlbmRlcmFibGVCYXNlLCBlbnRpdHlDb2xsZWN0b3I6RW50aXR5Q29sbGVjdG9yKVxuXHR7XG5cdFx0dmFyIGFjdGl2ZVBhc3M6TWF0ZXJpYWxQYXNzRGF0YTtcblx0XHR2YXIgYWN0aXZlTWF0ZXJpYWw6TWF0ZXJpYWxEYXRhO1xuXHRcdHZhciBjb250ZXh0OklDb250ZXh0U3RhZ2VHTCA9IDxJQ29udGV4dFN0YWdlR0w+IHRoaXMuX3BTdGFnZS5jb250ZXh0O1xuXHRcdHZhciBjYW1lcmE6Q2FtZXJhID0gZW50aXR5Q29sbGVjdG9yLmNhbWVyYTtcblx0XHR2YXIgcmVuZGVyYWJsZTI6UmVuZGVyYWJsZUJhc2U7XG5cblx0XHR3aGlsZSAocmVuZGVyYWJsZSkge1xuXHRcdFx0YWN0aXZlTWF0ZXJpYWwgPSBjb250ZXh0LmdldE1hdGVyaWFsKHJlbmRlcmFibGUubWF0ZXJpYWwsIHRoaXMuX3BTdGFnZS5wcm9maWxlKTtcblxuXHRcdFx0Ly8gb3RoZXJ3aXNlIHRoaXMgd291bGQgcmVzdWx0IGluIGRlcHRoIHJlbmRlcmVkIGFueXdheSBiZWNhdXNlIGZyYWdtZW50IHNoYWRlciBraWwgaXMgaWdub3JlZFxuXHRcdFx0aWYgKHRoaXMuX2Rpc2FibGVDb2xvciAmJiByZW5kZXJhYmxlLm1hdGVyaWFsLmFscGhhVGhyZXNob2xkICE9IDApIHtcblx0XHRcdFx0cmVuZGVyYWJsZTIgPSByZW5kZXJhYmxlO1xuXHRcdFx0XHQvLyBmYXN0IGZvcndhcmRcblx0XHRcdFx0ZG8ge1xuXHRcdFx0XHRcdHJlbmRlcmFibGUyID0gcmVuZGVyYWJsZTIubmV4dDtcblxuXHRcdFx0XHR9IHdoaWxlIChyZW5kZXJhYmxlMiAmJiByZW5kZXJhYmxlMi5tYXRlcmlhbCA9PSByZW5kZXJhYmxlLm1hdGVyaWFsKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHJlbmRlcmFibGUyID0gcmVuZGVyYWJsZTtcblxuXHRcdFx0XHRhY3RpdmVQYXNzID0gYWN0aXZlTWF0ZXJpYWwuZ2V0TWF0ZXJpYWxQYXNzKHRoaXMuX3Bhc3MsIHRoaXMuX3BTdGFnZS5wcm9maWxlKTtcblxuXHRcdFx0XHQvL1RPRE86IGdlbmVyYWxpc2UgdGhpcyB0ZXN0XG5cdFx0XHRcdGlmIChhY3RpdmVQYXNzLmtleSA9PSBcIlwiKVxuXHRcdFx0XHRcdHRoaXMuX3BDb250ZXh0LmNhbGNBbmltYXRpb25Db2RlKHJlbmRlcmFibGUubWF0ZXJpYWwsIGFjdGl2ZVBhc3MpO1xuXG5cdFx0XHRcdHJlbmRlcmFibGUubWF0ZXJpYWwuX2lBY3RpdmF0ZVBhc3MoYWN0aXZlUGFzcywgdGhpcy5fcFN0YWdlLCBjYW1lcmEpO1xuXG5cdFx0XHRcdGRvIHtcblx0XHRcdFx0XHRyZW5kZXJhYmxlMi5tYXRlcmlhbC5faVJlbmRlclBhc3MoYWN0aXZlUGFzcywgcmVuZGVyYWJsZTIsIHRoaXMuX3BTdGFnZSwgY2FtZXJhLCB0aGlzLl9wUnR0Vmlld1Byb2plY3Rpb25NYXRyaXgpO1xuXG5cdFx0XHRcdFx0cmVuZGVyYWJsZTIgPSByZW5kZXJhYmxlMi5uZXh0O1xuXG5cdFx0XHRcdH0gd2hpbGUgKHJlbmRlcmFibGUyICYmIHJlbmRlcmFibGUyLm1hdGVyaWFsID09IHJlbmRlcmFibGUubWF0ZXJpYWwpO1xuXG5cdFx0XHRcdHJlbmRlcmFibGUubWF0ZXJpYWwuX2lEZWFjdGl2YXRlUGFzcyhhY3RpdmVQYXNzLCB0aGlzLl9wU3RhZ2UpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZW5kZXJhYmxlID0gcmVuZGVyYWJsZTI7XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCA9IERlcHRoUmVuZGVyZXI7Il19