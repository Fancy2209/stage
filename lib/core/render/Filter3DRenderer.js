var Event = require("awayjs-core/lib/events/Event");
var ContextGLBlendFactor = require("awayjs-stagegl/lib/core/stagegl/ContextGLBlendFactor");
var ContextGLVertexBufferFormat = require("awayjs-stagegl/lib/core/stagegl/ContextGLVertexBufferFormat");
var RTTBufferManager = require("awayjs-stagegl/lib/managers/RTTBufferManager");
/**
 * @class away.render.Filter3DRenderer
 */
var Filter3DRenderer = (function () {
    function Filter3DRenderer(stage) {
        var _this = this;
        this._filterSizesInvalid = true;
        this._onRTTResizeDelegate = function (event) { return _this.onRTTResize(event); };
        this._stage = stage;
        this._rttManager = RTTBufferManager.getInstance(stage);
        this._rttManager.addEventListener(Event.RESIZE, this._onRTTResizeDelegate);
    }
    Filter3DRenderer.prototype.onRTTResize = function (event) {
        this._filterSizesInvalid = true;
    };
    Object.defineProperty(Filter3DRenderer.prototype, "requireDepthRender", {
        get: function () {
            return this._requireDepthRender;
        },
        enumerable: true,
        configurable: true
    });
    Filter3DRenderer.prototype.getMainInputTexture = function (stage) {
        if (this._filterTasksInvalid) {
            this.updateFilterTasks(stage);
        }
        return this._mainInputTexture;
    };
    Object.defineProperty(Filter3DRenderer.prototype, "filters", {
        get: function () {
            return this._filters;
        },
        set: function (value) {
            this._filters = value;
            this._filterTasksInvalid = true;
            this._requireDepthRender = false;
            if (!this._filters) {
                return;
            }
            for (var i = 0; i < this._filters.length; ++i) {
                // TODO: check logic:
                // this._requireDepthRender ||=  Boolean ( this._filters[i].requireDepthRender )
                var s = this._filters[i];
                var b = (s.requireDepthRender == null) ? false : s.requireDepthRender;
                this._requireDepthRender = this._requireDepthRender || b;
            }
            this._filterSizesInvalid = true;
        },
        enumerable: true,
        configurable: true
    });
    Filter3DRenderer.prototype.updateFilterTasks = function (stage) {
        var len;
        if (this._filterSizesInvalid) {
            this.updateFilterSizes();
        }
        if (!this._filters) {
            this._tasks = null;
            return;
        }
        this._tasks = new Array();
        len = this._filters.length - 1;
        var filter;
        for (var i = 0; i <= len; ++i) {
            // make sure all internal tasks are linked together
            filter = this._filters[i];
            // TODO: check logic
            // filter.setRenderTargets(i == len? null : Filter3DBase(_filters[i + 1]).getMainInputTexture(stage), stage);
            filter.setRenderTargets(i == len ? null : this._filters[i + 1].getMainInputTexture(stage), stage);
            this._tasks = this._tasks.concat(filter.tasks);
        }
        this._mainInputTexture = this._filters[0].getMainInputTexture(stage);
    };
    Filter3DRenderer.prototype.render = function (stage, camera, depthTexture) {
        var len;
        var i;
        var task;
        var context = stage.context;
        var indexBuffer = this._rttManager.indexBuffer;
        var vertexBuffer = this._rttManager.renderToTextureVertexBuffer;
        if (!this._filters) {
            return;
        }
        if (this._filterSizesInvalid) {
            this.updateFilterSizes();
        }
        if (this._filterTasksInvalid) {
            this.updateFilterTasks(stage);
        }
        len = this._filters.length;
        for (i = 0; i < len; ++i) {
            this._filters[i].update(stage, camera);
        }
        len = this._tasks.length;
        if (len > 1) {
            context.setVertexBufferAt(0, vertexBuffer, 0, ContextGLVertexBufferFormat.FLOAT_2);
            context.setVertexBufferAt(1, vertexBuffer, 2, ContextGLVertexBufferFormat.FLOAT_2);
        }
        for (i = 0; i < len; ++i) {
            task = this._tasks[i];
            //stage.setRenderTarget(task.target); //TODO
            if (!task.target) {
                stage.scissorRect = null;
                vertexBuffer = this._rttManager.renderToScreenVertexBuffer;
                context.setVertexBufferAt(0, vertexBuffer, 0, ContextGLVertexBufferFormat.FLOAT_2);
                context.setVertexBufferAt(1, vertexBuffer, 2, ContextGLVertexBufferFormat.FLOAT_2);
            }
            context.setTextureAt(0, task.getMainInputTexture(stage));
            context.setProgram(task.getProgram(stage));
            context.clear(0.0, 0.0, 0.0, 0.0);
            task.activate(stage, camera, depthTexture);
            context.setBlendFactors(ContextGLBlendFactor.ONE, ContextGLBlendFactor.ZERO);
            context.drawTriangles(indexBuffer, 0, 2);
            task.deactivate(stage);
        }
        context.setTextureAt(0, null);
        context.setVertexBufferAt(0, null);
        context.setVertexBufferAt(1, null);
    };
    Filter3DRenderer.prototype.updateFilterSizes = function () {
        for (var i = 0; i < this._filters.length; ++i) {
            this._filters[i].textureWidth = this._rttManager.textureWidth;
            this._filters[i].textureHeight = this._rttManager.textureHeight;
        }
        this._filterSizesInvalid = true;
    };
    Filter3DRenderer.prototype.dispose = function () {
        this._rttManager.removeEventListener(Event.RESIZE, this._onRTTResizeDelegate);
        this._rttManager = null;
        this._stage = null;
    };
    return Filter3DRenderer;
})();
module.exports = Filter3DRenderer;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcmUvcmVuZGVyL2ZpbHRlcjNkcmVuZGVyZXIudHMiXSwibmFtZXMiOlsiRmlsdGVyM0RSZW5kZXJlciIsIkZpbHRlcjNEUmVuZGVyZXIuY29uc3RydWN0b3IiLCJGaWx0ZXIzRFJlbmRlcmVyLm9uUlRUUmVzaXplIiwiRmlsdGVyM0RSZW5kZXJlci5yZXF1aXJlRGVwdGhSZW5kZXIiLCJGaWx0ZXIzRFJlbmRlcmVyLmdldE1haW5JbnB1dFRleHR1cmUiLCJGaWx0ZXIzRFJlbmRlcmVyLmZpbHRlcnMiLCJGaWx0ZXIzRFJlbmRlcmVyLnVwZGF0ZUZpbHRlclRhc2tzIiwiRmlsdGVyM0RSZW5kZXJlci5yZW5kZXIiLCJGaWx0ZXIzRFJlbmRlcmVyLnVwZGF0ZUZpbHRlclNpemVzIiwiRmlsdGVyM0RSZW5kZXJlci5kaXNwb3NlIl0sIm1hcHBpbmdzIjoiQUFFQSxJQUFPLEtBQUssV0FBZ0IsOEJBQThCLENBQUMsQ0FBQztBQUU1RCxJQUFPLG9CQUFvQixXQUFhLHNEQUFzRCxDQUFDLENBQUM7QUFDaEcsSUFBTywyQkFBMkIsV0FBVyw2REFBNkQsQ0FBQyxDQUFDO0FBTzVHLElBQU8sZ0JBQWdCLFdBQWMsOENBQThDLENBQUMsQ0FBQztBQUVyRixBQUdBOztHQURHO0lBQ0csZ0JBQWdCO0lBWXJCQSxTQVpLQSxnQkFBZ0JBLENBWVRBLEtBQVdBO1FBWnhCQyxpQkEwTUNBO1FBak1RQSx3QkFBbUJBLEdBQVdBLElBQUlBLENBQUNBO1FBSzFDQSxJQUFJQSxDQUFDQSxvQkFBb0JBLEdBQUdBLFVBQUNBLEtBQVdBLElBQUtBLE9BQUFBLEtBQUlBLENBQUNBLFdBQVdBLENBQUNBLEtBQUtBLENBQUNBLEVBQXZCQSxDQUF1QkEsQ0FBQ0E7UUFFckVBLElBQUlBLENBQUNBLE1BQU1BLEdBQUdBLEtBQUtBLENBQUNBO1FBQ3BCQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxnQkFBZ0JBLENBQUNBLFdBQVdBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1FBQ3ZEQSxJ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QUFPQSxHQUFkQTtRQUVDUyxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxtQkFBbUJBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLG9CQUFvQkEsQ0FBQ0EsQ0FBQ0E7UUFDOUVBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLElBQUlBLENBQUNBO1FBQ3hCQSxJQUFJQSxDQUFDQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQTtJQUNwQkEsQ0FBQ0E7SUFDRlQsdUJBQUNBO0FBQURBLENBMU1BLEFBME1DQSxJQUFBO0FBRUQsQUFBMEIsaUJBQWpCLGdCQUFnQixDQUFDIiwiZmlsZSI6ImNvcmUvcmVuZGVyL0ZpbHRlcjNEUmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL3JvYmJhdGVtYW4vV2Vic3Rvcm1Qcm9qZWN0cy9hd2F5anMtc3RhZ2VnbC8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU3RhZ2VcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvY29yZS9iYXNlL1N0YWdlXCIpO1xuaW1wb3J0IENhbWVyYVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9lbnRpdGllcy9DYW1lcmFcIik7XG5pbXBvcnQgRXZlbnRcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZXZlbnRzL0V2ZW50XCIpO1xuXG5pbXBvcnQgQ29udGV4dEdMQmxlbmRGYWN0b3JcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvY29yZS9zdGFnZWdsL0NvbnRleHRHTEJsZW5kRmFjdG9yXCIpO1xuaW1wb3J0IENvbnRleHRHTFZlcnRleEJ1ZmZlckZvcm1hdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2NvcmUvc3RhZ2VnbC9Db250ZXh0R0xWZXJ0ZXhCdWZmZXJGb3JtYXRcIik7XG5pbXBvcnQgSUNvbnRleHRTdGFnZUdMXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvY29yZS9zdGFnZWdsL0lDb250ZXh0U3RhZ2VHTFwiKTtcbmltcG9ydCBJSW5kZXhCdWZmZXJcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2NvcmUvc3RhZ2VnbC9JSW5kZXhCdWZmZXJcIik7XG5pbXBvcnQgSVRleHR1cmVcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvY29yZS9zdGFnZWdsL0lUZXh0dXJlXCIpO1xuaW1wb3J0IElWZXJ0ZXhCdWZmZXJcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9jb3JlL3N0YWdlZ2wvSVZlcnRleEJ1ZmZlclwiKTtcbmltcG9ydCBGaWx0ZXIzREJhc2VcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2ZpbHRlcnMvRmlsdGVyM0RCYXNlXCIpO1xuaW1wb3J0IEZpbHRlcjNEVGFza0Jhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9maWx0ZXJzL3Rhc2tzL0ZpbHRlcjNEVGFza0Jhc2VcIik7XG5pbXBvcnQgUlRUQnVmZmVyTWFuYWdlclx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL21hbmFnZXJzL1JUVEJ1ZmZlck1hbmFnZXJcIik7XG5cbi8qKlxuICogQGNsYXNzIGF3YXkucmVuZGVyLkZpbHRlcjNEUmVuZGVyZXJcbiAqL1xuY2xhc3MgRmlsdGVyM0RSZW5kZXJlclxue1xuXHRwcml2YXRlIF9maWx0ZXJzOkFycmF5PEZpbHRlcjNEQmFzZT47XG5cdHByaXZhdGUgX3Rhc2tzOkFycmF5PEZpbHRlcjNEVGFza0Jhc2U+O1xuXHRwcml2YXRlIF9maWx0ZXJUYXNrc0ludmFsaWQ6Ym9vbGVhbjtcblx0cHJpdmF0ZSBfbWFpbklucHV0VGV4dHVyZTpJVGV4dHVyZTtcblx0cHJpdmF0ZSBfcmVxdWlyZURlcHRoUmVuZGVyOmJvb2xlYW47XG5cdHByaXZhdGUgX3J0dE1hbmFnZXI6UlRUQnVmZmVyTWFuYWdlcjtcblx0cHJpdmF0ZSBfc3RhZ2U6U3RhZ2U7XG5cdHByaXZhdGUgX2ZpbHRlclNpemVzSW52YWxpZDpib29sZWFuID0gdHJ1ZTtcblx0cHJpdmF0ZSBfb25SVFRSZXNpemVEZWxlZ2F0ZTooZXZlbnQ6RXZlbnQpID0+IHZvaWQ7XG5cblx0Y29uc3RydWN0b3Ioc3RhZ2U6U3RhZ2UpXG5cdHtcblx0XHR0aGlzLl9vblJUVFJlc2l6ZURlbGVnYXRlID0gKGV2ZW50OkV2ZW50KSA9PiB0aGlzLm9uUlRUUmVzaXplKGV2ZW50KTtcblxuXHRcdHRoaXMuX3N0YWdlID0gc3RhZ2U7XG5cdFx0dGhpcy5fcnR0TWFuYWdlciA9IFJUVEJ1ZmZlck1hbmFnZXIuZ2V0SW5zdGFuY2Uoc3RhZ2UpO1xuXHRcdHRoaXMuX3J0dE1hbmFnZXIuYWRkRXZlbnRMaXN0ZW5lcihFdmVudC5SRVNJWkUsIHRoaXMuX29uUlRUUmVzaXplRGVsZWdhdGUpO1xuXG5cdH1cblxuXHRwcml2YXRlIG9uUlRUUmVzaXplKGV2ZW50OkV2ZW50KVxuXHR7XG5cdFx0dGhpcy5fZmlsdGVyU2l6ZXNJbnZhbGlkID0gdHJ1ZTtcblx0fVxuXG5cdHB1YmxpYyBnZXQgcmVxdWlyZURlcHRoUmVuZGVyKCk6Ym9vbGVhblxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX3JlcXVpcmVEZXB0aFJlbmRlcjtcblx0fVxuXG5cdHB1YmxpYyBnZXRNYWluSW5wdXRUZXh0dXJlKHN0YWdlOlN0YWdlKTpJVGV4dHVyZVxuXHR7XG5cdFx0aWYgKHRoaXMuX2ZpbHRlclRhc2tzSW52YWxpZCkge1xuXG5cdFx0XHR0aGlzLnVwZGF0ZUZpbHRlclRhc2tzKHN0YWdlKTtcblxuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLl9tYWluSW5wdXRUZXh0dXJlO1xuXHR9XG5cblx0cHVibGljIGdldCBmaWx0ZXJzKCk6RmlsdGVyM0RCYXNlW11cblx0e1xuXHRcdHJldHVybiB0aGlzLl9maWx0ZXJzO1xuXHR9XG5cblx0cHVibGljIHNldCBmaWx0ZXJzKHZhbHVlOkZpbHRlcjNEQmFzZVtdKVxuXHR7XG5cdFx0dGhpcy5fZmlsdGVycyA9IHZhbHVlO1xuXG5cdFx0dGhpcy5fZmlsdGVyVGFza3NJbnZhbGlkID0gdHJ1ZTtcblxuXHRcdHRoaXMuX3JlcXVpcmVEZXB0aFJlbmRlciA9IGZhbHNlO1xuXG5cdFx0aWYgKCF0aGlzLl9maWx0ZXJzKSB7XG5cblx0XHRcdHJldHVybjtcblxuXHRcdH1cblxuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8IHRoaXMuX2ZpbHRlcnMubGVuZ3RoOyArK2kpIHtcblxuXHRcdFx0Ly8gVE9ETzogY2hlY2sgbG9naWM6XG5cdFx0XHQvLyB0aGlzLl9yZXF1aXJlRGVwdGhSZW5kZXIgfHw9ICBCb29sZWFuICggdGhpcy5fZmlsdGVyc1tpXS5yZXF1aXJlRGVwdGhSZW5kZXIgKVxuXG5cdFx0XHR2YXIgczphbnkgPSB0aGlzLl9maWx0ZXJzW2ldO1xuXHRcdFx0dmFyIGI6Ym9vbGVhbiA9IDxib29sZWFuPiAoIHMucmVxdWlyZURlcHRoUmVuZGVyID09IG51bGwgKT8gZmFsc2UgOiBzLnJlcXVpcmVEZXB0aFJlbmRlcjtcblxuXHRcdFx0dGhpcy5fcmVxdWlyZURlcHRoUmVuZGVyID0gdGhpcy5fcmVxdWlyZURlcHRoUmVuZGVyIHx8IGI7XG5cblx0XHR9XG5cblx0XHR0aGlzLl9maWx0ZXJTaXplc0ludmFsaWQgPSB0cnVlO1xuXG5cdH1cblxuXHRwcml2YXRlIHVwZGF0ZUZpbHRlclRhc2tzKHN0YWdlOlN0YWdlKVxuXHR7XG5cdFx0dmFyIGxlbjpudW1iZXI7XG5cblx0XHRpZiAodGhpcy5fZmlsdGVyU2l6ZXNJbnZhbGlkKSB7XG5cblx0XHRcdHRoaXMudXBkYXRlRmlsdGVyU2l6ZXMoKTtcblxuXHRcdH1cblxuXHRcdGlmICghdGhpcy5fZmlsdGVycykge1xuXHRcdFx0dGhpcy5fdGFza3MgPSBudWxsO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdHRoaXMuX3Rhc2tzID0gbmV3IEFycmF5PEZpbHRlcjNEVGFza0Jhc2U+KCk7XG5cblx0XHRsZW4gPSB0aGlzLl9maWx0ZXJzLmxlbmd0aCAtIDE7XG5cblx0XHR2YXIgZmlsdGVyOkZpbHRlcjNEQmFzZTtcblxuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8PSBsZW47ICsraSkge1xuXG5cdFx0XHQvLyBtYWtlIHN1cmUgYWxsIGludGVybmFsIHRhc2tzIGFyZSBsaW5rZWQgdG9nZXRoZXJcblx0XHRcdGZpbHRlciA9IHRoaXMuX2ZpbHRlcnNbaV07XG5cblx0XHRcdC8vIFRPRE86IGNoZWNrIGxvZ2ljXG5cdFx0XHQvLyBmaWx0ZXIuc2V0UmVuZGVyVGFyZ2V0cyhpID09IGxlbj8gbnVsbCA6IEZpbHRlcjNEQmFzZShfZmlsdGVyc1tpICsgMV0pLmdldE1haW5JbnB1dFRleHR1cmUoc3RhZ2UpLCBzdGFnZSk7XG5cblx0XHRcdGZpbHRlci5zZXRSZW5kZXJUYXJnZXRzKGkgPT0gbGVuPyBudWxsIDogdGhpcy5fZmlsdGVyc1tpICsgMV0uZ2V0TWFpbklucHV0VGV4dHVyZShzdGFnZSksIHN0YWdlKTtcblxuXHRcdFx0dGhpcy5fdGFza3MgPSB0aGlzLl90YXNrcy5jb25jYXQoZmlsdGVyLnRhc2tzKTtcblxuXHRcdH1cblxuXHRcdHRoaXMuX21haW5JbnB1dFRleHR1cmUgPSB0aGlzLl9maWx0ZXJzWzBdLmdldE1haW5JbnB1dFRleHR1cmUoc3RhZ2UpO1xuXG5cdH1cblxuXHRwdWJsaWMgcmVuZGVyKHN0YWdlOlN0YWdlLCBjYW1lcmE6Q2FtZXJhLCBkZXB0aFRleHR1cmU6SVRleHR1cmUpXG5cdHtcblx0XHR2YXIgbGVuOm51bWJlcjtcblx0XHR2YXIgaTpudW1iZXI7XG5cdFx0dmFyIHRhc2s6RmlsdGVyM0RUYXNrQmFzZTtcblx0XHR2YXIgY29udGV4dDpJQ29udGV4dFN0YWdlR0wgPSA8SUNvbnRleHRTdGFnZUdMPiBzdGFnZS5jb250ZXh0O1xuXG5cdFx0dmFyIGluZGV4QnVmZmVyOklJbmRleEJ1ZmZlciA9IHRoaXMuX3J0dE1hbmFnZXIuaW5kZXhCdWZmZXI7XG5cblx0XHR2YXIgdmVydGV4QnVmZmVyOklWZXJ0ZXhCdWZmZXIgPSB0aGlzLl9ydHRNYW5hZ2VyLnJlbmRlclRvVGV4dHVyZVZlcnRleEJ1ZmZlcjtcblxuXHRcdGlmICghdGhpcy5fZmlsdGVycykge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdGlmICh0aGlzLl9maWx0ZXJTaXplc0ludmFsaWQpIHtcblx0XHRcdHRoaXMudXBkYXRlRmlsdGVyU2l6ZXMoKTtcblx0XHR9XG5cblx0XHRpZiAodGhpcy5fZmlsdGVyVGFza3NJbnZhbGlkKSB7XG5cdFx0XHR0aGlzLnVwZGF0ZUZpbHRlclRhc2tzKHN0YWdlKTtcblx0XHR9XG5cblx0XHRsZW4gPSB0aGlzLl9maWx0ZXJzLmxlbmd0aDtcblxuXHRcdGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkge1xuXHRcdFx0dGhpcy5fZmlsdGVyc1tpXS51cGRhdGUoc3RhZ2UsIGNhbWVyYSk7XG5cdFx0fVxuXG5cdFx0bGVuID0gdGhpcy5fdGFza3MubGVuZ3RoO1xuXG5cdFx0aWYgKGxlbiA+IDEpIHtcblx0XHRcdGNvbnRleHQuc2V0VmVydGV4QnVmZmVyQXQoMCwgdmVydGV4QnVmZmVyLCAwLCBDb250ZXh0R0xWZXJ0ZXhCdWZmZXJGb3JtYXQuRkxPQVRfMik7XG5cdFx0XHRjb250ZXh0LnNldFZlcnRleEJ1ZmZlckF0KDEsIHZlcnRleEJ1ZmZlciwgMiwgQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0LkZMT0FUXzIpO1xuXHRcdH1cblxuXHRcdGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkge1xuXG5cdFx0XHR0YXNrID0gdGhpcy5fdGFza3NbaV07XG5cblx0XHRcdC8vc3RhZ2Uuc2V0UmVuZGVyVGFyZ2V0KHRhc2sudGFyZ2V0KTsgLy9UT0RPXG5cblx0XHRcdGlmICghdGFzay50YXJnZXQpIHtcblxuXHRcdFx0XHRzdGFnZS5zY2lzc29yUmVjdCA9IG51bGw7XG5cdFx0XHRcdHZlcnRleEJ1ZmZlciA9IHRoaXMuX3J0dE1hbmFnZXIucmVuZGVyVG9TY3JlZW5WZXJ0ZXhCdWZmZXI7XG5cdFx0XHRcdGNvbnRleHQuc2V0VmVydGV4QnVmZmVyQXQoMCwgdmVydGV4QnVmZmVyLCAwLCBDb250ZXh0R0xWZXJ0ZXhCdWZmZXJGb3JtYXQuRkxPQVRfMik7XG5cdFx0XHRcdGNvbnRleHQuc2V0VmVydGV4QnVmZmVyQXQoMSwgdmVydGV4QnVmZmVyLCAyLCBDb250ZXh0R0xWZXJ0ZXhCdWZmZXJGb3JtYXQuRkxPQVRfMik7XG5cblx0XHRcdH1cblxuXHRcdFx0Y29udGV4dC5zZXRUZXh0dXJlQXQoMCwgdGFzay5nZXRNYWluSW5wdXRUZXh0dXJlKHN0YWdlKSk7XG5cdFx0XHRjb250ZXh0LnNldFByb2dyYW0odGFzay5nZXRQcm9ncmFtKHN0YWdlKSk7XG5cdFx0XHRjb250ZXh0LmNsZWFyKDAuMCwgMC4wLCAwLjAsIDAuMCk7XG5cblx0XHRcdHRhc2suYWN0aXZhdGUoc3RhZ2UsIGNhbWVyYSwgZGVwdGhUZXh0dXJlKTtcblxuXHRcdFx0Y29udGV4dC5zZXRCbGVuZEZhY3RvcnMoQ29udGV4dEdMQmxlbmRGYWN0b3IuT05FLCBDb250ZXh0R0xCbGVuZEZhY3Rvci5aRVJPKTtcblx0XHRcdGNvbnRleHQuZHJhd1RyaWFuZ2xlcyhpbmRleEJ1ZmZlciwgMCwgMik7XG5cblx0XHRcdHRhc2suZGVhY3RpdmF0ZShzdGFnZSk7XG5cdFx0fVxuXG5cdFx0Y29udGV4dC5zZXRUZXh0dXJlQXQoMCwgbnVsbCk7XG5cdFx0Y29udGV4dC5zZXRWZXJ0ZXhCdWZmZXJBdCgwLCBudWxsKTtcblx0XHRjb250ZXh0LnNldFZlcnRleEJ1ZmZlckF0KDEsIG51bGwpO1xuXHR9XG5cblx0cHJpdmF0ZSB1cGRhdGVGaWx0ZXJTaXplcygpXG5cdHtcblx0XHRmb3IgKHZhciBpOm51bWJlciA9IDA7IGkgPCB0aGlzLl9maWx0ZXJzLmxlbmd0aDsgKytpKSB7XG5cdFx0XHR0aGlzLl9maWx0ZXJzW2ldLnRleHR1cmVXaWR0aCA9IHRoaXMuX3J0dE1hbmFnZXIudGV4dHVyZVdpZHRoO1xuXHRcdFx0dGhpcy5fZmlsdGVyc1tpXS50ZXh0dXJlSGVpZ2h0ID0gdGhpcy5fcnR0TWFuYWdlci50ZXh0dXJlSGVpZ2h0O1xuXHRcdH1cblxuXHRcdHRoaXMuX2ZpbHRlclNpemVzSW52YWxpZCA9IHRydWU7XG5cblx0fVxuXG5cdHB1YmxpYyBkaXNwb3NlKClcblx0e1xuXHRcdHRoaXMuX3J0dE1hbmFnZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcihFdmVudC5SRVNJWkUsIHRoaXMuX29uUlRUUmVzaXplRGVsZWdhdGUpO1xuXHRcdHRoaXMuX3J0dE1hbmFnZXIgPSBudWxsO1xuXHRcdHRoaXMuX3N0YWdlID0gbnVsbDtcblx0fVxufVxuXG5leHBvcnQgPSBGaWx0ZXIzRFJlbmRlcmVyOyJdfQ==