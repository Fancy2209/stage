var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Rectangle = require("awayjs-core/lib/geom/Rectangle");
var Event = require("awayjs-core/lib/events/Event");
var EventDispatcher = require("awayjs-core/lib/events/EventDispatcher");
var TextureUtils = require("awayjs-core/lib/utils/TextureUtils");
var RTTBufferManager = (function (_super) {
    __extends(RTTBufferManager, _super);
    function RTTBufferManager(stage) {
        _super.call(this);
        this._viewWidth = -1;
        this._viewHeight = -1;
        this._textureWidth = -1;
        this._textureHeight = -1;
        this._buffersInvalid = true;
        this._renderToTextureRect = new Rectangle();
        this._stage = stage;
    }
    RTTBufferManager.getInstance = function (stage) {
        if (!stage)
            throw new Error("stage key cannot be null!");
        if (RTTBufferManager._instances == null)
            RTTBufferManager._instances = new Array();
        var rttBufferManager = RTTBufferManager.getRTTBufferManagerFromStage(stage);
        if (rttBufferManager == null) {
            rttBufferManager = new RTTBufferManager(stage);
            var vo = new RTTBufferManagerVO();
            vo.stage3d = stage;
            vo.rttbfm = rttBufferManager;
            RTTBufferManager._instances.push(vo);
        }
        return rttBufferManager;
    };
    RTTBufferManager.getRTTBufferManagerFromStage = function (stage) {
        var l = RTTBufferManager._instances.length;
        var r;
        for (var c = 0; c < l; c++) {
            r = RTTBufferManager._instances[c];
            if (r.stage3d === stage)
                return r.rttbfm;
        }
        return null;
    };
    RTTBufferManager.deleteRTTBufferManager = function (stage) {
        var l = RTTBufferManager._instances.length;
        var r;
        for (var c = 0; c < l; c++) {
            r = RTTBufferManager._instances[c];
            if (r.stage3d === stage) {
                RTTBufferManager._instances.splice(c, 1);
                return;
            }
        }
    };
    Object.defineProperty(RTTBufferManager.prototype, "textureRatioX", {
        get: function () {
            if (this._buffersInvalid)
                this.updateRTTBuffers();
            return this._textureRatioX;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "textureRatioY", {
        get: function () {
            if (this._buffersInvalid)
                this.updateRTTBuffers();
            return this._textureRatioY;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "viewWidth", {
        get: function () {
            return this._viewWidth;
        },
        set: function (value) {
            if (value == this._viewWidth)
                return;
            this._viewWidth = value;
            this._buffersInvalid = true;
            this._textureWidth = TextureUtils.getBestPowerOf2(this._viewWidth);
            if (this._textureWidth > this._viewWidth) {
                this._renderToTextureRect.x = Math.floor((this._textureWidth - this._viewWidth) * .5);
                this._renderToTextureRect.width = this._viewWidth;
            }
            else {
                this._renderToTextureRect.x = 0;
                this._renderToTextureRect.width = this._textureWidth;
            }
            this.dispatchEvent(new Event(Event.RESIZE));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "viewHeight", {
        get: function () {
            return this._viewHeight;
        },
        set: function (value) {
            if (value == this._viewHeight)
                return;
            this._viewHeight = value;
            this._buffersInvalid = true;
            this._textureHeight = TextureUtils.getBestPowerOf2(this._viewHeight);
            if (this._textureHeight > this._viewHeight) {
                this._renderToTextureRect.y = Math.floor((this._textureHeight - this._viewHeight) * .5);
                this._renderToTextureRect.height = this._viewHeight;
            }
            else {
                this._renderToTextureRect.y = 0;
                this._renderToTextureRect.height = this._textureHeight;
            }
            this.dispatchEvent(new Event(Event.RESIZE));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "renderToTextureVertexBuffer", {
        get: function () {
            if (this._buffersInvalid)
                this.updateRTTBuffers();
            return this._renderToTextureVertexBuffer;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "renderToScreenVertexBuffer", {
        get: function () {
            if (this._buffersInvalid)
                this.updateRTTBuffers();
            return this._renderToScreenVertexBuffer;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "indexBuffer", {
        get: function () {
            return this._indexBuffer;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "renderToTextureRect", {
        get: function () {
            if (this._buffersInvalid)
                this.updateRTTBuffers();
            return this._renderToTextureRect;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "textureWidth", {
        get: function () {
            return this._textureWidth;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "textureHeight", {
        get: function () {
            return this._textureHeight;
        },
        enumerable: true,
        configurable: true
    });
    RTTBufferManager.prototype.dispose = function () {
        RTTBufferManager.deleteRTTBufferManager(this._stage);
        if (this._indexBuffer) {
            this._indexBuffer.dispose();
            this._renderToScreenVertexBuffer.dispose();
            this._renderToTextureVertexBuffer.dispose();
            this._renderToScreenVertexBuffer = null;
            this._renderToTextureVertexBuffer = null;
            this._indexBuffer = null;
        }
    };
    // todo: place all this in a separate model, since it's used all over the place
    // maybe it even has a place in the core (together with screenRect etc)?
    // needs to be stored per view of course
    RTTBufferManager.prototype.updateRTTBuffers = function () {
        var context = this._stage.context;
        var textureVerts;
        var screenVerts;
        var x;
        var y;
        if (this._renderToTextureVertexBuffer == null)
            this._renderToTextureVertexBuffer = context.createVertexBuffer(4, 5);
        if (this._renderToScreenVertexBuffer == null)
            this._renderToScreenVertexBuffer = context.createVertexBuffer(4, 5);
        if (!this._indexBuffer) {
            this._indexBuffer = context.createIndexBuffer(6);
            this._indexBuffer.uploadFromArray([2, 1, 0, 3, 2, 0], 0, 6);
        }
        this._textureRatioX = x = Math.min(this._viewWidth / this._textureWidth, 1);
        this._textureRatioY = y = Math.min(this._viewHeight / this._textureHeight, 1);
        var u1 = (1 - x) * .5;
        var u2 = (x + 1) * .5;
        var v1 = (y + 1) * .5;
        var v2 = (1 - y) * .5;
        // last element contains indices for data per vertex that can be passed to the vertex shader if necessary (ie: frustum corners for deferred rendering)
        textureVerts = [-x, -y, u1, v1, 0, x, -y, u2, v1, 1, x, y, u2, v2, 2, -x, y, u1, v2, 3];
        screenVerts = [-1, -1, u1, v1, 0, 1, -1, u2, v1, 1, 1, 1, u2, v2, 2, -1, 1, u1, v2, 3];
        this._renderToTextureVertexBuffer.uploadFromArray(textureVerts, 0, 4);
        this._renderToScreenVertexBuffer.uploadFromArray(screenVerts, 0, 4);
        this._buffersInvalid = false;
    };
    return RTTBufferManager;
})(EventDispatcher);
var RTTBufferManagerVO = (function () {
    function RTTBufferManagerVO() {
    }
    return RTTBufferManagerVO;
})();
module.exports = RTTBufferManager;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1zdGFnZWdsL2xpYi9tYW5hZ2Vycy9ydHRidWZmZXJtYW5hZ2VyLnRzIl0sIm5hbWVzIjpbIlJUVEJ1ZmZlck1hbmFnZXIiLCJSVFRCdWZmZXJNYW5hZ2VyLmNvbnN0cnVjdG9yIiwiUlRUQnVmZmVyTWFuYWdlci5nZXRJbnN0YW5jZSIsIlJUVEJ1ZmZlck1hbmFnZXIuZ2V0UlRUQnVmZmVyTWFuYWdlckZyb21TdGFnZSIsIlJUVEJ1ZmZlck1hbmFnZXIuZGVsZXRlUlRUQnVmZmVyTWFuYWdlciIsIlJUVEJ1ZmZlck1hbmFnZXIudGV4dHVyZVJhdGlvWCIsIlJUVEJ1ZmZlck1hbmFnZXIudGV4dHVyZVJhdGlvWSIsIlJUVEJ1ZmZlck1hbmFnZXIudmlld1dpZHRoIiwiUlRUQnVmZmVyTWFuYWdlci52aWV3SGVpZ2h0IiwiUlRUQnVmZmVyTWFuYWdlci5yZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXIiLCJSVFRCdWZmZXJNYW5hZ2VyLnJlbmRlclRvU2NyZWVuVmVydGV4QnVmZmVyIiwiUlRUQnVmZmVyTWFuYWdlci5pbmRleEJ1ZmZlciIsIlJUVEJ1ZmZlck1hbmFnZXIucmVuZGVyVG9UZXh0dXJlUmVjdCIsIlJUVEJ1ZmZlck1hbmFnZXIudGV4dHVyZVdpZHRoIiwiUlRUQnVmZmVyTWFuYWdlci50ZXh0dXJlSGVpZ2h0IiwiUlRUQnVmZmVyTWFuYWdlci5kaXNwb3NlIiwiUlRUQnVmZmVyTWFuYWdlci51cGRhdGVSVFRCdWZmZXJzIiwiUlRUQnVmZmVyTWFuYWdlclZPIiwiUlRUQnVmZmVyTWFuYWdlclZPLmNvbnN0cnVjdG9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFPLFNBQVMsV0FBZSxnQ0FBZ0MsQ0FBQyxDQUFDO0FBQ2pFLElBQU8sS0FBSyxXQUFnQiw4QkFBOEIsQ0FBQyxDQUFDO0FBQzVELElBQU8sZUFBZSxXQUFjLHdDQUF3QyxDQUFDLENBQUM7QUFDOUUsSUFBTyxZQUFZLFdBQWUsb0NBQW9DLENBQUMsQ0FBQztBQU94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QUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBQzdEQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxjQUFjQSxHQUFHQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFDQSxJQUFJQSxDQUFDQSxhQUFhQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUMxRUEsSUFBSUEsQ0FBQ0EsY0FBY0EsR0FBR0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBQ0EsSUFBSUEsQ0FBQ0EsY0FBY0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFNUVBLElBQUlBLEVBQUVBLEdBQVVBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUNBLEVBQUVBLENBQUNBO1FBQzNCQSxJQUFJQSxFQUFFQSxHQUFVQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFDQSxFQUFFQSxDQUFDQTtRQUMzQkEsSUFBSUEsRUFBRUEsR0FBVUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsRUFBRUEsQ0FBQ0E7UUFDM0JBLElBQUlBLEVBQUVBLEdBQVVBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUNBLEVBQUVBLENBQUNBO1FBRTNCQSxBQUNBQSxzSkFEc0pBO1FBQ3RKQSxZQUFZQSxHQUFHQSxDQUFLQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxDQUFDQSxDQUFFQSxDQUFDQTtRQUU3RkEsV0FBV0EsR0FBR0EsQ0FBTUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsRUFBRUEsRUFBRUEsRUFBRUEsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsRUFBRUEsRUFBRUEsRUFBRUEsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsRUFBRUEsRUFBRUEsRUFBRUEsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsRUFBRUEsRUFBRUEsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBRUEsQ0FBQ0E7UUFFN0ZBLElBQUlBLENBQUNBLDRCQUE0QkEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsWUFBWUEsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDdEVBLElBQUlBLENBQUNBLDJCQUEyQkEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsV0FBV0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFcEVBLElBQUlBLENBQUNBLGVBQWVBLEdBQUdBLEtBQUtBLENBQUNBO0lBQzlCQSxDQUFDQTtJQUNGaEIsdUJBQUNBO0FBQURBLENBM1BBLEFBMlBDQSxFQTNQOEIsZUFBZSxFQTJQN0M7QUFJRCxJQUFNLGtCQUFrQjtJQUF4QmlCLFNBQU1BLGtCQUFrQkE7SUFLeEJDLENBQUNBO0lBQURELHlCQUFDQTtBQUFEQSxDQUxBLEFBS0NBLElBQUE7QUFQRCxpQkFBUyxnQkFBZ0IsQ0FBQyIsImZpbGUiOiJtYW5hZ2Vycy9SVFRCdWZmZXJNYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Ii4uLyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWN0YW5nbGVcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2dlb20vUmVjdGFuZ2xlXCIpO1xuaW1wb3J0IEV2ZW50XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2V2ZW50cy9FdmVudFwiKTtcbmltcG9ydCBFdmVudERpc3BhdGNoZXJcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9ldmVudHMvRXZlbnREaXNwYXRjaGVyXCIpO1xuaW1wb3J0IFRleHR1cmVVdGlsc1x0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdXRpbHMvVGV4dHVyZVV0aWxzXCIpO1xuXG5pbXBvcnQgU3RhZ2VcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvY29yZS9iYXNlL1N0YWdlXCIpO1xuaW1wb3J0IENvbnRleHRHTEJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9jb3JlL3N0YWdlZ2wvQ29udGV4dEdMQmFzZVwiKTtcbmltcG9ydCBJSW5kZXhCdWZmZXJcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2NvcmUvc3RhZ2VnbC9JSW5kZXhCdWZmZXJcIik7XG5pbXBvcnQgSVZlcnRleEJ1ZmZlclx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2NvcmUvc3RhZ2VnbC9JVmVydGV4QnVmZmVyXCIpO1xuXG5jbGFzcyBSVFRCdWZmZXJNYW5hZ2VyIGV4dGVuZHMgRXZlbnREaXNwYXRjaGVyXG57XG5cdHByaXZhdGUgc3RhdGljIF9pbnN0YW5jZXM6QXJyYXk8UlRUQnVmZmVyTWFuYWdlclZPPjtcblxuXHRwcml2YXRlIF9yZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXI6SVZlcnRleEJ1ZmZlcjtcblx0cHJpdmF0ZSBfcmVuZGVyVG9TY3JlZW5WZXJ0ZXhCdWZmZXI6SVZlcnRleEJ1ZmZlcjtcblxuXHRwcml2YXRlIF9pbmRleEJ1ZmZlcjpJSW5kZXhCdWZmZXI7XG5cdHByaXZhdGUgX3N0YWdlOlN0YWdlO1xuXHRwcml2YXRlIF92aWV3V2lkdGg6bnVtYmVyID0gLTE7XG5cdHByaXZhdGUgX3ZpZXdIZWlnaHQ6bnVtYmVyID0gLTE7XG5cdHByaXZhdGUgX3RleHR1cmVXaWR0aDpudW1iZXIgPSAtMTtcblx0cHJpdmF0ZSBfdGV4dHVyZUhlaWdodDpudW1iZXIgPSAtMTtcblx0cHJpdmF0ZSBfcmVuZGVyVG9UZXh0dXJlUmVjdDpSZWN0YW5nbGU7XG5cdHByaXZhdGUgX2J1ZmZlcnNJbnZhbGlkOmJvb2xlYW4gPSB0cnVlO1xuXG5cdHByaXZhdGUgX3RleHR1cmVSYXRpb1g6bnVtYmVyO1xuXHRwcml2YXRlIF90ZXh0dXJlUmF0aW9ZOm51bWJlcjtcblxuXHRjb25zdHJ1Y3RvcihzdGFnZTpTdGFnZSlcblx0e1xuXHRcdHN1cGVyKCk7XG5cblx0XHR0aGlzLl9yZW5kZXJUb1RleHR1cmVSZWN0ID0gbmV3IFJlY3RhbmdsZSgpO1xuXG5cdFx0dGhpcy5fc3RhZ2UgPSBzdGFnZTtcblxuXHR9XG5cblx0cHVibGljIHN0YXRpYyBnZXRJbnN0YW5jZShzdGFnZTpTdGFnZSk6UlRUQnVmZmVyTWFuYWdlclxuXHR7XG5cdFx0aWYgKCFzdGFnZSlcblx0XHRcdHRocm93IG5ldyBFcnJvcihcInN0YWdlIGtleSBjYW5ub3QgYmUgbnVsbCFcIik7XG5cblx0XHRpZiAoUlRUQnVmZmVyTWFuYWdlci5faW5zdGFuY2VzID09IG51bGwpXG5cdFx0XHRSVFRCdWZmZXJNYW5hZ2VyLl9pbnN0YW5jZXMgPSBuZXcgQXJyYXk8UlRUQnVmZmVyTWFuYWdlclZPPigpO1xuXG5cdFx0dmFyIHJ0dEJ1ZmZlck1hbmFnZXI6UlRUQnVmZmVyTWFuYWdlciA9IFJUVEJ1ZmZlck1hbmFnZXIuZ2V0UlRUQnVmZmVyTWFuYWdlckZyb21TdGFnZShzdGFnZSk7XG5cblx0XHRpZiAocnR0QnVmZmVyTWFuYWdlciA9PSBudWxsKSB7XG5cdFx0XHRydHRCdWZmZXJNYW5hZ2VyID0gbmV3IFJUVEJ1ZmZlck1hbmFnZXIoc3RhZ2UpO1xuXG5cdFx0XHR2YXIgdm86UlRUQnVmZmVyTWFuYWdlclZPID0gbmV3IFJUVEJ1ZmZlck1hbmFnZXJWTygpO1xuXG5cdFx0XHR2by5zdGFnZTNkID0gc3RhZ2U7XG5cdFx0XHR2by5ydHRiZm0gPSBydHRCdWZmZXJNYW5hZ2VyO1xuXG5cdFx0XHRSVFRCdWZmZXJNYW5hZ2VyLl9pbnN0YW5jZXMucHVzaCh2byk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHJ0dEJ1ZmZlck1hbmFnZXI7XG5cblx0fVxuXG5cdHByaXZhdGUgc3RhdGljIGdldFJUVEJ1ZmZlck1hbmFnZXJGcm9tU3RhZ2Uoc3RhZ2U6U3RhZ2UpOlJUVEJ1ZmZlck1hbmFnZXJcblx0e1xuXG5cdFx0dmFyIGw6bnVtYmVyID0gUlRUQnVmZmVyTWFuYWdlci5faW5zdGFuY2VzLmxlbmd0aDtcblx0XHR2YXIgcjpSVFRCdWZmZXJNYW5hZ2VyVk87XG5cblx0XHRmb3IgKHZhciBjOm51bWJlciA9IDA7IGMgPCBsOyBjKyspIHtcblx0XHRcdHIgPSBSVFRCdWZmZXJNYW5hZ2VyLl9pbnN0YW5jZXNbIGMgXTtcblxuXHRcdFx0aWYgKHIuc3RhZ2UzZCA9PT0gc3RhZ2UpXG5cdFx0XHRcdHJldHVybiByLnJ0dGJmbTtcblx0XHR9XG5cblx0XHRyZXR1cm4gbnVsbDtcblx0fVxuXG5cdHByaXZhdGUgc3RhdGljIGRlbGV0ZVJUVEJ1ZmZlck1hbmFnZXIoc3RhZ2U6U3RhZ2UpOnZvaWRcblx0e1xuXHRcdHZhciBsOm51bWJlciA9IFJUVEJ1ZmZlck1hbmFnZXIuX2luc3RhbmNlcy5sZW5ndGg7XG5cdFx0dmFyIHI6UlRUQnVmZmVyTWFuYWdlclZPO1xuXG5cdFx0Zm9yICh2YXIgYzpudW1iZXIgPSAwOyBjIDwgbDsgYysrKSB7XG5cdFx0XHRyID0gUlRUQnVmZmVyTWFuYWdlci5faW5zdGFuY2VzWyBjIF07XG5cblx0XHRcdGlmIChyLnN0YWdlM2QgPT09IHN0YWdlKSB7XG5cdFx0XHRcdFJUVEJ1ZmZlck1hbmFnZXIuX2luc3RhbmNlcy5zcGxpY2UoYywgMSk7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgZ2V0IHRleHR1cmVSYXRpb1goKTpudW1iZXJcblx0e1xuXHRcdGlmICh0aGlzLl9idWZmZXJzSW52YWxpZClcblx0XHRcdHRoaXMudXBkYXRlUlRUQnVmZmVycygpO1xuXG5cdFx0cmV0dXJuIHRoaXMuX3RleHR1cmVSYXRpb1g7XG5cdH1cblxuXHRwdWJsaWMgZ2V0IHRleHR1cmVSYXRpb1koKTpudW1iZXJcblx0e1xuXHRcdGlmICh0aGlzLl9idWZmZXJzSW52YWxpZClcblx0XHRcdHRoaXMudXBkYXRlUlRUQnVmZmVycygpO1xuXG5cdFx0cmV0dXJuIHRoaXMuX3RleHR1cmVSYXRpb1k7XG5cdH1cblxuXHRwdWJsaWMgZ2V0IHZpZXdXaWR0aCgpOm51bWJlclxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX3ZpZXdXaWR0aDtcblx0fVxuXG5cdHB1YmxpYyBzZXQgdmlld1dpZHRoKHZhbHVlOm51bWJlcilcblx0e1xuXHRcdGlmICh2YWx1ZSA9PSB0aGlzLl92aWV3V2lkdGgpXG5cdFx0XHRyZXR1cm47XG5cblx0XHR0aGlzLl92aWV3V2lkdGggPSB2YWx1ZTtcblxuXHRcdHRoaXMuX2J1ZmZlcnNJbnZhbGlkID0gdHJ1ZTtcblxuXHRcdHRoaXMuX3RleHR1cmVXaWR0aCA9IFRleHR1cmVVdGlscy5nZXRCZXN0UG93ZXJPZjIodGhpcy5fdmlld1dpZHRoKTtcblxuXHRcdGlmICh0aGlzLl90ZXh0dXJlV2lkdGggPiB0aGlzLl92aWV3V2lkdGgpIHtcblx0XHRcdHRoaXMuX3JlbmRlclRvVGV4dHVyZVJlY3QueCA9IE1hdGguZmxvb3IoKHRoaXMuX3RleHR1cmVXaWR0aCAtIHRoaXMuX3ZpZXdXaWR0aCkqLjUpO1xuXHRcdFx0dGhpcy5fcmVuZGVyVG9UZXh0dXJlUmVjdC53aWR0aCA9IHRoaXMuX3ZpZXdXaWR0aDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5fcmVuZGVyVG9UZXh0dXJlUmVjdC54ID0gMDtcblx0XHRcdHRoaXMuX3JlbmRlclRvVGV4dHVyZVJlY3Qud2lkdGggPSB0aGlzLl90ZXh0dXJlV2lkdGg7XG5cdFx0fVxuXG5cdFx0dGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudChFdmVudC5SRVNJWkUpKTtcblx0fVxuXG5cdHB1YmxpYyBnZXQgdmlld0hlaWdodCgpOm51bWJlclxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX3ZpZXdIZWlnaHQ7XG5cdH1cblxuXHRwdWJsaWMgc2V0IHZpZXdIZWlnaHQodmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0aWYgKHZhbHVlID09IHRoaXMuX3ZpZXdIZWlnaHQpXG5cdFx0XHRyZXR1cm47XG5cblx0XHR0aGlzLl92aWV3SGVpZ2h0ID0gdmFsdWU7XG5cblx0XHR0aGlzLl9idWZmZXJzSW52YWxpZCA9IHRydWU7XG5cblx0XHR0aGlzLl90ZXh0dXJlSGVpZ2h0ID0gVGV4dHVyZVV0aWxzLmdldEJlc3RQb3dlck9mMih0aGlzLl92aWV3SGVpZ2h0KTtcblxuXHRcdGlmICh0aGlzLl90ZXh0dXJlSGVpZ2h0ID4gdGhpcy5fdmlld0hlaWdodCkge1xuXHRcdFx0dGhpcy5fcmVuZGVyVG9UZXh0dXJlUmVjdC55ID0gTWF0aC5mbG9vcigodGhpcy5fdGV4dHVyZUhlaWdodCAtIHRoaXMuX3ZpZXdIZWlnaHQpKi41KTtcblx0XHRcdHRoaXMuX3JlbmRlclRvVGV4dHVyZVJlY3QuaGVpZ2h0ID0gdGhpcy5fdmlld0hlaWdodDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5fcmVuZGVyVG9UZXh0dXJlUmVjdC55ID0gMDtcblx0XHRcdHRoaXMuX3JlbmRlclRvVGV4dHVyZVJlY3QuaGVpZ2h0ID0gdGhpcy5fdGV4dHVyZUhlaWdodDtcblx0XHR9XG5cblx0XHR0aGlzLmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KEV2ZW50LlJFU0laRSkpO1xuXHR9XG5cblx0cHVibGljIGdldCByZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXIoKTpJVmVydGV4QnVmZmVyXG5cdHtcblx0XHRpZiAodGhpcy5fYnVmZmVyc0ludmFsaWQpXG5cdFx0XHR0aGlzLnVwZGF0ZVJUVEJ1ZmZlcnMoKTtcblxuXHRcdHJldHVybiB0aGlzLl9yZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXI7XG5cdH1cblxuXHRwdWJsaWMgZ2V0IHJlbmRlclRvU2NyZWVuVmVydGV4QnVmZmVyKCk6SVZlcnRleEJ1ZmZlclxuXHR7XG5cdFx0aWYgKHRoaXMuX2J1ZmZlcnNJbnZhbGlkKVxuXHRcdFx0dGhpcy51cGRhdGVSVFRCdWZmZXJzKCk7XG5cblx0XHRyZXR1cm4gdGhpcy5fcmVuZGVyVG9TY3JlZW5WZXJ0ZXhCdWZmZXI7XG5cblx0fVxuXG5cdHB1YmxpYyBnZXQgaW5kZXhCdWZmZXIoKTpJSW5kZXhCdWZmZXJcblx0e1xuXHRcdHJldHVybiB0aGlzLl9pbmRleEJ1ZmZlcjtcblx0fVxuXG5cdHB1YmxpYyBnZXQgcmVuZGVyVG9UZXh0dXJlUmVjdCgpOlJlY3RhbmdsZVxuXHR7XG5cdFx0aWYgKHRoaXMuX2J1ZmZlcnNJbnZhbGlkKVxuXHRcdFx0dGhpcy51cGRhdGVSVFRCdWZmZXJzKCk7XG5cblx0XHRyZXR1cm4gdGhpcy5fcmVuZGVyVG9UZXh0dXJlUmVjdDtcblx0fVxuXG5cdHB1YmxpYyBnZXQgdGV4dHVyZVdpZHRoKCk6bnVtYmVyXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fdGV4dHVyZVdpZHRoO1xuXHR9XG5cblx0cHVibGljIGdldCB0ZXh0dXJlSGVpZ2h0KCk6bnVtYmVyXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fdGV4dHVyZUhlaWdodDtcblx0fVxuXG5cdHB1YmxpYyBkaXNwb3NlKClcblx0e1xuXHRcdFJUVEJ1ZmZlck1hbmFnZXIuZGVsZXRlUlRUQnVmZmVyTWFuYWdlcih0aGlzLl9zdGFnZSk7XG5cblx0XHRpZiAodGhpcy5faW5kZXhCdWZmZXIpIHtcblx0XHRcdHRoaXMuX2luZGV4QnVmZmVyLmRpc3Bvc2UoKTtcblx0XHRcdHRoaXMuX3JlbmRlclRvU2NyZWVuVmVydGV4QnVmZmVyLmRpc3Bvc2UoKTtcblx0XHRcdHRoaXMuX3JlbmRlclRvVGV4dHVyZVZlcnRleEJ1ZmZlci5kaXNwb3NlKCk7XG5cdFx0XHR0aGlzLl9yZW5kZXJUb1NjcmVlblZlcnRleEJ1ZmZlciA9IG51bGw7XG5cdFx0XHR0aGlzLl9yZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXIgPSBudWxsO1xuXHRcdFx0dGhpcy5faW5kZXhCdWZmZXIgPSBudWxsO1xuXHRcdH1cblx0fVxuXG5cdC8vIHRvZG86IHBsYWNlIGFsbCB0aGlzIGluIGEgc2VwYXJhdGUgbW9kZWwsIHNpbmNlIGl0J3MgdXNlZCBhbGwgb3ZlciB0aGUgcGxhY2Vcblx0Ly8gbWF5YmUgaXQgZXZlbiBoYXMgYSBwbGFjZSBpbiB0aGUgY29yZSAodG9nZXRoZXIgd2l0aCBzY3JlZW5SZWN0IGV0Yyk/XG5cdC8vIG5lZWRzIHRvIGJlIHN0b3JlZCBwZXIgdmlldyBvZiBjb3Vyc2Vcblx0cHJpdmF0ZSB1cGRhdGVSVFRCdWZmZXJzKClcblx0e1xuXHRcdHZhciBjb250ZXh0OkNvbnRleHRHTEJhc2UgPSA8Q29udGV4dEdMQmFzZT4gdGhpcy5fc3RhZ2UuY29udGV4dDtcblx0XHR2YXIgdGV4dHVyZVZlcnRzOm51bWJlcltdO1xuXHRcdHZhciBzY3JlZW5WZXJ0czpudW1iZXJbXTtcblxuXHRcdHZhciB4Om51bWJlcjtcblx0XHR2YXIgeTpudW1iZXI7XG5cblx0XHRpZiAodGhpcy5fcmVuZGVyVG9UZXh0dXJlVmVydGV4QnVmZmVyID09IG51bGwpXG5cdFx0XHR0aGlzLl9yZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXIgPSBjb250ZXh0LmNyZWF0ZVZlcnRleEJ1ZmZlcig0LCA1KTtcblxuXHRcdGlmICh0aGlzLl9yZW5kZXJUb1NjcmVlblZlcnRleEJ1ZmZlciA9PSBudWxsKVxuXHRcdFx0dGhpcy5fcmVuZGVyVG9TY3JlZW5WZXJ0ZXhCdWZmZXIgPSBjb250ZXh0LmNyZWF0ZVZlcnRleEJ1ZmZlcig0LCA1KTtcblxuXHRcdGlmICghdGhpcy5faW5kZXhCdWZmZXIpIHtcblx0XHRcdHRoaXMuX2luZGV4QnVmZmVyID0gY29udGV4dC5jcmVhdGVJbmRleEJ1ZmZlcig2KTtcblxuXHRcdFx0dGhpcy5faW5kZXhCdWZmZXIudXBsb2FkRnJvbUFycmF5KFsyLCAxLCAwLCAzLCAyLCAwXSwgMCwgNik7XG5cdFx0fVxuXG5cdFx0dGhpcy5fdGV4dHVyZVJhdGlvWCA9IHggPSBNYXRoLm1pbih0aGlzLl92aWV3V2lkdGgvdGhpcy5fdGV4dHVyZVdpZHRoLCAxKTtcblx0XHR0aGlzLl90ZXh0dXJlUmF0aW9ZID0geSA9IE1hdGgubWluKHRoaXMuX3ZpZXdIZWlnaHQvdGhpcy5fdGV4dHVyZUhlaWdodCwgMSk7XG5cblx0XHR2YXIgdTE6bnVtYmVyID0gKDEgLSB4KSouNTtcblx0XHR2YXIgdTI6bnVtYmVyID0gKHggKyAxKSouNTtcblx0XHR2YXIgdjE6bnVtYmVyID0gKHkgKyAxKSouNTtcblx0XHR2YXIgdjI6bnVtYmVyID0gKDEgLSB5KSouNTtcblxuXHRcdC8vIGxhc3QgZWxlbWVudCBjb250YWlucyBpbmRpY2VzIGZvciBkYXRhIHBlciB2ZXJ0ZXggdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHRoZSB2ZXJ0ZXggc2hhZGVyIGlmIG5lY2Vzc2FyeSAoaWU6IGZydXN0dW0gY29ybmVycyBmb3IgZGVmZXJyZWQgcmVuZGVyaW5nKVxuXHRcdHRleHR1cmVWZXJ0cyA9IFsgICAgLXgsIC15LCB1MSwgdjEsIDAsIHgsIC15LCB1MiwgdjEsIDEsIHgsIHksIHUyLCB2MiwgMiwgLXgsIHksIHUxLCB2MiwgMyBdO1xuXG5cdFx0c2NyZWVuVmVydHMgPSBbICAgICAtMSwgLTEsIHUxLCB2MSwgMCwgMSwgLTEsIHUyLCB2MSwgMSwgMSwgMSwgdTIsIHYyLCAyLCAtMSwgMSwgdTEsIHYyLCAzIF07XG5cblx0XHR0aGlzLl9yZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXIudXBsb2FkRnJvbUFycmF5KHRleHR1cmVWZXJ0cywgMCwgNCk7XG5cdFx0dGhpcy5fcmVuZGVyVG9TY3JlZW5WZXJ0ZXhCdWZmZXIudXBsb2FkRnJvbUFycmF5KHNjcmVlblZlcnRzLCAwLCA0KTtcblxuXHRcdHRoaXMuX2J1ZmZlcnNJbnZhbGlkID0gZmFsc2U7XG5cdH1cbn1cblxuZXhwb3J0ID0gUlRUQnVmZmVyTWFuYWdlcjtcblxuY2xhc3MgUlRUQnVmZmVyTWFuYWdlclZPXG57XG5cdHB1YmxpYyBzdGFnZTNkOlN0YWdlO1xuXG5cdHB1YmxpYyBydHRiZm06UlRUQnVmZmVyTWFuYWdlcjtcbn0iXX0=