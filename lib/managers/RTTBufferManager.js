var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Rectangle = require("awayjs-core/lib/core/geom/Rectangle");
var Event = require("awayjs-core/lib/events/Event");
var EventDispatcher = require("awayjs-core/lib/events/EventDispatcher");
var TextureUtils = require("awayjs-core/lib/utils/TextureUtils");
var RTTBufferManager = (function (_super) {
    __extends(RTTBufferManager, _super);
    function RTTBufferManager(stage) {
        _super.call(this);
        this._viewWidth = -1;
        this._viewHeight = -1;
        this._textureWidth = -1;
        this._textureHeight = -1;
        this._buffersInvalid = true;
        this._renderToTextureRect = new Rectangle();
        this._stage = stage;
    }
    RTTBufferManager.getInstance = function (stage) {
        if (!stage)
            throw new Error("stage key cannot be null!");
        if (RTTBufferManager._instances == null)
            RTTBufferManager._instances = new Array();
        var rttBufferManager = RTTBufferManager.getRTTBufferManagerFromStage(stage);
        if (rttBufferManager == null) {
            rttBufferManager = new RTTBufferManager(stage);
            var vo = new RTTBufferManagerVO();
            vo.stage3d = stage;
            vo.rttbfm = rttBufferManager;
            RTTBufferManager._instances.push(vo);
        }
        return rttBufferManager;
    };
    RTTBufferManager.getRTTBufferManagerFromStage = function (stage) {
        var l = RTTBufferManager._instances.length;
        var r;
        for (var c = 0; c < l; c++) {
            r = RTTBufferManager._instances[c];
            if (r.stage3d === stage)
                return r.rttbfm;
        }
        return null;
    };
    RTTBufferManager.deleteRTTBufferManager = function (stage) {
        var l = RTTBufferManager._instances.length;
        var r;
        for (var c = 0; c < l; c++) {
            r = RTTBufferManager._instances[c];
            if (r.stage3d === stage) {
                RTTBufferManager._instances.splice(c, 1);
                return;
            }
        }
    };
    Object.defineProperty(RTTBufferManager.prototype, "textureRatioX", {
        get: function () {
            if (this._buffersInvalid)
                this.updateRTTBuffers();
            return this._textureRatioX;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "textureRatioY", {
        get: function () {
            if (this._buffersInvalid)
                this.updateRTTBuffers();
            return this._textureRatioY;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "viewWidth", {
        get: function () {
            return this._viewWidth;
        },
        set: function (value) {
            if (value == this._viewWidth)
                return;
            this._viewWidth = value;
            this._buffersInvalid = true;
            this._textureWidth = TextureUtils.getBestPowerOf2(this._viewWidth);
            if (this._textureWidth > this._viewWidth) {
                this._renderToTextureRect.x = Math.floor((this._textureWidth - this._viewWidth) * .5);
                this._renderToTextureRect.width = this._viewWidth;
            }
            else {
                this._renderToTextureRect.x = 0;
                this._renderToTextureRect.width = this._textureWidth;
            }
            this.dispatchEvent(new Event(Event.RESIZE));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "viewHeight", {
        get: function () {
            return this._viewHeight;
        },
        set: function (value) {
            if (value == this._viewHeight)
                return;
            this._viewHeight = value;
            this._buffersInvalid = true;
            this._textureHeight = TextureUtils.getBestPowerOf2(this._viewHeight);
            if (this._textureHeight > this._viewHeight) {
                this._renderToTextureRect.y = Math.floor((this._textureHeight - this._viewHeight) * .5);
                this._renderToTextureRect.height = this._viewHeight;
            }
            else {
                this._renderToTextureRect.y = 0;
                this._renderToTextureRect.height = this._textureHeight;
            }
            this.dispatchEvent(new Event(Event.RESIZE));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "renderToTextureVertexBuffer", {
        get: function () {
            if (this._buffersInvalid)
                this.updateRTTBuffers();
            return this._renderToTextureVertexBuffer;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "renderToScreenVertexBuffer", {
        get: function () {
            if (this._buffersInvalid)
                this.updateRTTBuffers();
            return this._renderToScreenVertexBuffer;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "indexBuffer", {
        get: function () {
            return this._indexBuffer;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "renderToTextureRect", {
        get: function () {
            if (this._buffersInvalid)
                this.updateRTTBuffers();
            return this._renderToTextureRect;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "textureWidth", {
        get: function () {
            return this._textureWidth;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(RTTBufferManager.prototype, "textureHeight", {
        get: function () {
            return this._textureHeight;
        },
        enumerable: true,
        configurable: true
    });
    RTTBufferManager.prototype.dispose = function () {
        RTTBufferManager.deleteRTTBufferManager(this._stage);
        if (this._indexBuffer) {
            this._indexBuffer.dispose();
            this._renderToScreenVertexBuffer.dispose();
            this._renderToTextureVertexBuffer.dispose();
            this._renderToScreenVertexBuffer = null;
            this._renderToTextureVertexBuffer = null;
            this._indexBuffer = null;
        }
    };
    // todo: place all this in a separate model, since it's used all over the place
    // maybe it even has a place in the core (together with screenRect etc)?
    // needs to be stored per view of course
    RTTBufferManager.prototype.updateRTTBuffers = function () {
        var context = this._stage.context;
        var textureVerts;
        var screenVerts;
        var x;
        var y;
        if (this._renderToTextureVertexBuffer == null)
            this._renderToTextureVertexBuffer = context.createVertexBuffer(4, 5);
        if (this._renderToScreenVertexBuffer == null)
            this._renderToScreenVertexBuffer = context.createVertexBuffer(4, 5);
        if (!this._indexBuffer) {
            this._indexBuffer = context.createIndexBuffer(6);
            this._indexBuffer.uploadFromArray([2, 1, 0, 3, 2, 0], 0, 6);
        }
        this._textureRatioX = x = Math.min(this._viewWidth / this._textureWidth, 1);
        this._textureRatioY = y = Math.min(this._viewHeight / this._textureHeight, 1);
        var u1 = (1 - x) * .5;
        var u2 = (x + 1) * .5;
        var v1 = (y + 1) * .5;
        var v2 = (1 - y) * .5;
        // last element contains indices for data per vertex that can be passed to the vertex shader if necessary (ie: frustum corners for deferred rendering)
        textureVerts = [-x, -y, u1, v1, 0, x, -y, u2, v1, 1, x, y, u2, v2, 2, -x, y, u1, v2, 3];
        screenVerts = [-1, -1, u1, v1, 0, 1, -1, u2, v1, 1, 1, 1, u2, v2, 2, -1, 1, u1, v2, 3];
        this._renderToTextureVertexBuffer.uploadFromArray(textureVerts, 0, 4);
        this._renderToScreenVertexBuffer.uploadFromArray(screenVerts, 0, 4);
        this._buffersInvalid = false;
    };
    return RTTBufferManager;
})(EventDispatcher);
var RTTBufferManagerVO = (function () {
    function RTTBufferManagerVO() {
    }
    return RTTBufferManagerVO;
})();
module.exports = RTTBufferManager;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hbmFnZXJzL3J0dGJ1ZmZlcm1hbmFnZXIudHMiXSwibmFtZXMiOlsiUlRUQnVmZmVyTWFuYWdlciIsIlJUVEJ1ZmZlck1hbmFnZXIuY29uc3RydWN0b3IiLCJSVFRCdWZmZXJNYW5hZ2VyLmdldEluc3RhbmNlIiwiUlRUQnVmZmVyTWFuYWdlci5nZXRSVFRCdWZmZXJNYW5hZ2VyRnJvbVN0YWdlIiwiUlRUQnVmZmVyTWFuYWdlci5kZWxldGVSVFRCdWZmZXJNYW5hZ2VyIiwiUlRUQnVmZmVyTWFuYWdlci50ZXh0dXJlUmF0aW9YIiwiUlRUQnVmZmVyTWFuYWdlci50ZXh0dXJlUmF0aW9ZIiwiUlRUQnVmZmVyTWFuYWdlci52aWV3V2lkdGgiLCJSVFRCdWZmZXJNYW5hZ2VyLnZpZXdIZWlnaHQiLCJSVFRCdWZmZXJNYW5hZ2VyLnJlbmRlclRvVGV4dHVyZVZlcnRleEJ1ZmZlciIsIlJUVEJ1ZmZlck1hbmFnZXIucmVuZGVyVG9TY3JlZW5WZXJ0ZXhCdWZmZXIiLCJSVFRCdWZmZXJNYW5hZ2VyLmluZGV4QnVmZmVyIiwiUlRUQnVmZmVyTWFuYWdlci5yZW5kZXJUb1RleHR1cmVSZWN0IiwiUlRUQnVmZmVyTWFuYWdlci50ZXh0dXJlV2lkdGgiLCJSVFRCdWZmZXJNYW5hZ2VyLnRleHR1cmVIZWlnaHQiLCJSVFRCdWZmZXJNYW5hZ2VyLmRpc3Bvc2UiLCJSVFRCdWZmZXJNYW5hZ2VyLnVwZGF0ZVJUVEJ1ZmZlcnMiLCJSVFRCdWZmZXJNYW5hZ2VyVk8iLCJSVFRCdWZmZXJNYW5hZ2VyVk8uY29uc3RydWN0b3IiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLElBQU8sU0FBUyxXQUFlLHFDQUFxQyxDQUFDLENBQUM7QUFDdEUsSUFBTyxLQUFLLFdBQWdCLDhCQUE4QixDQUFDLENBQUM7QUFDNUQsSUFBTyxlQUFlLFdBQWMsd0NBQXdDLENBQUMsQ0FBQztBQUM5RSxJQUFPLFlBQVksV0FBZSxvQ0FBb0MsQ0FBQyxDQUFDO0FBTXhFLElBQU0sZ0JBQWdCO0lBQVNB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Q0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDN0RBLENBQUNBO1FBRURBLElBQUlBLENBQUNBLGNBQWNBLEdBQUdBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLEdBQUNBLElBQUlBLENBQUNBLGFBQWFBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBQzFFQSxJQUFJQSxDQUFDQSxjQUFjQSxHQUFHQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFDQSxJQUFJQSxDQUFDQSxjQUFjQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUU1RUEsSUFBSUEsRUFBRUEsR0FBVUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsRUFBRUEsQ0FBQ0E7UUFDM0JBLElBQUlBLEVBQUVBLEdBQVVBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUNBLEVBQUVBLENBQUNBO1FBQzNCQSxJQUFJQSxFQUFFQSxHQUFVQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFDQSxFQUFFQSxDQUFDQTtRQUMzQkEsSUFBSUEsRUFBRUEsR0FBVUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsRUFBRUEsQ0FBQ0E7UUFFM0JBLEFBQ0FBLHNKQURzSkE7UUFDdEpBLFlBQVlBLEdBQUdBLENBQUtBLENBQUNBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLEVBQUVBLEVBQUVBLEVBQUVBLEVBQUVBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLEVBQUVBLEVBQUVBLEVBQUVBLEVBQUVBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLEVBQUVBLEVBQUVBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLEVBQUVBLEVBQUVBLEVBQUVBLENBQUNBLENBQUVBLENBQUNBO1FBRTdGQSxXQUFXQSxHQUFHQSxDQUFNQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxFQUFFQSxDQUFDQSxDQUFFQSxDQUFDQTtRQUU3RkEsSUFBSUEsQ0FBQ0EsNEJBQTRCQSxDQUFDQSxlQUFlQSxDQUFDQSxZQUFZQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUN0RUEsSUFBSUEsQ0FBQ0EsMkJBQTJCQSxDQUFDQSxlQUFlQSxDQUFDQSxXQUFXQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUVwRUEsSUFBSUEsQ0FBQ0EsZUFBZUEsR0FBR0EsS0FBS0EsQ0FBQ0E7SUFDOUJBLENBQUNBO0lBQ0ZoQix1QkFBQ0E7QUFBREEsQ0EzUEEsQUEyUENBLEVBM1A4QixlQUFlLEVBMlA3QztBQUlELElBQU0sa0JBQWtCO0lBQXhCaUIsU0FBTUEsa0JBQWtCQTtJQUt4QkMsQ0FBQ0E7SUFBREQseUJBQUNBO0FBQURBLENBTEEsQUFLQ0EsSUFBQTtBQVBELGlCQUFTLGdCQUFnQixDQUFDIiwiZmlsZSI6Im1hbmFnZXJzL1JUVEJ1ZmZlck1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL3JvYmJhdGVtYW4vV2Vic3Rvcm1Qcm9qZWN0cy9hd2F5anMtc3RhZ2VnbC8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU3RhZ2VcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvY29yZS9iYXNlL1N0YWdlXCIpO1xuaW1wb3J0IFJlY3RhbmdsZVx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvY29yZS9nZW9tL1JlY3RhbmdsZVwiKTtcbmltcG9ydCBFdmVudFx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1jb3JlL2xpYi9ldmVudHMvRXZlbnRcIik7XG5pbXBvcnQgRXZlbnREaXNwYXRjaGVyXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZXZlbnRzL0V2ZW50RGlzcGF0Y2hlclwiKTtcbmltcG9ydCBUZXh0dXJlVXRpbHNcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3V0aWxzL1RleHR1cmVVdGlsc1wiKTtcblxuaW1wb3J0IENvbnRleHRHTEJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9jb3JlL3N0YWdlZ2wvQ29udGV4dEdMQmFzZVwiKTtcbmltcG9ydCBJSW5kZXhCdWZmZXJcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2NvcmUvc3RhZ2VnbC9JSW5kZXhCdWZmZXJcIik7XG5pbXBvcnQgSVZlcnRleEJ1ZmZlclx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2NvcmUvc3RhZ2VnbC9JVmVydGV4QnVmZmVyXCIpO1xuXG5jbGFzcyBSVFRCdWZmZXJNYW5hZ2VyIGV4dGVuZHMgRXZlbnREaXNwYXRjaGVyXG57XG5cdHByaXZhdGUgc3RhdGljIF9pbnN0YW5jZXM6QXJyYXk8UlRUQnVmZmVyTWFuYWdlclZPPjtcblxuXHRwcml2YXRlIF9yZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXI6SVZlcnRleEJ1ZmZlcjtcblx0cHJpdmF0ZSBfcmVuZGVyVG9TY3JlZW5WZXJ0ZXhCdWZmZXI6SVZlcnRleEJ1ZmZlcjtcblxuXHRwcml2YXRlIF9pbmRleEJ1ZmZlcjpJSW5kZXhCdWZmZXI7XG5cdHByaXZhdGUgX3N0YWdlOlN0YWdlO1xuXHRwcml2YXRlIF92aWV3V2lkdGg6bnVtYmVyID0gLTE7XG5cdHByaXZhdGUgX3ZpZXdIZWlnaHQ6bnVtYmVyID0gLTE7XG5cdHByaXZhdGUgX3RleHR1cmVXaWR0aDpudW1iZXIgPSAtMTtcblx0cHJpdmF0ZSBfdGV4dHVyZUhlaWdodDpudW1iZXIgPSAtMTtcblx0cHJpdmF0ZSBfcmVuZGVyVG9UZXh0dXJlUmVjdDpSZWN0YW5nbGU7XG5cdHByaXZhdGUgX2J1ZmZlcnNJbnZhbGlkOmJvb2xlYW4gPSB0cnVlO1xuXG5cdHByaXZhdGUgX3RleHR1cmVSYXRpb1g6bnVtYmVyO1xuXHRwcml2YXRlIF90ZXh0dXJlUmF0aW9ZOm51bWJlcjtcblxuXHRjb25zdHJ1Y3RvcihzdGFnZTpTdGFnZSlcblx0e1xuXHRcdHN1cGVyKCk7XG5cblx0XHR0aGlzLl9yZW5kZXJUb1RleHR1cmVSZWN0ID0gbmV3IFJlY3RhbmdsZSgpO1xuXG5cdFx0dGhpcy5fc3RhZ2UgPSBzdGFnZTtcblxuXHR9XG5cblx0cHVibGljIHN0YXRpYyBnZXRJbnN0YW5jZShzdGFnZTpTdGFnZSk6UlRUQnVmZmVyTWFuYWdlclxuXHR7XG5cdFx0aWYgKCFzdGFnZSlcblx0XHRcdHRocm93IG5ldyBFcnJvcihcInN0YWdlIGtleSBjYW5ub3QgYmUgbnVsbCFcIik7XG5cblx0XHRpZiAoUlRUQnVmZmVyTWFuYWdlci5faW5zdGFuY2VzID09IG51bGwpXG5cdFx0XHRSVFRCdWZmZXJNYW5hZ2VyLl9pbnN0YW5jZXMgPSBuZXcgQXJyYXk8UlRUQnVmZmVyTWFuYWdlclZPPigpO1xuXG5cdFx0dmFyIHJ0dEJ1ZmZlck1hbmFnZXI6UlRUQnVmZmVyTWFuYWdlciA9IFJUVEJ1ZmZlck1hbmFnZXIuZ2V0UlRUQnVmZmVyTWFuYWdlckZyb21TdGFnZShzdGFnZSk7XG5cblx0XHRpZiAocnR0QnVmZmVyTWFuYWdlciA9PSBudWxsKSB7XG5cdFx0XHRydHRCdWZmZXJNYW5hZ2VyID0gbmV3IFJUVEJ1ZmZlck1hbmFnZXIoc3RhZ2UpO1xuXG5cdFx0XHR2YXIgdm86UlRUQnVmZmVyTWFuYWdlclZPID0gbmV3IFJUVEJ1ZmZlck1hbmFnZXJWTygpO1xuXG5cdFx0XHR2by5zdGFnZTNkID0gc3RhZ2U7XG5cdFx0XHR2by5ydHRiZm0gPSBydHRCdWZmZXJNYW5hZ2VyO1xuXG5cdFx0XHRSVFRCdWZmZXJNYW5hZ2VyLl9pbnN0YW5jZXMucHVzaCh2byk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHJ0dEJ1ZmZlck1hbmFnZXI7XG5cblx0fVxuXG5cdHByaXZhdGUgc3RhdGljIGdldFJUVEJ1ZmZlck1hbmFnZXJGcm9tU3RhZ2Uoc3RhZ2U6U3RhZ2UpOlJUVEJ1ZmZlck1hbmFnZXJcblx0e1xuXG5cdFx0dmFyIGw6bnVtYmVyID0gUlRUQnVmZmVyTWFuYWdlci5faW5zdGFuY2VzLmxlbmd0aDtcblx0XHR2YXIgcjpSVFRCdWZmZXJNYW5hZ2VyVk87XG5cblx0XHRmb3IgKHZhciBjOm51bWJlciA9IDA7IGMgPCBsOyBjKyspIHtcblx0XHRcdHIgPSBSVFRCdWZmZXJNYW5hZ2VyLl9pbnN0YW5jZXNbIGMgXTtcblxuXHRcdFx0aWYgKHIuc3RhZ2UzZCA9PT0gc3RhZ2UpXG5cdFx0XHRcdHJldHVybiByLnJ0dGJmbTtcblx0XHR9XG5cblx0XHRyZXR1cm4gbnVsbDtcblx0fVxuXG5cdHByaXZhdGUgc3RhdGljIGRlbGV0ZVJUVEJ1ZmZlck1hbmFnZXIoc3RhZ2U6U3RhZ2UpOnZvaWRcblx0e1xuXHRcdHZhciBsOm51bWJlciA9IFJUVEJ1ZmZlck1hbmFnZXIuX2luc3RhbmNlcy5sZW5ndGg7XG5cdFx0dmFyIHI6UlRUQnVmZmVyTWFuYWdlclZPO1xuXG5cdFx0Zm9yICh2YXIgYzpudW1iZXIgPSAwOyBjIDwgbDsgYysrKSB7XG5cdFx0XHRyID0gUlRUQnVmZmVyTWFuYWdlci5faW5zdGFuY2VzWyBjIF07XG5cblx0XHRcdGlmIChyLnN0YWdlM2QgPT09IHN0YWdlKSB7XG5cdFx0XHRcdFJUVEJ1ZmZlck1hbmFnZXIuX2luc3RhbmNlcy5zcGxpY2UoYywgMSk7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwdWJsaWMgZ2V0IHRleHR1cmVSYXRpb1goKTpudW1iZXJcblx0e1xuXHRcdGlmICh0aGlzLl9idWZmZXJzSW52YWxpZClcblx0XHRcdHRoaXMudXBkYXRlUlRUQnVmZmVycygpO1xuXG5cdFx0cmV0dXJuIHRoaXMuX3RleHR1cmVSYXRpb1g7XG5cdH1cblxuXHRwdWJsaWMgZ2V0IHRleHR1cmVSYXRpb1koKTpudW1iZXJcblx0e1xuXHRcdGlmICh0aGlzLl9idWZmZXJzSW52YWxpZClcblx0XHRcdHRoaXMudXBkYXRlUlRUQnVmZmVycygpO1xuXG5cdFx0cmV0dXJuIHRoaXMuX3RleHR1cmVSYXRpb1k7XG5cdH1cblxuXHRwdWJsaWMgZ2V0IHZpZXdXaWR0aCgpOm51bWJlclxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX3ZpZXdXaWR0aDtcblx0fVxuXG5cdHB1YmxpYyBzZXQgdmlld1dpZHRoKHZhbHVlOm51bWJlcilcblx0e1xuXHRcdGlmICh2YWx1ZSA9PSB0aGlzLl92aWV3V2lkdGgpXG5cdFx0XHRyZXR1cm47XG5cblx0XHR0aGlzLl92aWV3V2lkdGggPSB2YWx1ZTtcblxuXHRcdHRoaXMuX2J1ZmZlcnNJbnZhbGlkID0gdHJ1ZTtcblxuXHRcdHRoaXMuX3RleHR1cmVXaWR0aCA9IFRleHR1cmVVdGlscy5nZXRCZXN0UG93ZXJPZjIodGhpcy5fdmlld1dpZHRoKTtcblxuXHRcdGlmICh0aGlzLl90ZXh0dXJlV2lkdGggPiB0aGlzLl92aWV3V2lkdGgpIHtcblx0XHRcdHRoaXMuX3JlbmRlclRvVGV4dHVyZVJlY3QueCA9IE1hdGguZmxvb3IoKHRoaXMuX3RleHR1cmVXaWR0aCAtIHRoaXMuX3ZpZXdXaWR0aCkqLjUpO1xuXHRcdFx0dGhpcy5fcmVuZGVyVG9UZXh0dXJlUmVjdC53aWR0aCA9IHRoaXMuX3ZpZXdXaWR0aDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5fcmVuZGVyVG9UZXh0dXJlUmVjdC54ID0gMDtcblx0XHRcdHRoaXMuX3JlbmRlclRvVGV4dHVyZVJlY3Qud2lkdGggPSB0aGlzLl90ZXh0dXJlV2lkdGg7XG5cdFx0fVxuXG5cdFx0dGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudChFdmVudC5SRVNJWkUpKTtcblx0fVxuXG5cdHB1YmxpYyBnZXQgdmlld0hlaWdodCgpOm51bWJlclxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuX3ZpZXdIZWlnaHQ7XG5cdH1cblxuXHRwdWJsaWMgc2V0IHZpZXdIZWlnaHQodmFsdWU6bnVtYmVyKVxuXHR7XG5cdFx0aWYgKHZhbHVlID09IHRoaXMuX3ZpZXdIZWlnaHQpXG5cdFx0XHRyZXR1cm47XG5cblx0XHR0aGlzLl92aWV3SGVpZ2h0ID0gdmFsdWU7XG5cblx0XHR0aGlzLl9idWZmZXJzSW52YWxpZCA9IHRydWU7XG5cblx0XHR0aGlzLl90ZXh0dXJlSGVpZ2h0ID0gVGV4dHVyZVV0aWxzLmdldEJlc3RQb3dlck9mMih0aGlzLl92aWV3SGVpZ2h0KTtcblxuXHRcdGlmICh0aGlzLl90ZXh0dXJlSGVpZ2h0ID4gdGhpcy5fdmlld0hlaWdodCkge1xuXHRcdFx0dGhpcy5fcmVuZGVyVG9UZXh0dXJlUmVjdC55ID0gTWF0aC5mbG9vcigodGhpcy5fdGV4dHVyZUhlaWdodCAtIHRoaXMuX3ZpZXdIZWlnaHQpKi41KTtcblx0XHRcdHRoaXMuX3JlbmRlclRvVGV4dHVyZVJlY3QuaGVpZ2h0ID0gdGhpcy5fdmlld0hlaWdodDtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5fcmVuZGVyVG9UZXh0dXJlUmVjdC55ID0gMDtcblx0XHRcdHRoaXMuX3JlbmRlclRvVGV4dHVyZVJlY3QuaGVpZ2h0ID0gdGhpcy5fdGV4dHVyZUhlaWdodDtcblx0XHR9XG5cblx0XHR0aGlzLmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KEV2ZW50LlJFU0laRSkpO1xuXHR9XG5cblx0cHVibGljIGdldCByZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXIoKTpJVmVydGV4QnVmZmVyXG5cdHtcblx0XHRpZiAodGhpcy5fYnVmZmVyc0ludmFsaWQpXG5cdFx0XHR0aGlzLnVwZGF0ZVJUVEJ1ZmZlcnMoKTtcblxuXHRcdHJldHVybiB0aGlzLl9yZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXI7XG5cdH1cblxuXHRwdWJsaWMgZ2V0IHJlbmRlclRvU2NyZWVuVmVydGV4QnVmZmVyKCk6SVZlcnRleEJ1ZmZlclxuXHR7XG5cdFx0aWYgKHRoaXMuX2J1ZmZlcnNJbnZhbGlkKVxuXHRcdFx0dGhpcy51cGRhdGVSVFRCdWZmZXJzKCk7XG5cblx0XHRyZXR1cm4gdGhpcy5fcmVuZGVyVG9TY3JlZW5WZXJ0ZXhCdWZmZXI7XG5cblx0fVxuXG5cdHB1YmxpYyBnZXQgaW5kZXhCdWZmZXIoKTpJSW5kZXhCdWZmZXJcblx0e1xuXHRcdHJldHVybiB0aGlzLl9pbmRleEJ1ZmZlcjtcblx0fVxuXG5cdHB1YmxpYyBnZXQgcmVuZGVyVG9UZXh0dXJlUmVjdCgpOlJlY3RhbmdsZVxuXHR7XG5cdFx0aWYgKHRoaXMuX2J1ZmZlcnNJbnZhbGlkKVxuXHRcdFx0dGhpcy51cGRhdGVSVFRCdWZmZXJzKCk7XG5cblx0XHRyZXR1cm4gdGhpcy5fcmVuZGVyVG9UZXh0dXJlUmVjdDtcblx0fVxuXG5cdHB1YmxpYyBnZXQgdGV4dHVyZVdpZHRoKCk6bnVtYmVyXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fdGV4dHVyZVdpZHRoO1xuXHR9XG5cblx0cHVibGljIGdldCB0ZXh0dXJlSGVpZ2h0KCk6bnVtYmVyXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fdGV4dHVyZUhlaWdodDtcblx0fVxuXG5cdHB1YmxpYyBkaXNwb3NlKClcblx0e1xuXHRcdFJUVEJ1ZmZlck1hbmFnZXIuZGVsZXRlUlRUQnVmZmVyTWFuYWdlcih0aGlzLl9zdGFnZSk7XG5cblx0XHRpZiAodGhpcy5faW5kZXhCdWZmZXIpIHtcblx0XHRcdHRoaXMuX2luZGV4QnVmZmVyLmRpc3Bvc2UoKTtcblx0XHRcdHRoaXMuX3JlbmRlclRvU2NyZWVuVmVydGV4QnVmZmVyLmRpc3Bvc2UoKTtcblx0XHRcdHRoaXMuX3JlbmRlclRvVGV4dHVyZVZlcnRleEJ1ZmZlci5kaXNwb3NlKCk7XG5cdFx0XHR0aGlzLl9yZW5kZXJUb1NjcmVlblZlcnRleEJ1ZmZlciA9IG51bGw7XG5cdFx0XHR0aGlzLl9yZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXIgPSBudWxsO1xuXHRcdFx0dGhpcy5faW5kZXhCdWZmZXIgPSBudWxsO1xuXHRcdH1cblx0fVxuXG5cdC8vIHRvZG86IHBsYWNlIGFsbCB0aGlzIGluIGEgc2VwYXJhdGUgbW9kZWwsIHNpbmNlIGl0J3MgdXNlZCBhbGwgb3ZlciB0aGUgcGxhY2Vcblx0Ly8gbWF5YmUgaXQgZXZlbiBoYXMgYSBwbGFjZSBpbiB0aGUgY29yZSAodG9nZXRoZXIgd2l0aCBzY3JlZW5SZWN0IGV0Yyk/XG5cdC8vIG5lZWRzIHRvIGJlIHN0b3JlZCBwZXIgdmlldyBvZiBjb3Vyc2Vcblx0cHJpdmF0ZSB1cGRhdGVSVFRCdWZmZXJzKClcblx0e1xuXHRcdHZhciBjb250ZXh0OkNvbnRleHRHTEJhc2UgPSA8Q29udGV4dEdMQmFzZT4gdGhpcy5fc3RhZ2UuY29udGV4dDtcblx0XHR2YXIgdGV4dHVyZVZlcnRzOm51bWJlcltdO1xuXHRcdHZhciBzY3JlZW5WZXJ0czpudW1iZXJbXTtcblxuXHRcdHZhciB4Om51bWJlcjtcblx0XHR2YXIgeTpudW1iZXI7XG5cblx0XHRpZiAodGhpcy5fcmVuZGVyVG9UZXh0dXJlVmVydGV4QnVmZmVyID09IG51bGwpXG5cdFx0XHR0aGlzLl9yZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXIgPSBjb250ZXh0LmNyZWF0ZVZlcnRleEJ1ZmZlcig0LCA1KTtcblxuXHRcdGlmICh0aGlzLl9yZW5kZXJUb1NjcmVlblZlcnRleEJ1ZmZlciA9PSBudWxsKVxuXHRcdFx0dGhpcy5fcmVuZGVyVG9TY3JlZW5WZXJ0ZXhCdWZmZXIgPSBjb250ZXh0LmNyZWF0ZVZlcnRleEJ1ZmZlcig0LCA1KTtcblxuXHRcdGlmICghdGhpcy5faW5kZXhCdWZmZXIpIHtcblx0XHRcdHRoaXMuX2luZGV4QnVmZmVyID0gY29udGV4dC5jcmVhdGVJbmRleEJ1ZmZlcig2KTtcblxuXHRcdFx0dGhpcy5faW5kZXhCdWZmZXIudXBsb2FkRnJvbUFycmF5KFsyLCAxLCAwLCAzLCAyLCAwXSwgMCwgNik7XG5cdFx0fVxuXG5cdFx0dGhpcy5fdGV4dHVyZVJhdGlvWCA9IHggPSBNYXRoLm1pbih0aGlzLl92aWV3V2lkdGgvdGhpcy5fdGV4dHVyZVdpZHRoLCAxKTtcblx0XHR0aGlzLl90ZXh0dXJlUmF0aW9ZID0geSA9IE1hdGgubWluKHRoaXMuX3ZpZXdIZWlnaHQvdGhpcy5fdGV4dHVyZUhlaWdodCwgMSk7XG5cblx0XHR2YXIgdTE6bnVtYmVyID0gKDEgLSB4KSouNTtcblx0XHR2YXIgdTI6bnVtYmVyID0gKHggKyAxKSouNTtcblx0XHR2YXIgdjE6bnVtYmVyID0gKHkgKyAxKSouNTtcblx0XHR2YXIgdjI6bnVtYmVyID0gKDEgLSB5KSouNTtcblxuXHRcdC8vIGxhc3QgZWxlbWVudCBjb250YWlucyBpbmRpY2VzIGZvciBkYXRhIHBlciB2ZXJ0ZXggdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHRoZSB2ZXJ0ZXggc2hhZGVyIGlmIG5lY2Vzc2FyeSAoaWU6IGZydXN0dW0gY29ybmVycyBmb3IgZGVmZXJyZWQgcmVuZGVyaW5nKVxuXHRcdHRleHR1cmVWZXJ0cyA9IFsgICAgLXgsIC15LCB1MSwgdjEsIDAsIHgsIC15LCB1MiwgdjEsIDEsIHgsIHksIHUyLCB2MiwgMiwgLXgsIHksIHUxLCB2MiwgMyBdO1xuXG5cdFx0c2NyZWVuVmVydHMgPSBbICAgICAtMSwgLTEsIHUxLCB2MSwgMCwgMSwgLTEsIHUyLCB2MSwgMSwgMSwgMSwgdTIsIHYyLCAyLCAtMSwgMSwgdTEsIHYyLCAzIF07XG5cblx0XHR0aGlzLl9yZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXIudXBsb2FkRnJvbUFycmF5KHRleHR1cmVWZXJ0cywgMCwgNCk7XG5cdFx0dGhpcy5fcmVuZGVyVG9TY3JlZW5WZXJ0ZXhCdWZmZXIudXBsb2FkRnJvbUFycmF5KHNjcmVlblZlcnRzLCAwLCA0KTtcblxuXHRcdHRoaXMuX2J1ZmZlcnNJbnZhbGlkID0gZmFsc2U7XG5cdH1cbn1cblxuZXhwb3J0ID0gUlRUQnVmZmVyTWFuYWdlcjtcblxuY2xhc3MgUlRUQnVmZmVyTWFuYWdlclZPXG57XG5cdHB1YmxpYyBzdGFnZTNkOlN0YWdlO1xuXG5cdHB1YmxpYyBydHRiZm06UlRUQnVmZmVyTWFuYWdlcjtcbn0iXX0=