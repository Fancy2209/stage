var Description = require("awayjs-stagegl/lib/aglsl/Description");
var Header = require("awayjs-stagegl/lib/aglsl/Header");
var Mapping = require("awayjs-stagegl/lib/aglsl/Mapping");
var Token = require("awayjs-stagegl/lib/aglsl/Token");
var AGALTokenizer = (function () {
    function AGALTokenizer() {
    }
    AGALTokenizer.prototype.decribeAGALByteArray = function (bytes) {
        var header = new Header();
        if (bytes.readUnsignedByte() != 0xa0) {
            throw "Bad AGAL: Missing 0xa0 magic byte.";
        }
        header.version = bytes.readUnsignedInt();
        if (header.version >= 0x10) {
            bytes.readUnsignedByte();
            header.version >>= 1;
        }
        if (bytes.readUnsignedByte() != 0xa1) {
            throw "Bad AGAL: Missing 0xa1 magic byte.";
        }
        header.progid = bytes.readUnsignedByte();
        switch (header.progid) {
            case 1:
                header.type = "fragment";
                break;
            case 0:
                header.type = "vertex";
                break;
            case 2:
                header.type = "cpu";
                break;
            default:
                header.type = "";
                break;
        }
        var desc = new Description();
        var tokens = [];
        while (bytes.position < bytes.length) {
            var token = new Token();
            token.opcode = bytes.readUnsignedInt();
            var lutentry = Mapping.agal2glsllut[token.opcode];
            if (!lutentry) {
                throw "Opcode not valid or not implemented yet: " + token.opcode;
            }
            if (lutentry.matrixheight) {
                desc.hasmatrix = true;
            }
            if (lutentry.dest) {
                token.dest.regnum = bytes.readUnsignedShort();
                token.dest.mask = bytes.readUnsignedByte();
                token.dest.regtype = bytes.readUnsignedByte();
                desc.regwrite[token.dest.regtype][token.dest.regnum] |= token.dest.mask;
            }
            else {
                token.dest = null;
                bytes.readUnsignedInt();
            }
            if (lutentry.a) {
                this.readReg(token.a, 1, desc, bytes);
            }
            else {
                token.a = null;
                bytes.readUnsignedInt();
                bytes.readUnsignedInt();
            }
            if (lutentry.b) {
                this.readReg(token.b, lutentry.matrixheight | 0, desc, bytes);
            }
            else {
                token.b = null;
                bytes.readUnsignedInt();
                bytes.readUnsignedInt();
            }
            tokens.push(token);
        }
        desc.header = header;
        desc.tokens = tokens;
        return desc;
    };
    AGALTokenizer.prototype.readReg = function (s, mh, desc, bytes) {
        s.regnum = bytes.readUnsignedShort();
        s.indexoffset = bytes.readByte();
        s.swizzle = bytes.readUnsignedByte();
        s.regtype = bytes.readUnsignedByte();
        desc.regread[s.regtype][s.regnum] = 0xf; // sould be swizzle to mask? should be |=                                                 
        if (s.regtype == 0x5) {
            // sampler
            s.lodbiad = s.indexoffset;
            s.indexoffset = undefined;
            s.swizzle = undefined;
            // sampler 
            s.readmode = bytes.readUnsignedByte();
            s.dim = s.readmode >> 4;
            s.readmode &= 0xf;
            s.special = bytes.readUnsignedByte();
            s.wrap = s.special >> 4;
            s.special &= 0xf;
            s.mipmap = bytes.readUnsignedByte();
            s.filter = s.mipmap >> 4;
            s.mipmap &= 0xf;
            desc.samplers[s.regnum] = s;
        }
        else {
            s.indexregtype = bytes.readUnsignedByte();
            s.indexselect = bytes.readUnsignedByte();
            s.indirectflag = bytes.readUnsignedByte();
        }
        if (s.indirectflag) {
            desc.hasindirect = true;
        }
        if (!s.indirectflag && mh) {
            for (var mhi = 0; mhi < mh; mhi++) {
                desc.regread[s.regtype][s.regnum + mhi] = desc.regread[s.regtype][s.regnum];
            }
        }
    };
    return AGALTokenizer;
})();
module.exports = AGALTokenizer;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFnbHNsL2FnYWx0b2tlbml6ZXIudHMiXSwibmFtZXMiOlsiQUdBTFRva2VuaXplciIsIkFHQUxUb2tlbml6ZXIuY29uc3RydWN0b3IiLCJBR0FMVG9rZW5pemVyLmRlY3JpYmVBR0FMQnl0ZUFycmF5IiwiQUdBTFRva2VuaXplci5yZWFkUmVnIl0sIm1hcHBpbmdzIjoiQUFFQSxJQUFPLFdBQVcsV0FBYyxzQ0FBc0MsQ0FBQyxDQUFDO0FBQ3hFLElBQU8sTUFBTSxXQUFlLGlDQUFpQyxDQUFDLENBQUM7QUFDL0QsSUFBTyxPQUFPLFdBQWUsa0NBQWtDLENBQUMsQ0FBQztBQUNqRSxJQUFPLEtBQUssV0FBZSxnQ0FBZ0MsQ0FBQyxDQUFDO0FBRTdELElBQU0sYUFBYTtJQUVsQkEsU0FGS0EsYUFBYUE7SUFJbEJDLENBQUNBO0lBRU1ELDRDQUFvQkEsR0FBM0JBLFVBQTRCQSxLQUFlQTtRQUUxQ0UsSUFBSUEsTUFBTUEsR0FBVUEsSUFBSUEsTUFBTUEsRUFBRUEsQ0FBQ0E7UUFFakNBLEVBQUVBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLGdCQUFnQkEsRUFBRUEsSUFBSUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDdENBLE1BQU1BLG9DQUFvQ0EsQ0FBQ0E7UUFDNUNBLENBQUNBO1FBRURBLE1BQU1BLENBQUNBLE9BQU9BLEdBQUdBLEtBQUtBLENBQUNBLGVBQWVBLEVBQUVBLENBQUNBO1FBQ3pDQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxPQUFPQSxJQUFJQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUM1QkEsS0FBS0EsQ0FBQ0EsZ0JBQWdCQSxFQUFFQSxDQUFDQTtZQUN6QkEsTUFBTUEsQ0FBQ0EsT0FBT0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFDdEJBLENBQUNBO1FBQ0RBLEVBQUVBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLGdCQUFnQkEsRUFBRUEsSUFBSUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDdENBLE1BQU1BLG9DQUFvQ0EsQ0FBQ0E7UUFDNUNBLENBQUNBO1FBRURBLE1BQU1BLENBQUNBLE1BQU1BLEdBQUdBLEtBQUtBLENBQUNBLGdCQUFnQkEsRUFBRUEsQ0FBQ0E7UUFDekNBLE1BQU1BLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO1lBQ3ZCQSxLQUFLQSxDQUFDQTtnQkFDTEEsTUFBTUEsQ0FBQ0EsSUFBSUEsR0FBR0EsVUFBVUEsQ0FBQ0E7Z0JBQ3pCQSxLQUFLQSxDQUFDQTtZQUNQQSxLQUFLQSxDQUFDQTtnQkFDTEEsTUFBTUEsQ0FBQ0EsSUFBSUEsR0FBR0EsUUFBUUEsQ0FBQ0E7Z0JBQ3ZCQSxLQUFLQSxDQUFDQTtZQUNQQSxLQUFLQSxDQUFDQTtnQkFDTEEsTUFBTUEsQ0FBQ0EsSUFBSUEsR0FBR0EsS0FBS0EsQ0FBQ0E7Z0JBQ3BCQSxLQUFLQSxDQUFDQTtZQUNQQTtnQkFDQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsR0FBR0EsRUFBRUEsQ0FBQ0E7Z0JBQ2pCQSxLQUFLQSxDQUFDQTtRQUNSQSxDQUFDQTtRQUVEQSxJQUFJQSxJQUFJQSxHQUFlQSxJQUFJQSxXQUFXQSxFQUFFQSxDQUFDQTtRQUN6Q0EsSUFBSUEsTUFBTUEsR0FBV0EsRUFBRUEsQ0FBQ0E7UUFDeEJBLE9BQU9BLEtBQUtBLENBQUNBLFFBQVFBLEdBQUdBLEtBQUtBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBO1lBQ3RDQSxJQUFJQSxLQUFLQSxHQUFTQSxJQUFJQSxLQUFLQSxFQUFFQSxDQUFDQTtZQUU5QkEsS0FBS0EsQ0FBQ0EsTUFBTUEsR0FBR0EsS0FBS0EsQ0FBQ0EsZUFBZUEsRUFBRUEsQ0FBQ0E7WUFDdkNBLElBQUlBLFFBQVFBLEdBQUdBLE9BQU9BLENBQUNBLFlBQVlBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1lBQ2xEQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDZkEsTUFBTUEsMkNBQTJDQSxHQUFHQSxLQUFLQSxDQUFDQSxNQUFNQSxDQUFDQTtZQUNsRUEsQ0FBQ0E7WUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzNCQSxJQUFJQSxDQUFDQSxTQUFTQSxHQUFHQSxJQUFJQSxDQUFDQTtZQUN2QkEsQ0FBQ0E7WUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ25CQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxHQUFHQSxLQUFLQSxDQUFDQSxpQkFBaUJBLEVBQUVBLENBQUNBO2dCQUM5Q0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsR0FBR0EsS0FBS0EsQ0FBQ0EsZ0JBQWdCQSxFQUFFQSxDQUFDQTtnQkFDM0NBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLEdBQUdBLEtBQUtBLENBQUNBLGdCQUFnQkEsRUFBRUEsQ0FBQ0E7Z0JBQzlDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQTtZQUN6RUEsQ0FBQ0E7WUFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ1BBLEtBQUtBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBO2dCQUNsQkEsS0FBS0EsQ0FBQ0EsZUFBZUEsRUFBRUEsQ0FBQ0E7WUFDekJBLENBQUNBO1lBQ0RBLEVBQUVBLENBQUNBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUNoQkEsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsSUFBSUEsRUFBRUEsS0FBS0EsQ0FBQ0EsQ0FBQ0E7WUFDdkNBLENBQUNBO1lBQUNBLElBQUlBLENBQUNBLENBQUNBO2dCQUNQQSxLQUFLQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQTtnQkFDZkEsS0FBS0EsQ0FBQ0EsZUFBZUEsRUFBRUEsQ0FBQ0E7Z0JBQ3hCQSxLQUFLQSxDQUFDQSxlQUFlQSxFQUFFQSxDQUFDQTtZQUN6QkEsQ0FBQ0E7WUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2hCQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxFQUFFQSxRQUFRQSxDQUFDQSxZQUFZQSxHQUFHQSxDQUFDQSxFQUFFQSxJQUFJQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtZQUMvREEsQ0FBQ0E7WUFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ1BBLEtBQUtBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBO2dCQUNmQSxLQUFLQSxDQUFDQSxlQUFlQSxFQUFFQSxDQUFDQTtnQkFDeEJBLEtBQUtBLENBQUNBLGVBQWVBLEVBQUVBLENBQUNBO1lBQ3pCQSxDQUFDQTtZQUNEQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQTtRQUNwQkEsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsTUFBTUEsQ0FBQ0E7UUFDckJBLElBQUlBLENBQUNBLE1BQU1BLEdBQUdBLE1BQU1BLENBQUNBO1FBRXJCQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtJQUNiQSxDQUFDQTtJQUVNRiwrQkFBT0EsR0FBZEEsVUFBZUEsQ0FBQ0EsRUFBRUEsRUFBRUEsRUFBRUEsSUFBSUEsRUFBRUEsS0FBS0E7UUFFaENHLENBQUNBLENBQUNBLE1BQU1BLEdBQUdBLEtBQUtBLENBQUNBLGlCQUFpQkEsRUFBRUEsQ0FBQ0E7UUFDckNBLENBQUNBLENBQUNBLFdBQVdBLEdBQUdBLEtBQUtBLENBQUNBLFFBQVFBLEVBQUVBLENBQUNBO1FBQ2pDQSxDQUFDQSxDQUFDQSxPQUFPQSxHQUFHQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLENBQUNBO1FBQ3JDQSxDQUFDQSxDQUFDQSxPQUFPQSxHQUFHQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLENBQUNBO1FBQ3JDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxHQUFHQSxFQUFFQSwwRkFBMEZBO1FBQ25JQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxPQUFPQSxJQUFJQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN0QkEsQUFDQUEsVUFEVUE7WUFDVkEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsV0FBV0EsQ0FBQ0E7WUFDMUJBLENBQUNBLENBQUNBLFdBQVdBLEdBQUdBLFNBQVNBLENBQUNBO1lBQzFCQSxDQUFDQSxDQUFDQSxPQUFPQSxHQUFHQSxTQUFTQSxDQUFDQTtZQUV0QkEsQUFDQUEsV0FEV0E7WUFDWEEsQ0FBQ0EsQ0FBQ0EsUUFBUUEsR0FBR0EsS0FBS0EsQ0FBQ0EsZ0JBQWdCQSxFQUFFQSxDQUFDQTtZQUN0Q0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsUUFBUUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDeEJBLENBQUNBLENBQUNBLFFBQVFBLElBQUlBLEdBQUdBLENBQUNBO1lBQ2xCQSxDQUFDQSxDQUFDQSxPQUFPQSxHQUFHQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLENBQUNBO1lBQ3JDQSxDQUFDQSxDQUFDQSxJQUFJQSxHQUFHQSxDQUFDQSxDQUFDQSxPQUFPQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUN4QkEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsSUFBSUEsR0FBR0EsQ0FBQ0E7WUFDakJBLENBQUNBLENBQUNBLE1BQU1BLEdBQUdBLEtBQUtBLENBQUNBLGdCQUFnQkEsRUFBRUEsQ0FBQ0E7WUFDcENBLENBQUNBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBLE1BQU1BLElBQUlBLENBQUNBLENBQUNBO1lBQ3pCQSxDQUFDQSxDQUFDQSxNQUFNQSxJQUFJQSxHQUFHQSxDQUFDQTtZQUNoQkEsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDN0JBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ1BBLENBQUNBLENBQUNBLFlBQVlBLEdBQUdBLEtBQUtBLENBQUNBLGdCQUFnQkEsRUFBRUEsQ0FBQ0E7WUFDMUNBLENBQUNBLENBQUNBLFdBQVdBLEdBQUdBLEtBQUtBLENBQUNBLGdCQUFnQkEsRUFBRUEsQ0FBQ0E7WUFDekNBLENBQUNBLENBQUNBLFlBQVlBLEdBQUdBLEtBQUtBLENBQUNBLGdCQUFnQkEsRUFBRUEsQ0FBQ0E7UUFDM0NBLENBQUNBO1FBQ0RBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLFlBQVlBLENBQUNBLENBQUNBLENBQUNBO1lBQ3BCQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUN6QkEsQ0FBQ0E7UUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsWUFBWUEsSUFBSUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDM0JBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLEdBQVVBLENBQUNBLEVBQUVBLEdBQUdBLEdBQUdBLEVBQUVBLEVBQUVBLEdBQUdBLEVBQUVBLEVBQ3hDQSxDQUFDQTtnQkFDQUEsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsTUFBTUEsR0FBR0EsR0FBR0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7WUFDN0VBLENBQUNBO1FBQ0ZBLENBQUNBO0lBQ0ZBLENBQUNBO0lBQ0ZILG9CQUFDQTtBQUFEQSxDQTFIQSxBQTBIQ0EsSUFBQTtBQUVELEFBQXVCLGlCQUFkLGFBQWEsQ0FBQyIsImZpbGUiOiJhZ2xzbC9BR0FMVG9rZW5pemVyLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9yb2JiYXRlbWFuL1dlYnN0b3JtUHJvamVjdHMvYXdheWpzLXN0YWdlZ2wvIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEJ5dGVBcnJheVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL3V0aWxzL0J5dGVBcnJheVwiKTtcblxuaW1wb3J0IERlc2NyaXB0aW9uXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYWdsc2wvRGVzY3JpcHRpb25cIik7XG5pbXBvcnQgSGVhZGVyXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9hZ2xzbC9IZWFkZXJcIik7XG5pbXBvcnQgTWFwcGluZ1x0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYWdsc2wvTWFwcGluZ1wiKTtcbmltcG9ydCBUb2tlblx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYWdsc2wvVG9rZW5cIik7XG5cbmNsYXNzIEFHQUxUb2tlbml6ZXJcbntcblx0Y29uc3RydWN0b3IoKVxuXHR7XG5cdH1cblxuXHRwdWJsaWMgZGVjcmliZUFHQUxCeXRlQXJyYXkoYnl0ZXM6Qnl0ZUFycmF5KVxuXHR7XG5cdFx0dmFyIGhlYWRlcjpIZWFkZXIgPSBuZXcgSGVhZGVyKCk7XG5cblx0XHRpZiAoYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpICE9IDB4YTApIHtcblx0XHRcdHRocm93IFwiQmFkIEFHQUw6IE1pc3NpbmcgMHhhMCBtYWdpYyBieXRlLlwiO1xuXHRcdH1cblxuXHRcdGhlYWRlci52ZXJzaW9uID0gYnl0ZXMucmVhZFVuc2lnbmVkSW50KCk7XG5cdFx0aWYgKGhlYWRlci52ZXJzaW9uID49IDB4MTApIHtcblx0XHRcdGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcblx0XHRcdGhlYWRlci52ZXJzaW9uID4+PSAxO1xuXHRcdH1cblx0XHRpZiAoYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpICE9IDB4YTEpIHtcblx0XHRcdHRocm93IFwiQmFkIEFHQUw6IE1pc3NpbmcgMHhhMSBtYWdpYyBieXRlLlwiO1xuXHRcdH1cblxuXHRcdGhlYWRlci5wcm9naWQgPSBieXRlcy5yZWFkVW5zaWduZWRCeXRlKCk7XG5cdFx0c3dpdGNoIChoZWFkZXIucHJvZ2lkKSB7XG5cdFx0XHRjYXNlIDE6XG5cdFx0XHRcdGhlYWRlci50eXBlID0gXCJmcmFnbWVudFwiO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgMDpcblx0XHRcdFx0aGVhZGVyLnR5cGUgPSBcInZlcnRleFwiO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgMjpcblx0XHRcdFx0aGVhZGVyLnR5cGUgPSBcImNwdVwiO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdGhlYWRlci50eXBlID0gXCJcIjtcblx0XHRcdFx0YnJlYWs7XG5cdFx0fVxuXG5cdFx0dmFyIGRlc2M6RGVzY3JpcHRpb24gPSBuZXcgRGVzY3JpcHRpb24oKTtcblx0XHR2YXIgdG9rZW5zOlRva2VuW10gPSBbXTtcblx0XHR3aGlsZSAoYnl0ZXMucG9zaXRpb24gPCBieXRlcy5sZW5ndGgpIHtcblx0XHRcdHZhciB0b2tlbjpUb2tlbiA9IG5ldyBUb2tlbigpO1xuXG5cdFx0XHR0b2tlbi5vcGNvZGUgPSBieXRlcy5yZWFkVW5zaWduZWRJbnQoKTtcblx0XHRcdHZhciBsdXRlbnRyeSA9IE1hcHBpbmcuYWdhbDJnbHNsbHV0W3Rva2VuLm9wY29kZV07XG5cdFx0XHRpZiAoIWx1dGVudHJ5KSB7XG5cdFx0XHRcdHRocm93IFwiT3Bjb2RlIG5vdCB2YWxpZCBvciBub3QgaW1wbGVtZW50ZWQgeWV0OiBcIiArIHRva2VuLm9wY29kZTtcblx0XHRcdH1cblx0XHRcdGlmIChsdXRlbnRyeS5tYXRyaXhoZWlnaHQpIHtcblx0XHRcdFx0ZGVzYy5oYXNtYXRyaXggPSB0cnVlO1xuXHRcdFx0fVxuXHRcdFx0aWYgKGx1dGVudHJ5LmRlc3QpIHtcblx0XHRcdFx0dG9rZW4uZGVzdC5yZWdudW0gPSBieXRlcy5yZWFkVW5zaWduZWRTaG9ydCgpO1xuXHRcdFx0XHR0b2tlbi5kZXN0Lm1hc2sgPSBieXRlcy5yZWFkVW5zaWduZWRCeXRlKCk7XG5cdFx0XHRcdHRva2VuLmRlc3QucmVndHlwZSA9IGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcblx0XHRcdFx0ZGVzYy5yZWd3cml0ZVt0b2tlbi5kZXN0LnJlZ3R5cGVdW3Rva2VuLmRlc3QucmVnbnVtXSB8PSB0b2tlbi5kZXN0Lm1hc2s7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0b2tlbi5kZXN0ID0gbnVsbDtcblx0XHRcdFx0Ynl0ZXMucmVhZFVuc2lnbmVkSW50KCk7XG5cdFx0XHR9XG5cdFx0XHRpZiAobHV0ZW50cnkuYSkge1xuXHRcdFx0XHR0aGlzLnJlYWRSZWcodG9rZW4uYSwgMSwgZGVzYywgYnl0ZXMpO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dG9rZW4uYSA9IG51bGw7XG5cdFx0XHRcdGJ5dGVzLnJlYWRVbnNpZ25lZEludCgpO1xuXHRcdFx0XHRieXRlcy5yZWFkVW5zaWduZWRJbnQoKTtcblx0XHRcdH1cblx0XHRcdGlmIChsdXRlbnRyeS5iKSB7XG5cdFx0XHRcdHRoaXMucmVhZFJlZyh0b2tlbi5iLCBsdXRlbnRyeS5tYXRyaXhoZWlnaHQgfCAwLCBkZXNjLCBieXRlcyk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0b2tlbi5iID0gbnVsbDtcblx0XHRcdFx0Ynl0ZXMucmVhZFVuc2lnbmVkSW50KCk7XG5cdFx0XHRcdGJ5dGVzLnJlYWRVbnNpZ25lZEludCgpO1xuXHRcdFx0fVxuXHRcdFx0dG9rZW5zLnB1c2godG9rZW4pO1xuXHRcdH1cblx0XHRkZXNjLmhlYWRlciA9IGhlYWRlcjtcblx0XHRkZXNjLnRva2VucyA9IHRva2VucztcblxuXHRcdHJldHVybiBkZXNjO1xuXHR9XG5cblx0cHVibGljIHJlYWRSZWcocywgbWgsIGRlc2MsIGJ5dGVzKVxuXHR7XG5cdFx0cy5yZWdudW0gPSBieXRlcy5yZWFkVW5zaWduZWRTaG9ydCgpO1xuXHRcdHMuaW5kZXhvZmZzZXQgPSBieXRlcy5yZWFkQnl0ZSgpO1xuXHRcdHMuc3dpenpsZSA9IGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcblx0XHRzLnJlZ3R5cGUgPSBieXRlcy5yZWFkVW5zaWduZWRCeXRlKCk7XG5cdFx0ZGVzYy5yZWdyZWFkW3MucmVndHlwZV1bcy5yZWdudW1dID0gMHhmOyAvLyBzb3VsZCBiZSBzd2l6emxlIHRvIG1hc2s/IHNob3VsZCBiZSB8PSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblx0XHRpZiAocy5yZWd0eXBlID09IDB4NSkge1xuXHRcdFx0Ly8gc2FtcGxlclxuXHRcdFx0cy5sb2RiaWFkID0gcy5pbmRleG9mZnNldDtcblx0XHRcdHMuaW5kZXhvZmZzZXQgPSB1bmRlZmluZWQ7XG5cdFx0XHRzLnN3aXp6bGUgPSB1bmRlZmluZWQ7XG5cblx0XHRcdC8vIHNhbXBsZXIgXG5cdFx0XHRzLnJlYWRtb2RlID0gYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpO1xuXHRcdFx0cy5kaW0gPSBzLnJlYWRtb2RlID4+IDQ7XG5cdFx0XHRzLnJlYWRtb2RlICY9IDB4Zjtcblx0XHRcdHMuc3BlY2lhbCA9IGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcblx0XHRcdHMud3JhcCA9IHMuc3BlY2lhbCA+PiA0O1xuXHRcdFx0cy5zcGVjaWFsICY9IDB4Zjtcblx0XHRcdHMubWlwbWFwID0gYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpO1xuXHRcdFx0cy5maWx0ZXIgPSBzLm1pcG1hcCA+PiA0O1xuXHRcdFx0cy5taXBtYXAgJj0gMHhmO1xuXHRcdFx0ZGVzYy5zYW1wbGVyc1tzLnJlZ251bV0gPSBzO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRzLmluZGV4cmVndHlwZSA9IGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcblx0XHRcdHMuaW5kZXhzZWxlY3QgPSBieXRlcy5yZWFkVW5zaWduZWRCeXRlKCk7XG5cdFx0XHRzLmluZGlyZWN0ZmxhZyA9IGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcblx0XHR9XG5cdFx0aWYgKHMuaW5kaXJlY3RmbGFnKSB7XG5cdFx0XHRkZXNjLmhhc2luZGlyZWN0ID0gdHJ1ZTtcblx0XHR9XG5cdFx0aWYgKCFzLmluZGlyZWN0ZmxhZyAmJiBtaCkge1xuXHRcdFx0Zm9yICh2YXIgbWhpOm51bWJlciA9IDA7IG1oaSA8IG1oOyBtaGkrKykgLy9UT0RPIHdyb25nLCBzaG91bGQgYmUgfD1cblx0XHRcdHtcblx0XHRcdFx0ZGVzYy5yZWdyZWFkW3MucmVndHlwZV1bcy5yZWdudW0gKyBtaGldID0gZGVzYy5yZWdyZWFkW3MucmVndHlwZV1bcy5yZWdudW1dO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxufVxuXG5leHBvcnQgPSBBR0FMVG9rZW5pemVyOyJdfQ==