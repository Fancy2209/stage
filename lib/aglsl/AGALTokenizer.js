var Description = require("awayjs-stagegl/lib/aglsl/Description");
var Header = require("awayjs-stagegl/lib/aglsl/Header");
var Mapping = require("awayjs-stagegl/lib/aglsl/Mapping");
var Token = require("awayjs-stagegl/lib/aglsl/Token");
var AGALTokenizer = (function () {
    function AGALTokenizer() {
    }
    AGALTokenizer.prototype.decribeAGALByteArray = function (bytes) {
        var header = new Header();
        if (bytes.readUnsignedByte() != 0xa0) {
            throw "Bad AGAL: Missing 0xa0 magic byte.";
        }
        header.version = bytes.readUnsignedInt();
        if (header.version >= 0x10) {
            bytes.readUnsignedByte();
            header.version >>= 1;
        }
        if (bytes.readUnsignedByte() != 0xa1) {
            throw "Bad AGAL: Missing 0xa1 magic byte.";
        }
        header.progid = bytes.readUnsignedByte();
        switch (header.progid) {
            case 1:
                header.type = "fragment";
                break;
            case 0:
                header.type = "vertex";
                break;
            case 2:
                header.type = "cpu";
                break;
            default:
                header.type = "";
                break;
        }
        var desc = new Description();
        var tokens = [];
        while (bytes.position < bytes.length) {
            var token = new Token();
            token.opcode = bytes.readUnsignedInt();
            var lutentry = Mapping.agal2glsllut[token.opcode];
            if (!lutentry) {
                throw "Opcode not valid or not implemented yet: " + token.opcode;
            }
            if (lutentry.matrixheight) {
                desc.hasmatrix = true;
            }
            if (lutentry.dest) {
                token.dest.regnum = bytes.readUnsignedShort();
                token.dest.mask = bytes.readUnsignedByte();
                token.dest.regtype = bytes.readUnsignedByte();
                desc.regwrite[token.dest.regtype][token.dest.regnum] |= token.dest.mask;
            }
            else {
                token.dest = null;
                bytes.readUnsignedInt();
            }
            if (lutentry.a) {
                this.readReg(token.a, 1, desc, bytes);
            }
            else {
                token.a = null;
                bytes.readUnsignedInt();
                bytes.readUnsignedInt();
            }
            if (lutentry.b) {
                this.readReg(token.b, lutentry.matrixheight | 0, desc, bytes);
            }
            else {
                token.b = null;
                bytes.readUnsignedInt();
                bytes.readUnsignedInt();
            }
            tokens.push(token);
        }
        desc.header = header;
        desc.tokens = tokens;
        return desc;
    };
    AGALTokenizer.prototype.readReg = function (s, mh, desc, bytes) {
        s.regnum = bytes.readUnsignedShort();
        s.indexoffset = bytes.readByte();
        s.swizzle = bytes.readUnsignedByte();
        s.regtype = bytes.readUnsignedByte();
        desc.regread[s.regtype][s.regnum] = 0xf; // sould be swizzle to mask? should be |=                                                 
        if (s.regtype == 0x5) {
            // sampler
            s.lodbiad = s.indexoffset;
            s.indexoffset = undefined;
            s.swizzle = undefined;
            // sampler 
            s.readmode = bytes.readUnsignedByte();
            s.dim = s.readmode >> 4;
            s.readmode &= 0xf;
            s.special = bytes.readUnsignedByte();
            s.wrap = s.special >> 4;
            s.special &= 0xf;
            s.mipmap = bytes.readUnsignedByte();
            s.filter = s.mipmap >> 4;
            s.mipmap &= 0xf;
            desc.samplers[s.regnum] = s;
        }
        else {
            s.indexregtype = bytes.readUnsignedByte();
            s.indexselect = bytes.readUnsignedByte();
            s.indirectflag = bytes.readUnsignedByte();
        }
        if (s.indirectflag) {
            desc.hasindirect = true;
        }
        if (!s.indirectflag && mh) {
            for (var mhi = 0; mhi < mh; mhi++) {
                desc.regread[s.regtype][s.regnum + mhi] = desc.regread[s.regtype][s.regnum];
            }
        }
    };
    return AGALTokenizer;
})();
module.exports = AGALTokenizer;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1zdGFnZWdsL2xpYi9hZ2xzbC9hZ2FsdG9rZW5pemVyLnRzIl0sIm5hbWVzIjpbIkFHQUxUb2tlbml6ZXIiLCJBR0FMVG9rZW5pemVyLmNvbnN0cnVjdG9yIiwiQUdBTFRva2VuaXplci5kZWNyaWJlQUdBTEJ5dGVBcnJheSIsIkFHQUxUb2tlbml6ZXIucmVhZFJlZyJdLCJtYXBwaW5ncyI6IkFBRUEsSUFBTyxXQUFXLFdBQWMsc0NBQXNDLENBQUMsQ0FBQztBQUN4RSxJQUFPLE1BQU0sV0FBZSxpQ0FBaUMsQ0FBQyxDQUFDO0FBQy9ELElBQU8sT0FBTyxXQUFlLGtDQUFrQyxDQUFDLENBQUM7QUFDakUsSUFBTyxLQUFLLFdBQWUsZ0NBQWdDLENBQUMsQ0FBQztBQUU3RCxJQUFNLGFBQWE7SUFFbEJBLFNBRktBLGFBQWFBO0lBSWxCQyxDQUFDQTtJQUVNRCw0Q0FBb0JBLEdBQTNCQSxVQUE0QkEsS0FBZUE7UUFFMUNFLElBQUlBLE1BQU1BLEdBQVVBLElBQUlBLE1BQU1BLEVBQUVBLENBQUNBO1FBRWpDQSxFQUFFQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLElBQUlBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO1lBQ3RDQSxNQUFNQSxvQ0FBb0NBLENBQUNBO1FBQzVDQSxDQUFDQTtRQUVEQSxNQUFNQSxDQUFDQSxPQUFPQSxHQUFHQSxLQUFLQSxDQUFDQSxlQUFlQSxFQUFFQSxDQUFDQTtRQUN6Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsT0FBT0EsSUFBSUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDNUJBLEtBQUtBLENBQUNBLGdCQUFnQkEsRUFBRUEsQ0FBQ0E7WUFDekJBLE1BQU1BLENBQUNBLE9BQU9BLEtBQUtBLENBQUNBLENBQUNBO1FBQ3RCQSxDQUFDQTtRQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLElBQUlBLElBQUlBLENBQUNBLENBQUNB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QSxDQUFDQSxDQUFDQSxNQUFNQSxHQUFHQSxDQUFDQSxDQUFDQSxNQUFNQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUN6QkEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsSUFBSUEsR0FBR0EsQ0FBQ0E7WUFDaEJBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBQzdCQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNQQSxDQUFDQSxDQUFDQSxZQUFZQSxHQUFHQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLENBQUNBO1lBQzFDQSxDQUFDQSxDQUFDQSxXQUFXQSxHQUFHQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLENBQUNBO1lBQ3pDQSxDQUFDQSxDQUFDQSxZQUFZQSxHQUFHQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLENBQUNBO1FBQzNDQSxDQUFDQTtRQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNwQkEsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFDekJBLENBQUNBO1FBQ0RBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLFlBQVlBLElBQUlBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBQzNCQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxHQUFVQSxDQUFDQSxFQUFFQSxHQUFHQSxHQUFHQSxFQUFFQSxFQUFFQSxHQUFHQSxFQUFFQSxFQUN4Q0EsQ0FBQ0E7Z0JBQ0FBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLEdBQUdBLEdBQUdBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1lBQzdFQSxDQUFDQTtRQUNGQSxDQUFDQTtJQUNGQSxDQUFDQTtJQUNGSCxvQkFBQ0E7QUFBREEsQ0ExSEEsQUEwSENBLElBQUE7QUFFRCxBQUF1QixpQkFBZCxhQUFhLENBQUMiLCJmaWxlIjoiYWdsc2wvQUdBTFRva2VuaXplci5qcyIsInNvdXJjZVJvb3QiOiIuLi8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQnl0ZUFycmF5XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdXRpbHMvQnl0ZUFycmF5XCIpO1xuXG5pbXBvcnQgRGVzY3JpcHRpb25cdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9hZ2xzbC9EZXNjcmlwdGlvblwiKTtcbmltcG9ydCBIZWFkZXJcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2FnbHNsL0hlYWRlclwiKTtcbmltcG9ydCBNYXBwaW5nXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9hZ2xzbC9NYXBwaW5nXCIpO1xuaW1wb3J0IFRva2VuXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9hZ2xzbC9Ub2tlblwiKTtcblxuY2xhc3MgQUdBTFRva2VuaXplclxue1xuXHRjb25zdHJ1Y3RvcigpXG5cdHtcblx0fVxuXG5cdHB1YmxpYyBkZWNyaWJlQUdBTEJ5dGVBcnJheShieXRlczpCeXRlQXJyYXkpXG5cdHtcblx0XHR2YXIgaGVhZGVyOkhlYWRlciA9IG5ldyBIZWFkZXIoKTtcblxuXHRcdGlmIChieXRlcy5yZWFkVW5zaWduZWRCeXRlKCkgIT0gMHhhMCkge1xuXHRcdFx0dGhyb3cgXCJCYWQgQUdBTDogTWlzc2luZyAweGEwIG1hZ2ljIGJ5dGUuXCI7XG5cdFx0fVxuXG5cdFx0aGVhZGVyLnZlcnNpb24gPSBieXRlcy5yZWFkVW5zaWduZWRJbnQoKTtcblx0XHRpZiAoaGVhZGVyLnZlcnNpb24gPj0gMHgxMCkge1xuXHRcdFx0Ynl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpO1xuXHRcdFx0aGVhZGVyLnZlcnNpb24gPj49IDE7XG5cdFx0fVxuXHRcdGlmIChieXRlcy5yZWFkVW5zaWduZWRCeXRlKCkgIT0gMHhhMSkge1xuXHRcdFx0dGhyb3cgXCJCYWQgQUdBTDogTWlzc2luZyAweGExIG1hZ2ljIGJ5dGUuXCI7XG5cdFx0fVxuXG5cdFx0aGVhZGVyLnByb2dpZCA9IGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcblx0XHRzd2l0Y2ggKGhlYWRlci5wcm9naWQpIHtcblx0XHRcdGNhc2UgMTpcblx0XHRcdFx0aGVhZGVyLnR5cGUgPSBcImZyYWdtZW50XCI7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSAwOlxuXHRcdFx0XHRoZWFkZXIudHlwZSA9IFwidmVydGV4XCI7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSAyOlxuXHRcdFx0XHRoZWFkZXIudHlwZSA9IFwiY3B1XCI7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0aGVhZGVyLnR5cGUgPSBcIlwiO1xuXHRcdFx0XHRicmVhaztcblx0XHR9XG5cblx0XHR2YXIgZGVzYzpEZXNjcmlwdGlvbiA9IG5ldyBEZXNjcmlwdGlvbigpO1xuXHRcdHZhciB0b2tlbnM6VG9rZW5bXSA9IFtdO1xuXHRcdHdoaWxlIChieXRlcy5wb3NpdGlvbiA8IGJ5dGVzLmxlbmd0aCkge1xuXHRcdFx0dmFyIHRva2VuOlRva2VuID0gbmV3IFRva2VuKCk7XG5cblx0XHRcdHRva2VuLm9wY29kZSA9IGJ5dGVzLnJlYWRVbnNpZ25lZEludCgpO1xuXHRcdFx0dmFyIGx1dGVudHJ5ID0gTWFwcGluZy5hZ2FsMmdsc2xsdXRbdG9rZW4ub3Bjb2RlXTtcblx0XHRcdGlmICghbHV0ZW50cnkpIHtcblx0XHRcdFx0dGhyb3cgXCJPcGNvZGUgbm90IHZhbGlkIG9yIG5vdCBpbXBsZW1lbnRlZCB5ZXQ6IFwiICsgdG9rZW4ub3Bjb2RlO1xuXHRcdFx0fVxuXHRcdFx0aWYgKGx1dGVudHJ5Lm1hdHJpeGhlaWdodCkge1xuXHRcdFx0XHRkZXNjLmhhc21hdHJpeCA9IHRydWU7XG5cdFx0XHR9XG5cdFx0XHRpZiAobHV0ZW50cnkuZGVzdCkge1xuXHRcdFx0XHR0b2tlbi5kZXN0LnJlZ251bSA9IGJ5dGVzLnJlYWRVbnNpZ25lZFNob3J0KCk7XG5cdFx0XHRcdHRva2VuLmRlc3QubWFzayA9IGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcblx0XHRcdFx0dG9rZW4uZGVzdC5yZWd0eXBlID0gYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpO1xuXHRcdFx0XHRkZXNjLnJlZ3dyaXRlW3Rva2VuLmRlc3QucmVndHlwZV1bdG9rZW4uZGVzdC5yZWdudW1dIHw9IHRva2VuLmRlc3QubWFzaztcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRva2VuLmRlc3QgPSBudWxsO1xuXHRcdFx0XHRieXRlcy5yZWFkVW5zaWduZWRJbnQoKTtcblx0XHRcdH1cblx0XHRcdGlmIChsdXRlbnRyeS5hKSB7XG5cdFx0XHRcdHRoaXMucmVhZFJlZyh0b2tlbi5hLCAxLCBkZXNjLCBieXRlcyk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0b2tlbi5hID0gbnVsbDtcblx0XHRcdFx0Ynl0ZXMucmVhZFVuc2lnbmVkSW50KCk7XG5cdFx0XHRcdGJ5dGVzLnJlYWRVbnNpZ25lZEludCgpO1xuXHRcdFx0fVxuXHRcdFx0aWYgKGx1dGVudHJ5LmIpIHtcblx0XHRcdFx0dGhpcy5yZWFkUmVnKHRva2VuLmIsIGx1dGVudHJ5Lm1hdHJpeGhlaWdodCB8IDAsIGRlc2MsIGJ5dGVzKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRva2VuLmIgPSBudWxsO1xuXHRcdFx0XHRieXRlcy5yZWFkVW5zaWduZWRJbnQoKTtcblx0XHRcdFx0Ynl0ZXMucmVhZFVuc2lnbmVkSW50KCk7XG5cdFx0XHR9XG5cdFx0XHR0b2tlbnMucHVzaCh0b2tlbik7XG5cdFx0fVxuXHRcdGRlc2MuaGVhZGVyID0gaGVhZGVyO1xuXHRcdGRlc2MudG9rZW5zID0gdG9rZW5zO1xuXG5cdFx0cmV0dXJuIGRlc2M7XG5cdH1cblxuXHRwdWJsaWMgcmVhZFJlZyhzLCBtaCwgZGVzYywgYnl0ZXMpXG5cdHtcblx0XHRzLnJlZ251bSA9IGJ5dGVzLnJlYWRVbnNpZ25lZFNob3J0KCk7XG5cdFx0cy5pbmRleG9mZnNldCA9IGJ5dGVzLnJlYWRCeXRlKCk7XG5cdFx0cy5zd2l6emxlID0gYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpO1xuXHRcdHMucmVndHlwZSA9IGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcblx0XHRkZXNjLnJlZ3JlYWRbcy5yZWd0eXBlXVtzLnJlZ251bV0gPSAweGY7IC8vIHNvdWxkIGJlIHN3aXp6bGUgdG8gbWFzaz8gc2hvdWxkIGJlIHw9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXHRcdGlmIChzLnJlZ3R5cGUgPT0gMHg1KSB7XG5cdFx0XHQvLyBzYW1wbGVyXG5cdFx0XHRzLmxvZGJpYWQgPSBzLmluZGV4b2Zmc2V0O1xuXHRcdFx0cy5pbmRleG9mZnNldCA9IHVuZGVmaW5lZDtcblx0XHRcdHMuc3dpenpsZSA9IHVuZGVmaW5lZDtcblxuXHRcdFx0Ly8gc2FtcGxlciBcblx0XHRcdHMucmVhZG1vZGUgPSBieXRlcy5yZWFkVW5zaWduZWRCeXRlKCk7XG5cdFx0XHRzLmRpbSA9IHMucmVhZG1vZGUgPj4gNDtcblx0XHRcdHMucmVhZG1vZGUgJj0gMHhmO1xuXHRcdFx0cy5zcGVjaWFsID0gYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpO1xuXHRcdFx0cy53cmFwID0gcy5zcGVjaWFsID4+IDQ7XG5cdFx0XHRzLnNwZWNpYWwgJj0gMHhmO1xuXHRcdFx0cy5taXBtYXAgPSBieXRlcy5yZWFkVW5zaWduZWRCeXRlKCk7XG5cdFx0XHRzLmZpbHRlciA9IHMubWlwbWFwID4+IDQ7XG5cdFx0XHRzLm1pcG1hcCAmPSAweGY7XG5cdFx0XHRkZXNjLnNhbXBsZXJzW3MucmVnbnVtXSA9IHM7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHMuaW5kZXhyZWd0eXBlID0gYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpO1xuXHRcdFx0cy5pbmRleHNlbGVjdCA9IGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcblx0XHRcdHMuaW5kaXJlY3RmbGFnID0gYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpO1xuXHRcdH1cblx0XHRpZiAocy5pbmRpcmVjdGZsYWcpIHtcblx0XHRcdGRlc2MuaGFzaW5kaXJlY3QgPSB0cnVlO1xuXHRcdH1cblx0XHRpZiAoIXMuaW5kaXJlY3RmbGFnICYmIG1oKSB7XG5cdFx0XHRmb3IgKHZhciBtaGk6bnVtYmVyID0gMDsgbWhpIDwgbWg7IG1oaSsrKSAvL1RPRE8gd3JvbmcsIHNob3VsZCBiZSB8PVxuXHRcdFx0e1xuXHRcdFx0XHRkZXNjLnJlZ3JlYWRbcy5yZWd0eXBlXVtzLnJlZ251bSArIG1oaV0gPSBkZXNjLnJlZ3JlYWRbcy5yZWd0eXBlXVtzLnJlZ251bV07XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCA9IEFHQUxUb2tlbml6ZXI7Il19