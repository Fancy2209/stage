var Description = require("awayjs-stagegl/lib/aglsl/Description");
var Header = require("awayjs-stagegl/lib/aglsl/Header");
var Mapping = require("awayjs-stagegl/lib/aglsl/Mapping");
var Token = require("awayjs-stagegl/lib/aglsl/Token");
var AGALTokenizer = (function () {
    function AGALTokenizer() {
    }
    AGALTokenizer.prototype.decribeAGALByteArray = function (bytes) {
        var header = new Header();
        if (bytes.readUnsignedByte() != 0xa0) {
            throw "Bad AGAL: Missing 0xa0 magic byte.";
        }
        header.version = bytes.readUnsignedInt();
        if (header.version >= 0x10) {
            bytes.readUnsignedByte();
            header.version >>= 1;
        }
        if (bytes.readUnsignedByte() != 0xa1) {
            throw "Bad AGAL: Missing 0xa1 magic byte.";
        }
        header.progid = bytes.readUnsignedByte();
        switch (header.progid) {
            case 1:
                header.type = "fragment";
                break;
            case 0:
                header.type = "vertex";
                break;
            case 2:
                header.type = "cpu";
                break;
            default:
                header.type = "";
                break;
        }
        var desc = new Description();
        var tokens = [];
        while (bytes.position < bytes.length) {
            var token = new Token();
            token.opcode = bytes.readUnsignedInt();
            var lutentry = Mapping.agal2glsllut[token.opcode];
            if (!lutentry) {
                throw "Opcode not valid or not implemented yet: " + token.opcode;
            }
            if (lutentry.matrixheight) {
                desc.hasmatrix = true;
            }
            if (lutentry.dest) {
                token.dest.regnum = bytes.readUnsignedShort();
                token.dest.mask = bytes.readUnsignedByte();
                token.dest.regtype = bytes.readUnsignedByte();
                desc.regwrite[token.dest.regtype][token.dest.regnum] |= token.dest.mask;
            }
            else {
                token.dest = null;
                bytes.readUnsignedInt();
            }
            if (lutentry.a) {
                this.readReg(token.a, 1, desc, bytes);
            }
            else {
                token.a = null;
                bytes.readUnsignedInt();
                bytes.readUnsignedInt();
            }
            if (lutentry.b) {
                this.readReg(token.b, lutentry.matrixheight | 0, desc, bytes);
            }
            else {
                token.b = null;
                bytes.readUnsignedInt();
                bytes.readUnsignedInt();
            }
            tokens.push(token);
        }
        desc.header = header;
        desc.tokens = tokens;
        return desc;
    };
    AGALTokenizer.prototype.readReg = function (s, mh, desc, bytes) {
        s.regnum = bytes.readUnsignedShort();
        s.indexoffset = bytes.readByte();
        s.swizzle = bytes.readUnsignedByte();
        s.regtype = bytes.readUnsignedByte();
        desc.regread[s.regtype][s.regnum] = 0xf; // sould be swizzle to mask? should be |=                                                 
        if (s.regtype == 0x5) {
            // sampler
            s.lodbiad = s.indexoffset;
            s.indexoffset = undefined;
            s.swizzle = undefined;
            // sampler 
            s.readmode = bytes.readUnsignedByte();
            s.dim = s.readmode >> 4;
            s.readmode &= 0xf;
            s.special = bytes.readUnsignedByte();
            s.wrap = s.special >> 4;
            s.special &= 0xf;
            s.mipmap = bytes.readUnsignedByte();
            s.filter = s.mipmap >> 4;
            s.mipmap &= 0xf;
            desc.samplers[s.regnum] = s;
        }
        else {
            s.indexregtype = bytes.readUnsignedByte();
            s.indexselect = bytes.readUnsignedByte();
            s.indirectflag = bytes.readUnsignedByte();
        }
        if (s.indirectflag) {
            desc.hasindirect = true;
        }
        if (!s.indirectflag && mh) {
            for (var mhi = 0; mhi < mh; mhi++) {
                desc.regread[s.regtype][s.regnum + mhi] = desc.regread[s.regtype][s.regnum];
            }
        }
    };
    return AGALTokenizer;
})();
module.exports = AGALTokenizer;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1zdGFnZWdsL2xpYi9hZ2xzbC9BR0FMVG9rZW5pemVyLnRzIl0sIm5hbWVzIjpbIkFHQUxUb2tlbml6ZXIiLCJBR0FMVG9rZW5pemVyLmNvbnN0cnVjdG9yIiwiQUdBTFRva2VuaXplci5kZWNyaWJlQUdBTEJ5dGVBcnJheSIsIkFHQUxUb2tlbml6ZXIucmVhZFJlZyJdLCJtYXBwaW5ncyI6IkFBRUEsSUFBTyxXQUFXLFdBQWMsc0NBQXNDLENBQUMsQ0FBQztBQUN4RSxJQUFPLE1BQU0sV0FBZSxpQ0FBaUMsQ0FBQyxDQUFDO0FBQy9ELElBQU8sT0FBTyxXQUFlLGtDQUFrQyxDQUFDLENBQUM7QUFDakUsSUFBTyxLQUFLLFdBQWUsZ0NBQWdDLENBQUMsQ0FBQztBQUU3RCxJQUFNLGFBQWE7SUFFbEJBLFNBRktBLGFBQWFBO0lBSWxCQyxDQUFDQTtJQUVNRCw0Q0FBb0JBLEdBQTNCQSxVQUE0QkEsS0FBZUE7UUFFMUNFLElBQUlBLE1BQU1BLEdBQVVBLElBQUlBLE1BQU1BLEVBQUVBLENBQUNBO1FBRWpDQSxFQUFFQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLElBQUlBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO1lBQ3RDQSxNQUFNQSxvQ0FBb0NBLENBQUNBO1FBQzVDQSxDQUFDQTtRQUVEQSxNQUFNQSxDQUFDQSxPQUFPQSxHQUFHQSxLQUFLQSxDQUFDQSxlQUFlQSxFQUFFQSxDQUFDQTtRQUN6Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsT0FBT0EsSUFBSUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDNUJBLEtBQUtBLENBQUNBLGdCQUFnQkEsRUFBRUEsQ0FBQ0E7WUFDekJBLE1BQU1BLENBQUNBLE9BQU9BLEtBQUtBLENBQUNBLENBQUNBO1FBQ3RCQSxDQUFDQTtRQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLElBQUlBLElBQUlBLENBQUNBLENBQUNB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QSxDQUFDQSxDQUFDQSxNQUFNQSxHQUFHQSxDQUFDQSxDQUFDQSxNQUFNQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUN6QkEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsSUFBSUEsR0FBR0EsQ0FBQ0E7WUFDaEJBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBQzdCQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNQQSxDQUFDQSxDQUFDQSxZQUFZQSxHQUFHQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLENBQUNBO1lBQzFDQSxDQUFDQSxDQUFDQSxXQUFXQSxHQUFHQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLENBQUNBO1lBQ3pDQSxDQUFDQSxDQUFDQSxZQUFZQSxHQUFHQSxLQUFLQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLENBQUNBO1FBQzNDQSxDQUFDQTtRQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNwQkEsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFDekJBLENBQUNBO1FBQ0RBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLFlBQVlBLElBQUlBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBQzNCQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxHQUFVQSxDQUFDQSxFQUFFQSxHQUFHQSxHQUFHQSxFQUFFQSxFQUFFQSxHQUFHQSxFQUFFQSxFQUN4Q0EsQ0FBQ0E7Z0JBQ0FBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLEdBQUdBLEdBQUdBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1lBQzdFQSxDQUFDQTtRQUNGQSxDQUFDQTtJQUNGQSxDQUFDQTtJQUNGSCxvQkFBQ0E7QUFBREEsQ0ExSEEsQUEwSENBLElBQUE7QUFFRCxBQUF1QixpQkFBZCxhQUFhLENBQUMiLCJmaWxlIjoiYWdsc2wvQUdBTFRva2VuaXplci5qcyIsInNvdXJjZVJvb3QiOiIuLi8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQnl0ZUFycmF5XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvdXRpbHMvQnl0ZUFycmF5XCIpO1xyXG5cclxuaW1wb3J0IERlc2NyaXB0aW9uXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYWdsc2wvRGVzY3JpcHRpb25cIik7XHJcbmltcG9ydCBIZWFkZXJcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2FnbHNsL0hlYWRlclwiKTtcclxuaW1wb3J0IE1hcHBpbmdcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2FnbHNsL01hcHBpbmdcIik7XHJcbmltcG9ydCBUb2tlblx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYWdsc2wvVG9rZW5cIik7XHJcblxyXG5jbGFzcyBBR0FMVG9rZW5pemVyXHJcbntcclxuXHRjb25zdHJ1Y3RvcigpXHJcblx0e1xyXG5cdH1cclxuXHJcblx0cHVibGljIGRlY3JpYmVBR0FMQnl0ZUFycmF5KGJ5dGVzOkJ5dGVBcnJheSlcclxuXHR7XHJcblx0XHR2YXIgaGVhZGVyOkhlYWRlciA9IG5ldyBIZWFkZXIoKTtcclxuXHJcblx0XHRpZiAoYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpICE9IDB4YTApIHtcclxuXHRcdFx0dGhyb3cgXCJCYWQgQUdBTDogTWlzc2luZyAweGEwIG1hZ2ljIGJ5dGUuXCI7XHJcblx0XHR9XHJcblxyXG5cdFx0aGVhZGVyLnZlcnNpb24gPSBieXRlcy5yZWFkVW5zaWduZWRJbnQoKTtcclxuXHRcdGlmIChoZWFkZXIudmVyc2lvbiA+PSAweDEwKSB7XHJcblx0XHRcdGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcclxuXHRcdFx0aGVhZGVyLnZlcnNpb24gPj49IDE7XHJcblx0XHR9XHJcblx0XHRpZiAoYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpICE9IDB4YTEpIHtcclxuXHRcdFx0dGhyb3cgXCJCYWQgQUdBTDogTWlzc2luZyAweGExIG1hZ2ljIGJ5dGUuXCI7XHJcblx0XHR9XHJcblxyXG5cdFx0aGVhZGVyLnByb2dpZCA9IGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcclxuXHRcdHN3aXRjaCAoaGVhZGVyLnByb2dpZCkge1xyXG5cdFx0XHRjYXNlIDE6XHJcblx0XHRcdFx0aGVhZGVyLnR5cGUgPSBcImZyYWdtZW50XCI7XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdGNhc2UgMDpcclxuXHRcdFx0XHRoZWFkZXIudHlwZSA9IFwidmVydGV4XCI7XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdGNhc2UgMjpcclxuXHRcdFx0XHRoZWFkZXIudHlwZSA9IFwiY3B1XCI7XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdGRlZmF1bHQ6XHJcblx0XHRcdFx0aGVhZGVyLnR5cGUgPSBcIlwiO1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0fVxyXG5cclxuXHRcdHZhciBkZXNjOkRlc2NyaXB0aW9uID0gbmV3IERlc2NyaXB0aW9uKCk7XHJcblx0XHR2YXIgdG9rZW5zOlRva2VuW10gPSBbXTtcclxuXHRcdHdoaWxlIChieXRlcy5wb3NpdGlvbiA8IGJ5dGVzLmxlbmd0aCkge1xyXG5cdFx0XHR2YXIgdG9rZW46VG9rZW4gPSBuZXcgVG9rZW4oKTtcclxuXHJcblx0XHRcdHRva2VuLm9wY29kZSA9IGJ5dGVzLnJlYWRVbnNpZ25lZEludCgpO1xyXG5cdFx0XHR2YXIgbHV0ZW50cnkgPSBNYXBwaW5nLmFnYWwyZ2xzbGx1dFt0b2tlbi5vcGNvZGVdO1xyXG5cdFx0XHRpZiAoIWx1dGVudHJ5KSB7XHJcblx0XHRcdFx0dGhyb3cgXCJPcGNvZGUgbm90IHZhbGlkIG9yIG5vdCBpbXBsZW1lbnRlZCB5ZXQ6IFwiICsgdG9rZW4ub3Bjb2RlO1xyXG5cdFx0XHR9XHJcblx0XHRcdGlmIChsdXRlbnRyeS5tYXRyaXhoZWlnaHQpIHtcclxuXHRcdFx0XHRkZXNjLmhhc21hdHJpeCA9IHRydWU7XHJcblx0XHRcdH1cclxuXHRcdFx0aWYgKGx1dGVudHJ5LmRlc3QpIHtcclxuXHRcdFx0XHR0b2tlbi5kZXN0LnJlZ251bSA9IGJ5dGVzLnJlYWRVbnNpZ25lZFNob3J0KCk7XHJcblx0XHRcdFx0dG9rZW4uZGVzdC5tYXNrID0gYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpO1xyXG5cdFx0XHRcdHRva2VuLmRlc3QucmVndHlwZSA9IGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcclxuXHRcdFx0XHRkZXNjLnJlZ3dyaXRlW3Rva2VuLmRlc3QucmVndHlwZV1bdG9rZW4uZGVzdC5yZWdudW1dIHw9IHRva2VuLmRlc3QubWFzaztcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHR0b2tlbi5kZXN0ID0gbnVsbDtcclxuXHRcdFx0XHRieXRlcy5yZWFkVW5zaWduZWRJbnQoKTtcclxuXHRcdFx0fVxyXG5cdFx0XHRpZiAobHV0ZW50cnkuYSkge1xyXG5cdFx0XHRcdHRoaXMucmVhZFJlZyh0b2tlbi5hLCAxLCBkZXNjLCBieXRlcyk7XHJcblx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0dG9rZW4uYSA9IG51bGw7XHJcblx0XHRcdFx0Ynl0ZXMucmVhZFVuc2lnbmVkSW50KCk7XHJcblx0XHRcdFx0Ynl0ZXMucmVhZFVuc2lnbmVkSW50KCk7XHJcblx0XHRcdH1cclxuXHRcdFx0aWYgKGx1dGVudHJ5LmIpIHtcclxuXHRcdFx0XHR0aGlzLnJlYWRSZWcodG9rZW4uYiwgbHV0ZW50cnkubWF0cml4aGVpZ2h0IHwgMCwgZGVzYywgYnl0ZXMpO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdHRva2VuLmIgPSBudWxsO1xyXG5cdFx0XHRcdGJ5dGVzLnJlYWRVbnNpZ25lZEludCgpO1xyXG5cdFx0XHRcdGJ5dGVzLnJlYWRVbnNpZ25lZEludCgpO1xyXG5cdFx0XHR9XHJcblx0XHRcdHRva2Vucy5wdXNoKHRva2VuKTtcclxuXHRcdH1cclxuXHRcdGRlc2MuaGVhZGVyID0gaGVhZGVyO1xyXG5cdFx0ZGVzYy50b2tlbnMgPSB0b2tlbnM7XHJcblxyXG5cdFx0cmV0dXJuIGRlc2M7XHJcblx0fVxyXG5cclxuXHRwdWJsaWMgcmVhZFJlZyhzLCBtaCwgZGVzYywgYnl0ZXMpXHJcblx0e1xyXG5cdFx0cy5yZWdudW0gPSBieXRlcy5yZWFkVW5zaWduZWRTaG9ydCgpO1xyXG5cdFx0cy5pbmRleG9mZnNldCA9IGJ5dGVzLnJlYWRCeXRlKCk7XHJcblx0XHRzLnN3aXp6bGUgPSBieXRlcy5yZWFkVW5zaWduZWRCeXRlKCk7XHJcblx0XHRzLnJlZ3R5cGUgPSBieXRlcy5yZWFkVW5zaWduZWRCeXRlKCk7XHJcblx0XHRkZXNjLnJlZ3JlYWRbcy5yZWd0eXBlXVtzLnJlZ251bV0gPSAweGY7IC8vIHNvdWxkIGJlIHN3aXp6bGUgdG8gbWFzaz8gc2hvdWxkIGJlIHw9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxyXG5cdFx0aWYgKHMucmVndHlwZSA9PSAweDUpIHtcclxuXHRcdFx0Ly8gc2FtcGxlclxyXG5cdFx0XHRzLmxvZGJpYWQgPSBzLmluZGV4b2Zmc2V0O1xyXG5cdFx0XHRzLmluZGV4b2Zmc2V0ID0gdW5kZWZpbmVkO1xyXG5cdFx0XHRzLnN3aXp6bGUgPSB1bmRlZmluZWQ7XHJcblxyXG5cdFx0XHQvLyBzYW1wbGVyIFxyXG5cdFx0XHRzLnJlYWRtb2RlID0gYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpO1xyXG5cdFx0XHRzLmRpbSA9IHMucmVhZG1vZGUgPj4gNDtcclxuXHRcdFx0cy5yZWFkbW9kZSAmPSAweGY7XHJcblx0XHRcdHMuc3BlY2lhbCA9IGJ5dGVzLnJlYWRVbnNpZ25lZEJ5dGUoKTtcclxuXHRcdFx0cy53cmFwID0gcy5zcGVjaWFsID4+IDQ7XHJcblx0XHRcdHMuc3BlY2lhbCAmPSAweGY7XHJcblx0XHRcdHMubWlwbWFwID0gYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpO1xyXG5cdFx0XHRzLmZpbHRlciA9IHMubWlwbWFwID4+IDQ7XHJcblx0XHRcdHMubWlwbWFwICY9IDB4ZjtcclxuXHRcdFx0ZGVzYy5zYW1wbGVyc1tzLnJlZ251bV0gPSBzO1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0cy5pbmRleHJlZ3R5cGUgPSBieXRlcy5yZWFkVW5zaWduZWRCeXRlKCk7XHJcblx0XHRcdHMuaW5kZXhzZWxlY3QgPSBieXRlcy5yZWFkVW5zaWduZWRCeXRlKCk7XHJcblx0XHRcdHMuaW5kaXJlY3RmbGFnID0gYnl0ZXMucmVhZFVuc2lnbmVkQnl0ZSgpO1xyXG5cdFx0fVxyXG5cdFx0aWYgKHMuaW5kaXJlY3RmbGFnKSB7XHJcblx0XHRcdGRlc2MuaGFzaW5kaXJlY3QgPSB0cnVlO1xyXG5cdFx0fVxyXG5cdFx0aWYgKCFzLmluZGlyZWN0ZmxhZyAmJiBtaCkge1xyXG5cdFx0XHRmb3IgKHZhciBtaGk6bnVtYmVyID0gMDsgbWhpIDwgbWg7IG1oaSsrKSAvL1RPRE8gd3JvbmcsIHNob3VsZCBiZSB8PVxyXG5cdFx0XHR7XHJcblx0XHRcdFx0ZGVzYy5yZWdyZWFkW3MucmVndHlwZV1bcy5yZWdudW0gKyBtaGldID0gZGVzYy5yZWdyZWFkW3MucmVndHlwZV1bcy5yZWdudW1dO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0fVxyXG59XHJcblxyXG5leHBvcnQgPSBBR0FMVG9rZW5pemVyOyJdfQ==