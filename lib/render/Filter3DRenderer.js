var Event = require("awayjs-core/lib/events/Event");
var ContextGLBlendFactor = require("awayjs-stagegl/lib/base/ContextGLBlendFactor");
var ContextGLVertexBufferFormat = require("awayjs-stagegl/lib/base/ContextGLVertexBufferFormat");
var RTTBufferManager = require("awayjs-stagegl/lib/managers/RTTBufferManager");
/**
 * @class away.render.Filter3DRenderer
 */
var Filter3DRenderer = (function () {
    function Filter3DRenderer(stage) {
        var _this = this;
        this._filterSizesInvalid = true;
        this._onRTTResizeDelegate = function (event) { return _this.onRTTResize(event); };
        this._stage = stage;
        this._rttManager = RTTBufferManager.getInstance(stage);
        this._rttManager.addEventListener(Event.RESIZE, this._onRTTResizeDelegate);
    }
    Filter3DRenderer.prototype.onRTTResize = function (event) {
        this._filterSizesInvalid = true;
    };
    Object.defineProperty(Filter3DRenderer.prototype, "requireDepthRender", {
        get: function () {
            return this._requireDepthRender;
        },
        enumerable: true,
        configurable: true
    });
    Filter3DRenderer.prototype.getMainInputTexture = function (stage) {
        if (this._filterTasksInvalid) {
            this.updateFilterTasks(stage);
        }
        return this._mainInputTexture;
    };
    Object.defineProperty(Filter3DRenderer.prototype, "filters", {
        get: function () {
            return this._filters;
        },
        set: function (value) {
            this._filters = value;
            this._filterTasksInvalid = true;
            this._requireDepthRender = false;
            if (!this._filters) {
                return;
            }
            for (var i = 0; i < this._filters.length; ++i) {
                // TODO: check logic:
                // this._requireDepthRender ||=  Boolean ( this._filters[i].requireDepthRender )
                var s = this._filters[i];
                var b = (s.requireDepthRender == null) ? false : s.requireDepthRender;
                this._requireDepthRender = this._requireDepthRender || b;
            }
            this._filterSizesInvalid = true;
        },
        enumerable: true,
        configurable: true
    });
    Filter3DRenderer.prototype.updateFilterTasks = function (stage) {
        var len;
        if (this._filterSizesInvalid) {
            this.updateFilterSizes();
        }
        if (!this._filters) {
            this._tasks = null;
            return;
        }
        this._tasks = new Array();
        len = this._filters.length - 1;
        var filter;
        for (var i = 0; i <= len; ++i) {
            // make sure all internal tasks are linked together
            filter = this._filters[i];
            // TODO: check logic
            // filter.setRenderTargets(i == len? null : Filter3DBase(_filters[i + 1]).getMainInputTexture(stage), stage);
            filter.setRenderTargets(i == len ? null : this._filters[i + 1].getMainInputTexture(stage), stage);
            this._tasks = this._tasks.concat(filter.tasks);
        }
        this._mainInputTexture = this._filters[0].getMainInputTexture(stage);
    };
    Filter3DRenderer.prototype.render = function (stage, camera, depthTexture) {
        var len;
        var i;
        var task;
        var context = stage.context;
        var indexBuffer = this._rttManager.indexBuffer;
        var vertexBuffer = this._rttManager.renderToTextureVertexBuffer;
        if (!this._filters) {
            return;
        }
        if (this._filterSizesInvalid) {
            this.updateFilterSizes();
        }
        if (this._filterTasksInvalid) {
            this.updateFilterTasks(stage);
        }
        len = this._filters.length;
        for (i = 0; i < len; ++i) {
            this._filters[i].update(stage, camera);
        }
        len = this._tasks.length;
        if (len > 1) {
            context.setVertexBufferAt(0, vertexBuffer, 0, ContextGLVertexBufferFormat.FLOAT_2);
            context.setVertexBufferAt(1, vertexBuffer, 2, ContextGLVertexBufferFormat.FLOAT_2);
        }
        for (i = 0; i < len; ++i) {
            task = this._tasks[i];
            //stage.setRenderTarget(task.target); //TODO
            if (!task.target) {
                stage.scissorRect = null;
                vertexBuffer = this._rttManager.renderToScreenVertexBuffer;
                context.setVertexBufferAt(0, vertexBuffer, 0, ContextGLVertexBufferFormat.FLOAT_2);
                context.setVertexBufferAt(1, vertexBuffer, 2, ContextGLVertexBufferFormat.FLOAT_2);
            }
            context.setTextureAt(0, task.getMainInputTexture(stage));
            context.setProgram(task.getProgram(stage));
            context.clear(0.0, 0.0, 0.0, 0.0);
            task.activate(stage, camera, depthTexture);
            context.setBlendFactors(ContextGLBlendFactor.ONE, ContextGLBlendFactor.ZERO);
            context.drawTriangles(indexBuffer, 0, 2);
            task.deactivate(stage);
        }
        context.setTextureAt(0, null);
        context.setVertexBufferAt(0, null);
        context.setVertexBufferAt(1, null);
    };
    Filter3DRenderer.prototype.updateFilterSizes = function () {
        for (var i = 0; i < this._filters.length; ++i) {
            this._filters[i].textureWidth = this._rttManager.textureWidth;
            this._filters[i].textureHeight = this._rttManager.textureHeight;
        }
        this._filterSizesInvalid = true;
    };
    Filter3DRenderer.prototype.dispose = function () {
        this._rttManager.removeEventListener(Event.RESIZE, this._onRTTResizeDelegate);
        this._rttManager = null;
        this._stage = null;
    };
    return Filter3DRenderer;
})();
module.exports = Filter3DRenderer;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1zdGFnZWdsL2xpYi9yZW5kZXIvZmlsdGVyM2RyZW5kZXJlci50cyJdLCJuYW1lcyI6WyJGaWx0ZXIzRFJlbmRlcmVyIiwiRmlsdGVyM0RSZW5kZXJlci5jb25zdHJ1Y3RvciIsIkZpbHRlcjNEUmVuZGVyZXIub25SVFRSZXNpemUiLCJGaWx0ZXIzRFJlbmRlcmVyLnJlcXVpcmVEZXB0aFJlbmRlciIsIkZpbHRlcjNEUmVuZGVyZXIuZ2V0TWFpbklucHV0VGV4dHVyZSIsIkZpbHRlcjNEUmVuZGVyZXIuZmlsdGVycyIsIkZpbHRlcjNEUmVuZGVyZXIudXBkYXRlRmlsdGVyVGFza3MiLCJGaWx0ZXIzRFJlbmRlcmVyLnJlbmRlciIsIkZpbHRlcjNEUmVuZGVyZXIudXBkYXRlRmlsdGVyU2l6ZXMiLCJGaWx0ZXIzRFJlbmRlcmVyLmRpc3Bvc2UiXSwibWFwcGluZ3MiOiJBQUFBLElBQU8sS0FBSyxXQUFnQiw4QkFBOEIsQ0FBQyxDQUFDO0FBSzVELElBQU8sb0JBQW9CLFdBQWEsOENBQThDLENBQUMsQ0FBQztBQUN4RixJQUFPLDJCQUEyQixXQUFXLHFEQUFxRCxDQUFDLENBQUM7QUFPcEcsSUFBTyxnQkFBZ0IsV0FBYyw4Q0FBOEMsQ0FBQyxDQUFDO0FBRXJGLEFBR0E7O0dBREc7SUFDRyxnQkFBZ0I7SUFZckJBLFNBWktBLGdCQUFnQkEsQ0FZVEEsS0FBV0E7UUFaeEJDLGlCQTBNQ0E7UUFqTVFBLHdCQUFtQkEsR0FBV0EsSUFBSUEsQ0FBQ0E7UUFLMUNBLElBQUlBLENBQUNBLG9CQUFvQkEsR0FBR0EsVUFBQ0EsS0FBV0EsSUFBS0EsT0FBQUEsS0FBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsRUFBdkJBLENBQXVCQSxDQUFDQTtRQUVyRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsS0FBS0EsQ0FBQ0E7UUFDcEJBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLGdCQUFnQkEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsS0FBS0EsQ0FBQ0Es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Q0FBQ0E7SUFFTVIsa0NBQU9BLEdBQWRBO1FBRUNTLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0Esb0JBQW9CQSxDQUFDQSxDQUFDQTtRQUM5RUEsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFDeEJBLElBQUlBLENBQUNBLE1BQU1BLEdBQUdBLElBQUlBLENBQUNBO0lBQ3BCQSxDQUFDQTtJQUNGVCx1QkFBQ0E7QUFBREEsQ0ExTUEsQUEwTUNBLElBQUE7QUFFRCxBQUEwQixpQkFBakIsZ0JBQWdCLENBQUMiLCJmaWxlIjoicmVuZGVyL0ZpbHRlcjNEUmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiLi4vIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEV2ZW50XHRcdFx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWNvcmUvbGliL2V2ZW50cy9FdmVudFwiKTtcblxuaW1wb3J0IENhbWVyYVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9DYW1lcmFcIik7XG5cbmltcG9ydCBTdGFnZVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL1N0YWdlXCIpO1xuaW1wb3J0IENvbnRleHRHTEJsZW5kRmFjdG9yXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMQmxlbmRGYWN0b3JcIik7XG5pbXBvcnQgQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9Db250ZXh0R0xWZXJ0ZXhCdWZmZXJGb3JtYXRcIik7XG5pbXBvcnQgSUNvbnRleHRTdGFnZUdMXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9JQ29udGV4dFN0YWdlR0xcIik7XG5pbXBvcnQgSUluZGV4QnVmZmVyXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL0lJbmRleEJ1ZmZlclwiKTtcbmltcG9ydCBJVGV4dHVyZVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL0lUZXh0dXJlXCIpO1xuaW1wb3J0IElWZXJ0ZXhCdWZmZXJcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL0lWZXJ0ZXhCdWZmZXJcIik7XG5pbXBvcnQgRmlsdGVyM0RCYXNlXHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9maWx0ZXJzL0ZpbHRlcjNEQmFzZVwiKTtcbmltcG9ydCBGaWx0ZXIzRFRhc2tCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvZmlsdGVycy90YXNrcy9GaWx0ZXIzRFRhc2tCYXNlXCIpO1xuaW1wb3J0IFJUVEJ1ZmZlck1hbmFnZXJcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9tYW5hZ2Vycy9SVFRCdWZmZXJNYW5hZ2VyXCIpO1xuXG4vKipcbiAqIEBjbGFzcyBhd2F5LnJlbmRlci5GaWx0ZXIzRFJlbmRlcmVyXG4gKi9cbmNsYXNzIEZpbHRlcjNEUmVuZGVyZXJcbntcblx0cHJpdmF0ZSBfZmlsdGVyczpBcnJheTxGaWx0ZXIzREJhc2U+O1xuXHRwcml2YXRlIF90YXNrczpBcnJheTxGaWx0ZXIzRFRhc2tCYXNlPjtcblx0cHJpdmF0ZSBfZmlsdGVyVGFza3NJbnZhbGlkOmJvb2xlYW47XG5cdHByaXZhdGUgX21haW5JbnB1dFRleHR1cmU6SVRleHR1cmU7XG5cdHByaXZhdGUgX3JlcXVpcmVEZXB0aFJlbmRlcjpib29sZWFuO1xuXHRwcml2YXRlIF9ydHRNYW5hZ2VyOlJUVEJ1ZmZlck1hbmFnZXI7XG5cdHByaXZhdGUgX3N0YWdlOlN0YWdlO1xuXHRwcml2YXRlIF9maWx0ZXJTaXplc0ludmFsaWQ6Ym9vbGVhbiA9IHRydWU7XG5cdHByaXZhdGUgX29uUlRUUmVzaXplRGVsZWdhdGU6KGV2ZW50OkV2ZW50KSA9PiB2b2lkO1xuXG5cdGNvbnN0cnVjdG9yKHN0YWdlOlN0YWdlKVxuXHR7XG5cdFx0dGhpcy5fb25SVFRSZXNpemVEZWxlZ2F0ZSA9IChldmVudDpFdmVudCkgPT4gdGhpcy5vblJUVFJlc2l6ZShldmVudCk7XG5cblx0XHR0aGlzLl9zdGFnZSA9IHN0YWdlO1xuXHRcdHRoaXMuX3J0dE1hbmFnZXIgPSBSVFRCdWZmZXJNYW5hZ2VyLmdldEluc3RhbmNlKHN0YWdlKTtcblx0XHR0aGlzLl9ydHRNYW5hZ2VyLmFkZEV2ZW50TGlzdGVuZXIoRXZlbnQuUkVTSVpFLCB0aGlzLl9vblJUVFJlc2l6ZURlbGVnYXRlKTtcblxuXHR9XG5cblx0cHJpdmF0ZSBvblJUVFJlc2l6ZShldmVudDpFdmVudClcblx0e1xuXHRcdHRoaXMuX2ZpbHRlclNpemVzSW52YWxpZCA9IHRydWU7XG5cdH1cblxuXHRwdWJsaWMgZ2V0IHJlcXVpcmVEZXB0aFJlbmRlcigpOmJvb2xlYW5cblx0e1xuXHRcdHJldHVybiB0aGlzLl9yZXF1aXJlRGVwdGhSZW5kZXI7XG5cdH1cblxuXHRwdWJsaWMgZ2V0TWFpbklucHV0VGV4dHVyZShzdGFnZTpTdGFnZSk6SVRleHR1cmVcblx0e1xuXHRcdGlmICh0aGlzLl9maWx0ZXJUYXNrc0ludmFsaWQpIHtcblxuXHRcdFx0dGhpcy51cGRhdGVGaWx0ZXJUYXNrcyhzdGFnZSk7XG5cblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5fbWFpbklucHV0VGV4dHVyZTtcblx0fVxuXG5cdHB1YmxpYyBnZXQgZmlsdGVycygpOkZpbHRlcjNEQmFzZVtdXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fZmlsdGVycztcblx0fVxuXG5cdHB1YmxpYyBzZXQgZmlsdGVycyh2YWx1ZTpGaWx0ZXIzREJhc2VbXSlcblx0e1xuXHRcdHRoaXMuX2ZpbHRlcnMgPSB2YWx1ZTtcblxuXHRcdHRoaXMuX2ZpbHRlclRhc2tzSW52YWxpZCA9IHRydWU7XG5cblx0XHR0aGlzLl9yZXF1aXJlRGVwdGhSZW5kZXIgPSBmYWxzZTtcblxuXHRcdGlmICghdGhpcy5fZmlsdGVycykge1xuXG5cdFx0XHRyZXR1cm47XG5cblx0XHR9XG5cblx0XHRmb3IgKHZhciBpOm51bWJlciA9IDA7IGkgPCB0aGlzLl9maWx0ZXJzLmxlbmd0aDsgKytpKSB7XG5cblx0XHRcdC8vIFRPRE86IGNoZWNrIGxvZ2ljOlxuXHRcdFx0Ly8gdGhpcy5fcmVxdWlyZURlcHRoUmVuZGVyIHx8PSAgQm9vbGVhbiAoIHRoaXMuX2ZpbHRlcnNbaV0ucmVxdWlyZURlcHRoUmVuZGVyIClcblxuXHRcdFx0dmFyIHM6YW55ID0gdGhpcy5fZmlsdGVyc1tpXTtcblx0XHRcdHZhciBiOmJvb2xlYW4gPSA8Ym9vbGVhbj4gKCBzLnJlcXVpcmVEZXB0aFJlbmRlciA9PSBudWxsICk/IGZhbHNlIDogcy5yZXF1aXJlRGVwdGhSZW5kZXI7XG5cblx0XHRcdHRoaXMuX3JlcXVpcmVEZXB0aFJlbmRlciA9IHRoaXMuX3JlcXVpcmVEZXB0aFJlbmRlciB8fCBiO1xuXG5cdFx0fVxuXG5cdFx0dGhpcy5fZmlsdGVyU2l6ZXNJbnZhbGlkID0gdHJ1ZTtcblxuXHR9XG5cblx0cHJpdmF0ZSB1cGRhdGVGaWx0ZXJUYXNrcyhzdGFnZTpTdGFnZSlcblx0e1xuXHRcdHZhciBsZW46bnVtYmVyO1xuXG5cdFx0aWYgKHRoaXMuX2ZpbHRlclNpemVzSW52YWxpZCkge1xuXG5cdFx0XHR0aGlzLnVwZGF0ZUZpbHRlclNpemVzKCk7XG5cblx0XHR9XG5cblx0XHRpZiAoIXRoaXMuX2ZpbHRlcnMpIHtcblx0XHRcdHRoaXMuX3Rhc2tzID0gbnVsbDtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHR0aGlzLl90YXNrcyA9IG5ldyBBcnJheTxGaWx0ZXIzRFRhc2tCYXNlPigpO1xuXG5cdFx0bGVuID0gdGhpcy5fZmlsdGVycy5sZW5ndGggLSAxO1xuXG5cdFx0dmFyIGZpbHRlcjpGaWx0ZXIzREJhc2U7XG5cblx0XHRmb3IgKHZhciBpOm51bWJlciA9IDA7IGkgPD0gbGVuOyArK2kpIHtcblxuXHRcdFx0Ly8gbWFrZSBzdXJlIGFsbCBpbnRlcm5hbCB0YXNrcyBhcmUgbGlua2VkIHRvZ2V0aGVyXG5cdFx0XHRmaWx0ZXIgPSB0aGlzLl9maWx0ZXJzW2ldO1xuXG5cdFx0XHQvLyBUT0RPOiBjaGVjayBsb2dpY1xuXHRcdFx0Ly8gZmlsdGVyLnNldFJlbmRlclRhcmdldHMoaSA9PSBsZW4/IG51bGwgOiBGaWx0ZXIzREJhc2UoX2ZpbHRlcnNbaSArIDFdKS5nZXRNYWluSW5wdXRUZXh0dXJlKHN0YWdlKSwgc3RhZ2UpO1xuXG5cdFx0XHRmaWx0ZXIuc2V0UmVuZGVyVGFyZ2V0cyhpID09IGxlbj8gbnVsbCA6IHRoaXMuX2ZpbHRlcnNbaSArIDFdLmdldE1haW5JbnB1dFRleHR1cmUoc3RhZ2UpLCBzdGFnZSk7XG5cblx0XHRcdHRoaXMuX3Rhc2tzID0gdGhpcy5fdGFza3MuY29uY2F0KGZpbHRlci50YXNrcyk7XG5cblx0XHR9XG5cblx0XHR0aGlzLl9tYWluSW5wdXRUZXh0dXJlID0gdGhpcy5fZmlsdGVyc1swXS5nZXRNYWluSW5wdXRUZXh0dXJlKHN0YWdlKTtcblxuXHR9XG5cblx0cHVibGljIHJlbmRlcihzdGFnZTpTdGFnZSwgY2FtZXJhOkNhbWVyYSwgZGVwdGhUZXh0dXJlOklUZXh0dXJlKVxuXHR7XG5cdFx0dmFyIGxlbjpudW1iZXI7XG5cdFx0dmFyIGk6bnVtYmVyO1xuXHRcdHZhciB0YXNrOkZpbHRlcjNEVGFza0Jhc2U7XG5cdFx0dmFyIGNvbnRleHQ6SUNvbnRleHRTdGFnZUdMID0gPElDb250ZXh0U3RhZ2VHTD4gc3RhZ2UuY29udGV4dDtcblxuXHRcdHZhciBpbmRleEJ1ZmZlcjpJSW5kZXhCdWZmZXIgPSB0aGlzLl9ydHRNYW5hZ2VyLmluZGV4QnVmZmVyO1xuXG5cdFx0dmFyIHZlcnRleEJ1ZmZlcjpJVmVydGV4QnVmZmVyID0gdGhpcy5fcnR0TWFuYWdlci5yZW5kZXJUb1RleHR1cmVWZXJ0ZXhCdWZmZXI7XG5cblx0XHRpZiAoIXRoaXMuX2ZpbHRlcnMpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRpZiAodGhpcy5fZmlsdGVyU2l6ZXNJbnZhbGlkKSB7XG5cdFx0XHR0aGlzLnVwZGF0ZUZpbHRlclNpemVzKCk7XG5cdFx0fVxuXG5cdFx0aWYgKHRoaXMuX2ZpbHRlclRhc2tzSW52YWxpZCkge1xuXHRcdFx0dGhpcy51cGRhdGVGaWx0ZXJUYXNrcyhzdGFnZSk7XG5cdFx0fVxuXG5cdFx0bGVuID0gdGhpcy5fZmlsdGVycy5sZW5ndGg7XG5cblx0XHRmb3IgKGkgPSAwOyBpIDwgbGVuOyArK2kpIHtcblx0XHRcdHRoaXMuX2ZpbHRlcnNbaV0udXBkYXRlKHN0YWdlLCBjYW1lcmEpO1xuXHRcdH1cblxuXHRcdGxlbiA9IHRoaXMuX3Rhc2tzLmxlbmd0aDtcblxuXHRcdGlmIChsZW4gPiAxKSB7XG5cdFx0XHRjb250ZXh0LnNldFZlcnRleEJ1ZmZlckF0KDAsIHZlcnRleEJ1ZmZlciwgMCwgQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0LkZMT0FUXzIpO1xuXHRcdFx0Y29udGV4dC5zZXRWZXJ0ZXhCdWZmZXJBdCgxLCB2ZXJ0ZXhCdWZmZXIsIDIsIENvbnRleHRHTFZlcnRleEJ1ZmZlckZvcm1hdC5GTE9BVF8yKTtcblx0XHR9XG5cblx0XHRmb3IgKGkgPSAwOyBpIDwgbGVuOyArK2kpIHtcblxuXHRcdFx0dGFzayA9IHRoaXMuX3Rhc2tzW2ldO1xuXG5cdFx0XHQvL3N0YWdlLnNldFJlbmRlclRhcmdldCh0YXNrLnRhcmdldCk7IC8vVE9ET1xuXG5cdFx0XHRpZiAoIXRhc2sudGFyZ2V0KSB7XG5cblx0XHRcdFx0c3RhZ2Uuc2Npc3NvclJlY3QgPSBudWxsO1xuXHRcdFx0XHR2ZXJ0ZXhCdWZmZXIgPSB0aGlzLl9ydHRNYW5hZ2VyLnJlbmRlclRvU2NyZWVuVmVydGV4QnVmZmVyO1xuXHRcdFx0XHRjb250ZXh0LnNldFZlcnRleEJ1ZmZlckF0KDAsIHZlcnRleEJ1ZmZlciwgMCwgQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0LkZMT0FUXzIpO1xuXHRcdFx0XHRjb250ZXh0LnNldFZlcnRleEJ1ZmZlckF0KDEsIHZlcnRleEJ1ZmZlciwgMiwgQ29udGV4dEdMVmVydGV4QnVmZmVyRm9ybWF0LkZMT0FUXzIpO1xuXG5cdFx0XHR9XG5cblx0XHRcdGNvbnRleHQuc2V0VGV4dHVyZUF0KDAsIHRhc2suZ2V0TWFpbklucHV0VGV4dHVyZShzdGFnZSkpO1xuXHRcdFx0Y29udGV4dC5zZXRQcm9ncmFtKHRhc2suZ2V0UHJvZ3JhbShzdGFnZSkpO1xuXHRcdFx0Y29udGV4dC5jbGVhcigwLjAsIDAuMCwgMC4wLCAwLjApO1xuXG5cdFx0XHR0YXNrLmFjdGl2YXRlKHN0YWdlLCBjYW1lcmEsIGRlcHRoVGV4dHVyZSk7XG5cblx0XHRcdGNvbnRleHQuc2V0QmxlbmRGYWN0b3JzKENvbnRleHRHTEJsZW5kRmFjdG9yLk9ORSwgQ29udGV4dEdMQmxlbmRGYWN0b3IuWkVSTyk7XG5cdFx0XHRjb250ZXh0LmRyYXdUcmlhbmdsZXMoaW5kZXhCdWZmZXIsIDAsIDIpO1xuXG5cdFx0XHR0YXNrLmRlYWN0aXZhdGUoc3RhZ2UpO1xuXHRcdH1cblxuXHRcdGNvbnRleHQuc2V0VGV4dHVyZUF0KDAsIG51bGwpO1xuXHRcdGNvbnRleHQuc2V0VmVydGV4QnVmZmVyQXQoMCwgbnVsbCk7XG5cdFx0Y29udGV4dC5zZXRWZXJ0ZXhCdWZmZXJBdCgxLCBudWxsKTtcblx0fVxuXG5cdHByaXZhdGUgdXBkYXRlRmlsdGVyU2l6ZXMoKVxuXHR7XG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgdGhpcy5fZmlsdGVycy5sZW5ndGg7ICsraSkge1xuXHRcdFx0dGhpcy5fZmlsdGVyc1tpXS50ZXh0dXJlV2lkdGggPSB0aGlzLl9ydHRNYW5hZ2VyLnRleHR1cmVXaWR0aDtcblx0XHRcdHRoaXMuX2ZpbHRlcnNbaV0udGV4dHVyZUhlaWdodCA9IHRoaXMuX3J0dE1hbmFnZXIudGV4dHVyZUhlaWdodDtcblx0XHR9XG5cblx0XHR0aGlzLl9maWx0ZXJTaXplc0ludmFsaWQgPSB0cnVlO1xuXG5cdH1cblxuXHRwdWJsaWMgZGlzcG9zZSgpXG5cdHtcblx0XHR0aGlzLl9ydHRNYW5hZ2VyLnJlbW92ZUV2ZW50TGlzdGVuZXIoRXZlbnQuUkVTSVpFLCB0aGlzLl9vblJUVFJlc2l6ZURlbGVnYXRlKTtcblx0XHR0aGlzLl9ydHRNYW5hZ2VyID0gbnVsbDtcblx0XHR0aGlzLl9zdGFnZSA9IG51bGw7XG5cdH1cbn1cblxuZXhwb3J0ID0gRmlsdGVyM0RSZW5kZXJlcjsiXX0=