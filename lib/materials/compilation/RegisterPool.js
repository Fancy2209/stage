var ShaderRegisterElement = require("awayjs-stagegl/lib/materials/compilation/ShaderRegisterElement");
/**
 * RegisterPool is used by the shader compilation process to keep track of which registers of a certain type are
 * currently used and should not be allowed to be written to. Either entire registers can be requested and locked,
 * or single components (x, y, z, w) of a single register.
 * It is used by ShaderRegisterCache to track usages of individual register types.
 *
 * @see away.materials.ShaderRegisterCache
 */
var RegisterPool = (function () {
    /**
     * Creates a new RegisterPool object.
     * @param regName The base name of the register type ("ft" for fragment temporaries, "vc" for vertex constants, etc)
     * @param regCount The amount of available registers of this type.
     * @param persistent Whether or not registers, once reserved, can be freed again. For example, temporaries are not persistent, but constants are.
     */
    function RegisterPool(regName, regCount, persistent) {
        if (persistent === void 0) { persistent = true; }
        this._regName = regName;
        this._regCount = regCount;
        this._persistent = persistent;
        this.initRegisters(regName, regCount);
    }
    /**
     * Retrieve an entire vector register that's still available.
     */
    RegisterPool.prototype.requestFreeVectorReg = function () {
        for (var i = 0; i < this._regCount; ++i) {
            if (!this.isRegisterUsed(i)) {
                if (this._persistent)
                    this._usedVectorCount[i]++;
                return this._vectorRegisters[i];
            }
        }
        throw new Error("Register overflow!");
    };
    /**
     * Retrieve a single vector component that's still available.
     */
    RegisterPool.prototype.requestFreeRegComponent = function () {
        for (var i = 0; i < this._regCount; ++i) {
            if (this._usedVectorCount[i] > 0)
                continue;
            for (var j = 0; j < 4; ++j) {
                if (this._usedSingleCount[j][i] == 0) {
                    if (this._persistent)
                        this._usedSingleCount[j][i]++;
                    return this._registerComponents[j][i];
                }
            }
        }
        throw new Error("Register overflow!");
    };
    /**
     * Marks a register as used, so it cannot be retrieved. The register won't be able to be used until removeUsage
     * has been called usageCount times again.
     * @param register The register to mark as used.
     * @param usageCount The amount of usages to add.
     */
    RegisterPool.prototype.addUsage = function (register, usageCount) {
        if (register._component > -1)
            this._usedSingleCount[register._component][register.index] += usageCount;
        else
            this._usedVectorCount[register.index] += usageCount;
    };
    /**
     * Removes a usage from a register. When usages reach 0, the register is freed again.
     * @param register The register for which to remove a usage.
     */
    RegisterPool.prototype.removeUsage = function (register) {
        if (register._component > -1) {
            if (--this._usedSingleCount[register._component][register.index] < 0)
                throw new Error("More usages removed than exist!");
        }
        else {
            if (--this._usedVectorCount[register.index] < 0)
                throw new Error("More usages removed than exist!");
        }
    };
    /**
     * Disposes any resources used by the current RegisterPool object.
     */
    RegisterPool.prototype.dispose = function () {
        this._vectorRegisters = null;
        this._registerComponents = null;
        this._usedSingleCount = null;
        this._usedVectorCount = null;
    };
    /**
     * Indicates whether or not any registers are in use.
     */
    RegisterPool.prototype.hasRegisteredRegs = function () {
        for (var i = 0; i < this._regCount; ++i)
            if (this.isRegisterUsed(i))
                return true;
        return false;
    };
    /**
     * Initializes all registers.
     */
    RegisterPool.prototype.initRegisters = function (regName, regCount) {
        var hash = RegisterPool._initPool(regName, regCount);
        this._vectorRegisters = RegisterPool._regPool[hash];
        this._registerComponents = RegisterPool._regCompsPool[hash];
        this._usedVectorCount = this._initArray(Array(regCount), 0);
        this._usedSingleCount = new Array(4);
        this._usedSingleCount[0] = this._initArray(new Array(regCount), 0);
        this._usedSingleCount[1] = this._initArray(new Array(regCount), 0);
        this._usedSingleCount[2] = this._initArray(new Array(regCount), 0);
        this._usedSingleCount[3] = this._initArray(new Array(regCount), 0);
    };
    RegisterPool._initPool = function (regName, regCount) {
        var hash = regName + regCount;
        if (RegisterPool._regPool[hash] != undefined)
            return hash;
        var vectorRegisters = new Array(regCount);
        RegisterPool._regPool[hash] = vectorRegisters;
        var registerComponents = [
            [],
            [],
            [],
            []
        ];
        RegisterPool._regCompsPool[hash] = registerComponents;
        for (var i = 0; i < regCount; ++i) {
            vectorRegisters[i] = new ShaderRegisterElement(regName, i);
            for (var j = 0; j < 4; ++j)
                registerComponents[j][i] = new ShaderRegisterElement(regName, i, j);
        }
        return hash;
    };
    /**
     * Check if the temp register is either used for single or vector use
     */
    RegisterPool.prototype.isRegisterUsed = function (index) {
        if (this._usedVectorCount[index] > 0)
            return true;
        for (var i = 0; i < 4; ++i)
            if (this._usedSingleCount[i][index] > 0)
                return true;
        return false;
    };
    RegisterPool.prototype._initArray = function (a, val) {
        var l = a.length;
        for (var c = 0; c < l; c++)
            a[c] = val;
        return a;
    };
    RegisterPool._regPool = new Object();
    RegisterPool._regCompsPool = new Object();
    return RegisterPool;
})();
module.exports = RegisterPool;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1zdGFnZWdsL2xpYi9tYXRlcmlhbHMvY29tcGlsYXRpb24vcmVnaXN0ZXJwb29sLnRzIl0sIm5hbWVzIjpbIlJlZ2lzdGVyUG9vbCIsIlJlZ2lzdGVyUG9vbC5jb25zdHJ1Y3RvciIsIlJlZ2lzdGVyUG9vbC5yZXF1ZXN0RnJlZVZlY3RvclJlZyIsIlJlZ2lzdGVyUG9vbC5yZXF1ZXN0RnJlZVJlZ0NvbXBvbmVudCIsIlJlZ2lzdGVyUG9vbC5hZGRVc2FnZSIsIlJlZ2lzdGVyUG9vbC5yZW1vdmVVc2FnZSIsIlJlZ2lzdGVyUG9vbC5kaXNwb3NlIiwiUmVnaXN0ZXJQb29sLmhhc1JlZ2lzdGVyZWRSZWdzIiwiUmVnaXN0ZXJQb29sLmluaXRSZWdpc3RlcnMiLCJSZWdpc3RlclBvb2wuX2luaXRQb29sIiwiUmVnaXN0ZXJQb29sLmlzUmVnaXN0ZXJVc2VkIiwiUmVnaXN0ZXJQb29sLl9pbml0QXJyYXkiXSwibWFwcGluZ3MiOiJBQUFBLElBQU8scUJBQXFCLFdBQVksZ0VBQWdFLENBQUMsQ0FBQztBQUUxRyxBQVFBOzs7Ozs7O0dBREc7SUFDRyxZQUFZO0lBZWpCQTs7Ozs7T0FLR0E7SUFDSEEsU0FyQktBLFlBQVlBLENBcUJMQSxPQUFjQSxFQUFFQSxRQUFlQSxFQUFFQSxVQUF5QkE7UUFBekJDLDBCQUF5QkEsR0FBekJBLGlCQUF5QkE7UUFFckVBLElBQUlBLENBQUNBLFFBQVFBLEdBQUdBLE9BQU9BLENBQUNBO1FBQ3hCQSxJQUFJQSxDQUFDQSxTQUFTQSxHQUFHQSxRQUFRQSxDQUFDQTtRQUMxQkEsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsVUFBVUEsQ0FBQ0E7UUFDOUJBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLE9BQU9BLEVBQUVBLFFBQVFBLENBQUNBLENBQUNBO0lBQ3ZDQSxDQUFDQTtJQUVERDs7T0FFR0E7SUFDSUEsMkNBQW9CQSxHQUEzQkE7UUFFQ0UsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBVUEs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QUU1REEsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxHQUFHQSxZQUFZQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNwREEsSUFBSUEsQ0FBQ0EsbUJBQW1CQSxHQUFHQSxZQUFZQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUU1REEsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxHQUFHQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxLQUFLQSxDQUFTQSxRQUFRQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUVwRUEsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxHQUFHQSxJQUFJQSxLQUFLQSxDQUFnQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDcERBLElBQUlBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsSUFBSUEsS0FBS0EsQ0FBU0EsUUFBUUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDM0VBLElBQUlBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsSUFBSUEsS0FBS0EsQ0FBU0EsUUFBUUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDM0VBLElBQUlBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsSUFBSUEsS0FBS0EsQ0FBU0EsUUFBUUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDM0VBLElBQUlBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsSUFBSUEsS0FBS0EsQ0FBU0EsUUFBUUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDNUVBLENBQUNBO0lBRWNSLHNCQUFTQSxHQUF4QkEsVUFBeUJBLE9BQWNBLEVBQUVBLFFBQWVBO1FBRXZEUyxJQUFJQSxJQUFJQSxHQUFVQSxPQUFPQSxHQUFHQSxRQUFRQSxDQUFDQTtRQUVyQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsWUFBWUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsU0FBU0EsQ0FBQ0E7WUFDNUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO1FBRWJBLElBQUlBLGVBQWVBLEdBQWdDQSxJQUFJQSxLQUFLQSxDQUF3QkEsUUFBUUEsQ0FBQ0EsQ0FBQ0E7UUFDOUZBLFlBQVlBLENBQUNBLFFBQVFBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLGVBQWVBLENBQUNBO1FBRTlDQSxJQUFJQSxrQkFBa0JBLEdBQUdBO1lBQ3hCQSxFQUFFQTtZQUNGQSxFQUFFQTtZQUNGQSxFQUFFQTtZQUNGQSxFQUFFQTtTQUNGQSxDQUFDQTtRQUNGQSxZQUFZQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxrQkFBa0JBLENBQUNBO1FBRXREQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFVQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxRQUFRQSxFQUFFQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQTtZQUUxQ0EsZUFBZUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEscUJBQXFCQSxDQUFDQSxPQUFPQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUUzREEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBVUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7Z0JBQ2hDQSxrQkFBa0JBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLHFCQUFxQkEsQ0FBQ0EsT0FBT0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDdEVBLENBQUNBO1FBRURBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO0lBQ2JBLENBQUNBO0lBR0RUOztPQUVHQTtJQUNLQSxxQ0FBY0EsR0FBdEJBLFVBQXVCQSxLQUFZQTtRQUVsQ1UsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUNwQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFFYkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBVUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7WUFDaENBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3ZDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtRQUVkQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQTtJQUNkQSxDQUFDQTtJQUdPVixpQ0FBVUEsR0FBbEJBLFVBQW1CQSxDQUFZQSxFQUFFQSxHQUFPQTtRQUV2Q1csSUFBSUEsQ0FBQ0EsR0FBVUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0E7UUFFeEJBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQVVBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBO1lBQ2hDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQTtRQUVaQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUNWQSxDQUFDQTtJQS9MY1gscUJBQVFBLEdBQVVBLElBQUlBLE1BQU1BLEVBQUVBLENBQUNBO0lBQy9CQSwwQkFBYUEsR0FBVUEsSUFBSUEsTUFBTUEsRUFBRUEsQ0FBQ0E7SUErTHBEQSxtQkFBQ0E7QUFBREEsQ0FsTUEsQUFrTUNBLElBQUE7QUFFRCxBQUFzQixpQkFBYixZQUFZLENBQUMiLCJmaWxlIjoibWF0ZXJpYWxzL2NvbXBpbGF0aW9uL1JlZ2lzdGVyUG9vbC5qcyIsInNvdXJjZVJvb3QiOiIuLi8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU2hhZGVyUmVnaXN0ZXJFbGVtZW50XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9tYXRlcmlhbHMvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJFbGVtZW50XCIpO1xuXG4vKipcbiAqIFJlZ2lzdGVyUG9vbCBpcyB1c2VkIGJ5IHRoZSBzaGFkZXIgY29tcGlsYXRpb24gcHJvY2VzcyB0byBrZWVwIHRyYWNrIG9mIHdoaWNoIHJlZ2lzdGVycyBvZiBhIGNlcnRhaW4gdHlwZSBhcmVcbiAqIGN1cnJlbnRseSB1c2VkIGFuZCBzaG91bGQgbm90IGJlIGFsbG93ZWQgdG8gYmUgd3JpdHRlbiB0by4gRWl0aGVyIGVudGlyZSByZWdpc3RlcnMgY2FuIGJlIHJlcXVlc3RlZCBhbmQgbG9ja2VkLFxuICogb3Igc2luZ2xlIGNvbXBvbmVudHMgKHgsIHksIHosIHcpIG9mIGEgc2luZ2xlIHJlZ2lzdGVyLlxuICogSXQgaXMgdXNlZCBieSBTaGFkZXJSZWdpc3RlckNhY2hlIHRvIHRyYWNrIHVzYWdlcyBvZiBpbmRpdmlkdWFsIHJlZ2lzdGVyIHR5cGVzLlxuICpcbiAqIEBzZWUgYXdheS5tYXRlcmlhbHMuU2hhZGVyUmVnaXN0ZXJDYWNoZVxuICovXG5jbGFzcyBSZWdpc3RlclBvb2xcbntcblx0cHJpdmF0ZSBzdGF0aWMgX3JlZ1Bvb2w6T2JqZWN0ID0gbmV3IE9iamVjdCgpO1xuXHRwcml2YXRlIHN0YXRpYyBfcmVnQ29tcHNQb29sOk9iamVjdCA9IG5ldyBPYmplY3QoKTtcblxuXHRwcml2YXRlIF92ZWN0b3JSZWdpc3RlcnM6QXJyYXk8U2hhZGVyUmVnaXN0ZXJFbGVtZW50Pjtcblx0cHJpdmF0ZSBfcmVnaXN0ZXJDb21wb25lbnRzO1xuXG5cdHByaXZhdGUgX3JlZ05hbWU6c3RyaW5nO1xuXHRwcml2YXRlIF91c2VkU2luZ2xlQ291bnQ6QXJyYXk8QXJyYXk8bnVtYmVyPj47XG5cdHByaXZhdGUgX3VzZWRWZWN0b3JDb3VudDpBcnJheTxudW1iZXI+IC8qdWludCovO1xuXHRwcml2YXRlIF9yZWdDb3VudDpudW1iZXI7XG5cblx0cHJpdmF0ZSBfcGVyc2lzdGVudDpib29sZWFuO1xuXG5cdC8qKlxuXHQgKiBDcmVhdGVzIGEgbmV3IFJlZ2lzdGVyUG9vbCBvYmplY3QuXG5cdCAqIEBwYXJhbSByZWdOYW1lIFRoZSBiYXNlIG5hbWUgb2YgdGhlIHJlZ2lzdGVyIHR5cGUgKFwiZnRcIiBmb3IgZnJhZ21lbnQgdGVtcG9yYXJpZXMsIFwidmNcIiBmb3IgdmVydGV4IGNvbnN0YW50cywgZXRjKVxuXHQgKiBAcGFyYW0gcmVnQ291bnQgVGhlIGFtb3VudCBvZiBhdmFpbGFibGUgcmVnaXN0ZXJzIG9mIHRoaXMgdHlwZS5cblx0ICogQHBhcmFtIHBlcnNpc3RlbnQgV2hldGhlciBvciBub3QgcmVnaXN0ZXJzLCBvbmNlIHJlc2VydmVkLCBjYW4gYmUgZnJlZWQgYWdhaW4uIEZvciBleGFtcGxlLCB0ZW1wb3JhcmllcyBhcmUgbm90IHBlcnNpc3RlbnQsIGJ1dCBjb25zdGFudHMgYXJlLlxuXHQgKi9cblx0Y29uc3RydWN0b3IocmVnTmFtZTpzdHJpbmcsIHJlZ0NvdW50Om51bWJlciwgcGVyc2lzdGVudDpib29sZWFuID0gdHJ1ZSlcblx0e1xuXHRcdHRoaXMuX3JlZ05hbWUgPSByZWdOYW1lO1xuXHRcdHRoaXMuX3JlZ0NvdW50ID0gcmVnQ291bnQ7XG5cdFx0dGhpcy5fcGVyc2lzdGVudCA9IHBlcnNpc3RlbnQ7XG5cdFx0dGhpcy5pbml0UmVnaXN0ZXJzKHJlZ05hbWUsIHJlZ0NvdW50KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXRyaWV2ZSBhbiBlbnRpcmUgdmVjdG9yIHJlZ2lzdGVyIHRoYXQncyBzdGlsbCBhdmFpbGFibGUuXG5cdCAqL1xuXHRwdWJsaWMgcmVxdWVzdEZyZWVWZWN0b3JSZWcoKTpTaGFkZXJSZWdpc3RlckVsZW1lbnRcblx0e1xuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8IHRoaXMuX3JlZ0NvdW50OyArK2kpIHtcblx0XHRcdGlmICghdGhpcy5pc1JlZ2lzdGVyVXNlZChpKSkge1xuXHRcdFx0XHRpZiAodGhpcy5fcGVyc2lzdGVudClcblx0XHRcdFx0XHR0aGlzLl91c2VkVmVjdG9yQ291bnRbaV0rKztcblxuXHRcdFx0XHRyZXR1cm4gdGhpcy5fdmVjdG9yUmVnaXN0ZXJzW2ldO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHRocm93IG5ldyBFcnJvcihcIlJlZ2lzdGVyIG92ZXJmbG93IVwiKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZXRyaWV2ZSBhIHNpbmdsZSB2ZWN0b3IgY29tcG9uZW50IHRoYXQncyBzdGlsbCBhdmFpbGFibGUuXG5cdCAqL1xuXHRwdWJsaWMgcmVxdWVzdEZyZWVSZWdDb21wb25lbnQoKTpTaGFkZXJSZWdpc3RlckVsZW1lbnRcblx0e1xuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8IHRoaXMuX3JlZ0NvdW50OyArK2kpIHtcblx0XHRcdGlmICh0aGlzLl91c2VkVmVjdG9yQ291bnRbaV0gPiAwKVxuXHRcdFx0XHRjb250aW51ZTtcblxuXHRcdFx0Zm9yICh2YXIgajpudW1iZXIgPSAwOyBqIDwgNDsgKytqKSB7XG5cdFx0XHRcdGlmICh0aGlzLl91c2VkU2luZ2xlQ291bnRbal1baV0gPT0gMCkge1xuXHRcdFx0XHRcdGlmICh0aGlzLl9wZXJzaXN0ZW50KVxuXHRcdFx0XHRcdFx0dGhpcy5fdXNlZFNpbmdsZUNvdW50W2pdW2ldKys7XG5cblx0XHRcdFx0XHRyZXR1cm4gdGhpcy5fcmVnaXN0ZXJDb21wb25lbnRzW2pdW2ldO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0dGhyb3cgbmV3IEVycm9yKFwiUmVnaXN0ZXIgb3ZlcmZsb3chXCIpO1xuXHR9XG5cblx0LyoqXG5cdCAqIE1hcmtzIGEgcmVnaXN0ZXIgYXMgdXNlZCwgc28gaXQgY2Fubm90IGJlIHJldHJpZXZlZC4gVGhlIHJlZ2lzdGVyIHdvbid0IGJlIGFibGUgdG8gYmUgdXNlZCB1bnRpbCByZW1vdmVVc2FnZVxuXHQgKiBoYXMgYmVlbiBjYWxsZWQgdXNhZ2VDb3VudCB0aW1lcyBhZ2Fpbi5cblx0ICogQHBhcmFtIHJlZ2lzdGVyIFRoZSByZWdpc3RlciB0byBtYXJrIGFzIHVzZWQuXG5cdCAqIEBwYXJhbSB1c2FnZUNvdW50IFRoZSBhbW91bnQgb2YgdXNhZ2VzIHRvIGFkZC5cblx0ICovXG5cdHB1YmxpYyBhZGRVc2FnZShyZWdpc3RlcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQsIHVzYWdlQ291bnQ6bnVtYmVyKVxuXHR7XG5cdFx0aWYgKHJlZ2lzdGVyLl9jb21wb25lbnQgPiAtMSlcblx0XHRcdHRoaXMuX3VzZWRTaW5nbGVDb3VudFtyZWdpc3Rlci5fY29tcG9uZW50XVtyZWdpc3Rlci5pbmRleF0gKz0gdXNhZ2VDb3VudDtcblx0XHRlbHNlXG5cdFx0XHR0aGlzLl91c2VkVmVjdG9yQ291bnRbcmVnaXN0ZXIuaW5kZXhdICs9IHVzYWdlQ291bnQ7XG5cdH1cblxuXHQvKipcblx0ICogUmVtb3ZlcyBhIHVzYWdlIGZyb20gYSByZWdpc3Rlci4gV2hlbiB1c2FnZXMgcmVhY2ggMCwgdGhlIHJlZ2lzdGVyIGlzIGZyZWVkIGFnYWluLlxuXHQgKiBAcGFyYW0gcmVnaXN0ZXIgVGhlIHJlZ2lzdGVyIGZvciB3aGljaCB0byByZW1vdmUgYSB1c2FnZS5cblx0ICovXG5cdHB1YmxpYyByZW1vdmVVc2FnZShyZWdpc3RlcjpTaGFkZXJSZWdpc3RlckVsZW1lbnQpXG5cdHtcblx0XHRpZiAocmVnaXN0ZXIuX2NvbXBvbmVudCA+IC0xKSB7XG5cdFx0XHRpZiAoLS10aGlzLl91c2VkU2luZ2xlQ291bnRbcmVnaXN0ZXIuX2NvbXBvbmVudF1bcmVnaXN0ZXIuaW5kZXhdIDwgMClcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiTW9yZSB1c2FnZXMgcmVtb3ZlZCB0aGFuIGV4aXN0IVwiKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0aWYgKC0tdGhpcy5fdXNlZFZlY3RvckNvdW50W3JlZ2lzdGVyLmluZGV4XSA8IDApXG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihcIk1vcmUgdXNhZ2VzIHJlbW92ZWQgdGhhbiBleGlzdCFcIik7XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIERpc3Bvc2VzIGFueSByZXNvdXJjZXMgdXNlZCBieSB0aGUgY3VycmVudCBSZWdpc3RlclBvb2wgb2JqZWN0LlxuXHQgKi9cblx0cHVibGljIGRpc3Bvc2UoKVxuXHR7XG5cdFx0dGhpcy5fdmVjdG9yUmVnaXN0ZXJzID0gbnVsbDtcblx0XHR0aGlzLl9yZWdpc3RlckNvbXBvbmVudHMgPSBudWxsO1xuXHRcdHRoaXMuX3VzZWRTaW5nbGVDb3VudCA9IG51bGw7XG5cdFx0dGhpcy5fdXNlZFZlY3RvckNvdW50ID0gbnVsbDtcblx0fVxuXG5cdC8qKlxuXHQgKiBJbmRpY2F0ZXMgd2hldGhlciBvciBub3QgYW55IHJlZ2lzdGVycyBhcmUgaW4gdXNlLlxuXHQgKi9cblx0cHVibGljIGhhc1JlZ2lzdGVyZWRSZWdzKCk6Ym9vbGVhblxuXHR7XG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgdGhpcy5fcmVnQ291bnQ7ICsraSlcblx0XHRcdGlmICh0aGlzLmlzUmVnaXN0ZXJVc2VkKGkpKVxuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblxuXHRcdHJldHVybiBmYWxzZTtcblx0fVxuXG5cdC8qKlxuXHQgKiBJbml0aWFsaXplcyBhbGwgcmVnaXN0ZXJzLlxuXHQgKi9cblx0cHJpdmF0ZSBpbml0UmVnaXN0ZXJzKHJlZ05hbWU6c3RyaW5nLCByZWdDb3VudDpudW1iZXIpXG5cdHtcblx0XHR2YXIgaGFzaDpzdHJpbmcgPSBSZWdpc3RlclBvb2wuX2luaXRQb29sKHJlZ05hbWUsIHJlZ0NvdW50KTtcblxuXHRcdHRoaXMuX3ZlY3RvclJlZ2lzdGVycyA9IFJlZ2lzdGVyUG9vbC5fcmVnUG9vbFtoYXNoXTtcblx0XHR0aGlzLl9yZWdpc3RlckNvbXBvbmVudHMgPSBSZWdpc3RlclBvb2wuX3JlZ0NvbXBzUG9vbFtoYXNoXTtcblxuXHRcdHRoaXMuX3VzZWRWZWN0b3JDb3VudCA9IHRoaXMuX2luaXRBcnJheShBcnJheTxudW1iZXI+KHJlZ0NvdW50KSwgMCk7XG5cblx0XHR0aGlzLl91c2VkU2luZ2xlQ291bnQgPSBuZXcgQXJyYXk8QXJyYXk8bnVtYmVyPj4oNCk7XG5cdFx0dGhpcy5fdXNlZFNpbmdsZUNvdW50WzBdID0gdGhpcy5faW5pdEFycmF5KG5ldyBBcnJheTxudW1iZXI+KHJlZ0NvdW50KSwgMCk7XG5cdFx0dGhpcy5fdXNlZFNpbmdsZUNvdW50WzFdID0gdGhpcy5faW5pdEFycmF5KG5ldyBBcnJheTxudW1iZXI+KHJlZ0NvdW50KSwgMCk7XG5cdFx0dGhpcy5fdXNlZFNpbmdsZUNvdW50WzJdID0gdGhpcy5faW5pdEFycmF5KG5ldyBBcnJheTxudW1iZXI+KHJlZ0NvdW50KSwgMCk7XG5cdFx0dGhpcy5fdXNlZFNpbmdsZUNvdW50WzNdID0gdGhpcy5faW5pdEFycmF5KG5ldyBBcnJheTxudW1iZXI+KHJlZ0NvdW50KSwgMCk7XG5cdH1cblxuXHRwcml2YXRlIHN0YXRpYyBfaW5pdFBvb2wocmVnTmFtZTpzdHJpbmcsIHJlZ0NvdW50Om51bWJlcik6c3RyaW5nXG5cdHtcblx0XHR2YXIgaGFzaDpzdHJpbmcgPSByZWdOYW1lICsgcmVnQ291bnQ7XG5cblx0XHRpZiAoUmVnaXN0ZXJQb29sLl9yZWdQb29sW2hhc2hdICE9IHVuZGVmaW5lZClcblx0XHRcdHJldHVybiBoYXNoO1xuXG5cdFx0dmFyIHZlY3RvclJlZ2lzdGVyczpBcnJheTxTaGFkZXJSZWdpc3RlckVsZW1lbnQ+ID0gbmV3IEFycmF5PFNoYWRlclJlZ2lzdGVyRWxlbWVudD4ocmVnQ291bnQpO1xuXHRcdFJlZ2lzdGVyUG9vbC5fcmVnUG9vbFtoYXNoXSA9IHZlY3RvclJlZ2lzdGVycztcblxuXHRcdHZhciByZWdpc3RlckNvbXBvbmVudHMgPSBbXG5cdFx0XHRbXSxcblx0XHRcdFtdLFxuXHRcdFx0W10sXG5cdFx0XHRbXVxuXHRcdF07XG5cdFx0UmVnaXN0ZXJQb29sLl9yZWdDb21wc1Bvb2xbaGFzaF0gPSByZWdpc3RlckNvbXBvbmVudHM7XG5cblx0XHRmb3IgKHZhciBpOm51bWJlciA9IDA7IGkgPCByZWdDb3VudDsgKytpKSB7XG5cblx0XHRcdHZlY3RvclJlZ2lzdGVyc1tpXSA9IG5ldyBTaGFkZXJSZWdpc3RlckVsZW1lbnQocmVnTmFtZSwgaSk7XG5cblx0XHRcdGZvciAodmFyIGo6bnVtYmVyID0gMDsgaiA8IDQ7ICsrailcblx0XHRcdFx0cmVnaXN0ZXJDb21wb25lbnRzW2pdW2ldID0gbmV3IFNoYWRlclJlZ2lzdGVyRWxlbWVudChyZWdOYW1lLCBpLCBqKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gaGFzaDtcblx0fVxuXG5cblx0LyoqXG5cdCAqIENoZWNrIGlmIHRoZSB0ZW1wIHJlZ2lzdGVyIGlzIGVpdGhlciB1c2VkIGZvciBzaW5nbGUgb3IgdmVjdG9yIHVzZVxuXHQgKi9cblx0cHJpdmF0ZSBpc1JlZ2lzdGVyVXNlZChpbmRleDpudW1iZXIpOmJvb2xlYW5cblx0e1xuXHRcdGlmICh0aGlzLl91c2VkVmVjdG9yQ291bnRbaW5kZXhdID4gMClcblx0XHRcdHJldHVybiB0cnVlO1xuXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgNDsgKytpKVxuXHRcdFx0aWYgKHRoaXMuX3VzZWRTaW5nbGVDb3VudFtpXVtpbmRleF0gPiAwKVxuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblxuXHRcdHJldHVybiBmYWxzZTtcblx0fVxuXG5cblx0cHJpdmF0ZSBfaW5pdEFycmF5KGE6QXJyYXk8YW55PiwgdmFsOmFueSk6QXJyYXk8YW55PlxuXHR7XG5cdFx0dmFyIGw6bnVtYmVyID0gYS5sZW5ndGg7XG5cblx0XHRmb3IgKHZhciBjOm51bWJlciA9IDA7IGMgPCBsOyBjKyspXG5cdFx0XHRhW2NdID0gdmFsO1xuXG5cdFx0cmV0dXJuIGE7XG5cdH1cbn1cblxuZXhwb3J0ID0gUmVnaXN0ZXJQb29sO1xuIl19