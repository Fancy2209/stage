var ShaderRegisterElement = require("awayjs-stagegl/lib/materials/compilation/ShaderRegisterElement");
/**
 * RegisterPool is used by the shader compilation process to keep track of which registers of a certain type are
 * currently used and should not be allowed to be written to. Either entire registers can be requested and locked,
 * or single components (x, y, z, w) of a single register.
 * It is used by ShaderRegisterCache to track usages of individual register types.
 *
 * @see away.materials.ShaderRegisterCache
 */
var RegisterPool = (function () {
    /**
     * Creates a new RegisterPool object.
     * @param regName The base name of the register type ("ft" for fragment temporaries, "vc" for vertex constants, etc)
     * @param regCount The amount of available registers of this type.
     * @param persistent Whether or not registers, once reserved, can be freed again. For example, temporaries are not persistent, but constants are.
     */
    function RegisterPool(regName, regCount, persistent) {
        if (persistent === void 0) { persistent = true; }
        this._regName = regName;
        this._regCount = regCount;
        this._persistent = persistent;
        this.initRegisters(regName, regCount);
    }
    /**
     * Retrieve an entire vector register that's still available.
     */
    RegisterPool.prototype.requestFreeVectorReg = function () {
        for (var i = 0; i < this._regCount; ++i) {
            if (!this.isRegisterUsed(i)) {
                if (this._persistent)
                    this._usedVectorCount[i]++;
                return this._vectorRegisters[i];
            }
        }
        throw new Error("Register overflow!");
    };
    /**
     * Retrieve a single vector component that's still available.
     */
    RegisterPool.prototype.requestFreeRegComponent = function () {
        for (var i = 0; i < this._regCount; ++i) {
            if (this._usedVectorCount[i] > 0)
                continue;
            for (var j = 0; j < 4; ++j) {
                if (this._usedSingleCount[j][i] == 0) {
                    if (this._persistent)
                        this._usedSingleCount[j][i]++;
                    return this._registerComponents[j][i];
                }
            }
        }
        throw new Error("Register overflow!");
    };
    /**
     * Marks a register as used, so it cannot be retrieved. The register won't be able to be used until removeUsage
     * has been called usageCount times again.
     * @param register The register to mark as used.
     * @param usageCount The amount of usages to add.
     */
    RegisterPool.prototype.addUsage = function (register, usageCount) {
        if (register._component > -1)
            this._usedSingleCount[register._component][register.index] += usageCount;
        else
            this._usedVectorCount[register.index] += usageCount;
    };
    /**
     * Removes a usage from a register. When usages reach 0, the register is freed again.
     * @param register The register for which to remove a usage.
     */
    RegisterPool.prototype.removeUsage = function (register) {
        if (register._component > -1) {
            if (--this._usedSingleCount[register._component][register.index] < 0)
                throw new Error("More usages removed than exist!");
        }
        else {
            if (--this._usedVectorCount[register.index] < 0)
                throw new Error("More usages removed than exist!");
        }
    };
    /**
     * Disposes any resources used by the current RegisterPool object.
     */
    RegisterPool.prototype.dispose = function () {
        this._vectorRegisters = null;
        this._registerComponents = null;
        this._usedSingleCount = null;
        this._usedVectorCount = null;
    };
    /**
     * Indicates whether or not any registers are in use.
     */
    RegisterPool.prototype.hasRegisteredRegs = function () {
        for (var i = 0; i < this._regCount; ++i)
            if (this.isRegisterUsed(i))
                return true;
        return false;
    };
    /**
     * Initializes all registers.
     */
    RegisterPool.prototype.initRegisters = function (regName, regCount) {
        var hash = RegisterPool._initPool(regName, regCount);
        this._vectorRegisters = RegisterPool._regPool[hash];
        this._registerComponents = RegisterPool._regCompsPool[hash];
        this._usedVectorCount = this._initArray(Array(regCount), 0);
        this._usedSingleCount = new Array(4);
        this._usedSingleCount[0] = this._initArray(new Array(regCount), 0);
        this._usedSingleCount[1] = this._initArray(new Array(regCount), 0);
        this._usedSingleCount[2] = this._initArray(new Array(regCount), 0);
        this._usedSingleCount[3] = this._initArray(new Array(regCount), 0);
    };
    RegisterPool._initPool = function (regName, regCount) {
        var hash = regName + regCount;
        if (RegisterPool._regPool[hash] != undefined)
            return hash;
        var vectorRegisters = new Array(regCount);
        RegisterPool._regPool[hash] = vectorRegisters;
        var registerComponents = [
            [],
            [],
            [],
            []
        ];
        RegisterPool._regCompsPool[hash] = registerComponents;
        for (var i = 0; i < regCount; ++i) {
            vectorRegisters[i] = new ShaderRegisterElement(regName, i);
            for (var j = 0; j < 4; ++j)
                registerComponents[j][i] = new ShaderRegisterElement(regName, i, j);
        }
        return hash;
    };
    /**
     * Check if the temp register is either used for single or vector use
     */
    RegisterPool.prototype.isRegisterUsed = function (index) {
        if (this._usedVectorCount[index] > 0)
            return true;
        for (var i = 0; i < 4; ++i)
            if (this._usedSingleCount[i][index] > 0)
                return true;
        return false;
    };
    RegisterPool.prototype._initArray = function (a, val) {
        var l = a.length;
        for (var c = 0; c < l; c++)
            a[c] = val;
        return a;
    };
    RegisterPool._regPool = new Object();
    RegisterPool._regCompsPool = new Object();
    return RegisterPool;
})();
module.exports = RegisterPool;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hdGVyaWFscy9jb21waWxhdGlvbi9yZWdpc3RlcnBvb2wudHMiXSwibmFtZXMiOlsiUmVnaXN0ZXJQb29sIiwiUmVnaXN0ZXJQb29sLmNvbnN0cnVjdG9yIiwiUmVnaXN0ZXJQb29sLnJlcXVlc3RGcmVlVmVjdG9yUmVnIiwiUmVnaXN0ZXJQb29sLnJlcXVlc3RGcmVlUmVnQ29tcG9uZW50IiwiUmVnaXN0ZXJQb29sLmFkZFVzYWdlIiwiUmVnaXN0ZXJQb29sLnJlbW92ZVVzYWdlIiwiUmVnaXN0ZXJQb29sLmRpc3Bvc2UiLCJSZWdpc3RlclBvb2wuaGFzUmVnaXN0ZXJlZFJlZ3MiLCJSZWdpc3RlclBvb2wuaW5pdFJlZ2lzdGVycyIsIlJlZ2lzdGVyUG9vbC5faW5pdFBvb2wiLCJSZWdpc3RlclBvb2wuaXNSZWdpc3RlclVzZWQiLCJSZWdpc3RlclBvb2wuX2luaXRBcnJheSJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBTyxxQkFBcUIsV0FBWSxnRUFBZ0UsQ0FBQyxDQUFDO0FBRTFHLEFBUUE7Ozs7Ozs7R0FERztJQUNHLFlBQVk7SUFlakJBOzs7OztPQUtHQTtJQUNIQSxTQXJCS0EsWUFBWUEsQ0FxQkxBLE9BQWNBLEVBQUVBLFFBQWVBLEVBQUVBLFVBQXlCQTtRQUF6QkMsMEJBQXlCQSxHQUF6QkEsaUJBQXlCQTtRQUVyRUEsSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBR0EsT0FBT0EsQ0FBQ0E7UUFDeEJBLElBQUlBLENBQUNBLFNBQVNBLEdBQUdBLFFBQVFBLENBQUNBO1FBQzFCQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxVQUFVQSxDQUFDQTtRQUM5QkEsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsT0FBT0EsRUFBRUEsUUFBUUEsQ0FBQ0EsQ0FBQ0E7SUFDdkNBLENBQUNBO0lBRUREOztPQUVHQTtJQUNJQSwyQ0FBb0JBLEdBQTNCQTtRQUVDRSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFVQSxDQUFDQSxFQUFFQSxDQUFDQSxH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QVVBLE9BQU9BLEdBQUdBLFFBQVFBLENBQUNBO1FBRXJDQSxFQUFFQSxDQUFDQSxDQUFDQSxZQUFZQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxTQUFTQSxDQUFDQTtZQUM1Q0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFFYkEsSUFBSUEsZUFBZUEsR0FBZ0NBLElBQUlBLEtBQUtBLENBQXdCQSxRQUFRQSxDQUFDQSxDQUFDQTtRQUM5RkEsWUFBWUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsZUFBZUEsQ0FBQ0E7UUFFOUNBLElBQUlBLGtCQUFrQkEsR0FBR0E7WUFDeEJBLEVBQUVBO1lBQ0ZBLEVBQUVBO1lBQ0ZBLEVBQUVBO1lBQ0ZBLEVBQUVBO1NBQ0ZBLENBQUNBO1FBQ0ZBLFlBQVlBLENBQUNBLGFBQWFBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLGtCQUFrQkEsQ0FBQ0E7UUFFdERBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQVVBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLFFBQVFBLEVBQUVBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBO1lBRTFDQSxlQUFlQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxxQkFBcUJBLENBQUNBLE9BQU9BLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBRTNEQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFVQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtnQkFDaENBLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEscUJBQXFCQSxDQUFDQSxPQUFPQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUN0RUEsQ0FBQ0E7UUFFREEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7SUFDYkEsQ0FBQ0E7SUFHRFQ7O09BRUdBO0lBQ0tBLHFDQUFjQSxHQUF0QkEsVUFBdUJBLEtBQVlBO1FBRWxDVSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxnQkFBZ0JBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1lBQ3BDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtRQUViQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFVQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUNoQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtnQkFDdkNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO1FBRWRBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBO0lBQ2RBLENBQUNBO0lBR09WLGlDQUFVQSxHQUFsQkEsVUFBbUJBLENBQVlBLEVBQUVBLEdBQU9BO1FBRXZDVyxJQUFJQSxDQUFDQSxHQUFVQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQTtRQUV4QkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBVUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUE7WUFDaENBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBO1FBRVpBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO0lBQ1ZBLENBQUNBO0lBL0xjWCxxQkFBUUEsR0FBVUEsSUFBSUEsTUFBTUEsRUFBRUEsQ0FBQ0E7SUFDL0JBLDBCQUFhQSxHQUFVQSxJQUFJQSxNQUFNQSxFQUFFQSxDQUFDQTtJQStMcERBLG1CQUFDQTtBQUFEQSxDQWxNQSxBQWtNQ0EsSUFBQTtBQUVELEFBQXNCLGlCQUFiLFlBQVksQ0FBQyIsImZpbGUiOiJtYXRlcmlhbHMvY29tcGlsYXRpb24vUmVnaXN0ZXJQb29sLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9yb2JiYXRlbWFuL1dlYnN0b3JtUHJvamVjdHMvYXdheWpzLXN0YWdlZ2wvIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNoYWRlclJlZ2lzdGVyRWxlbWVudFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvbWF0ZXJpYWxzL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyRWxlbWVudFwiKTtcblxuLyoqXG4gKiBSZWdpc3RlclBvb2wgaXMgdXNlZCBieSB0aGUgc2hhZGVyIGNvbXBpbGF0aW9uIHByb2Nlc3MgdG8ga2VlcCB0cmFjayBvZiB3aGljaCByZWdpc3RlcnMgb2YgYSBjZXJ0YWluIHR5cGUgYXJlXG4gKiBjdXJyZW50bHkgdXNlZCBhbmQgc2hvdWxkIG5vdCBiZSBhbGxvd2VkIHRvIGJlIHdyaXR0ZW4gdG8uIEVpdGhlciBlbnRpcmUgcmVnaXN0ZXJzIGNhbiBiZSByZXF1ZXN0ZWQgYW5kIGxvY2tlZCxcbiAqIG9yIHNpbmdsZSBjb21wb25lbnRzICh4LCB5LCB6LCB3KSBvZiBhIHNpbmdsZSByZWdpc3Rlci5cbiAqIEl0IGlzIHVzZWQgYnkgU2hhZGVyUmVnaXN0ZXJDYWNoZSB0byB0cmFjayB1c2FnZXMgb2YgaW5kaXZpZHVhbCByZWdpc3RlciB0eXBlcy5cbiAqXG4gKiBAc2VlIGF3YXkubWF0ZXJpYWxzLlNoYWRlclJlZ2lzdGVyQ2FjaGVcbiAqL1xuY2xhc3MgUmVnaXN0ZXJQb29sXG57XG5cdHByaXZhdGUgc3RhdGljIF9yZWdQb29sOk9iamVjdCA9IG5ldyBPYmplY3QoKTtcblx0cHJpdmF0ZSBzdGF0aWMgX3JlZ0NvbXBzUG9vbDpPYmplY3QgPSBuZXcgT2JqZWN0KCk7XG5cblx0cHJpdmF0ZSBfdmVjdG9yUmVnaXN0ZXJzOkFycmF5PFNoYWRlclJlZ2lzdGVyRWxlbWVudD47XG5cdHByaXZhdGUgX3JlZ2lzdGVyQ29tcG9uZW50cztcblxuXHRwcml2YXRlIF9yZWdOYW1lOnN0cmluZztcblx0cHJpdmF0ZSBfdXNlZFNpbmdsZUNvdW50OkFycmF5PEFycmF5PG51bWJlcj4+O1xuXHRwcml2YXRlIF91c2VkVmVjdG9yQ291bnQ6QXJyYXk8bnVtYmVyPiAvKnVpbnQqLztcblx0cHJpdmF0ZSBfcmVnQ291bnQ6bnVtYmVyO1xuXG5cdHByaXZhdGUgX3BlcnNpc3RlbnQ6Ym9vbGVhbjtcblxuXHQvKipcblx0ICogQ3JlYXRlcyBhIG5ldyBSZWdpc3RlclBvb2wgb2JqZWN0LlxuXHQgKiBAcGFyYW0gcmVnTmFtZSBUaGUgYmFzZSBuYW1lIG9mIHRoZSByZWdpc3RlciB0eXBlIChcImZ0XCIgZm9yIGZyYWdtZW50IHRlbXBvcmFyaWVzLCBcInZjXCIgZm9yIHZlcnRleCBjb25zdGFudHMsIGV0Yylcblx0ICogQHBhcmFtIHJlZ0NvdW50IFRoZSBhbW91bnQgb2YgYXZhaWxhYmxlIHJlZ2lzdGVycyBvZiB0aGlzIHR5cGUuXG5cdCAqIEBwYXJhbSBwZXJzaXN0ZW50IFdoZXRoZXIgb3Igbm90IHJlZ2lzdGVycywgb25jZSByZXNlcnZlZCwgY2FuIGJlIGZyZWVkIGFnYWluLiBGb3IgZXhhbXBsZSwgdGVtcG9yYXJpZXMgYXJlIG5vdCBwZXJzaXN0ZW50LCBidXQgY29uc3RhbnRzIGFyZS5cblx0ICovXG5cdGNvbnN0cnVjdG9yKHJlZ05hbWU6c3RyaW5nLCByZWdDb3VudDpudW1iZXIsIHBlcnNpc3RlbnQ6Ym9vbGVhbiA9IHRydWUpXG5cdHtcblx0XHR0aGlzLl9yZWdOYW1lID0gcmVnTmFtZTtcblx0XHR0aGlzLl9yZWdDb3VudCA9IHJlZ0NvdW50O1xuXHRcdHRoaXMuX3BlcnNpc3RlbnQgPSBwZXJzaXN0ZW50O1xuXHRcdHRoaXMuaW5pdFJlZ2lzdGVycyhyZWdOYW1lLCByZWdDb3VudCk7XG5cdH1cblxuXHQvKipcblx0ICogUmV0cmlldmUgYW4gZW50aXJlIHZlY3RvciByZWdpc3RlciB0aGF0J3Mgc3RpbGwgYXZhaWxhYmxlLlxuXHQgKi9cblx0cHVibGljIHJlcXVlc3RGcmVlVmVjdG9yUmVnKCk6U2hhZGVyUmVnaXN0ZXJFbGVtZW50XG5cdHtcblx0XHRmb3IgKHZhciBpOm51bWJlciA9IDA7IGkgPCB0aGlzLl9yZWdDb3VudDsgKytpKSB7XG5cdFx0XHRpZiAoIXRoaXMuaXNSZWdpc3RlclVzZWQoaSkpIHtcblx0XHRcdFx0aWYgKHRoaXMuX3BlcnNpc3RlbnQpXG5cdFx0XHRcdFx0dGhpcy5fdXNlZFZlY3RvckNvdW50W2ldKys7XG5cblx0XHRcdFx0cmV0dXJuIHRoaXMuX3ZlY3RvclJlZ2lzdGVyc1tpXTtcblx0XHRcdH1cblx0XHR9XG5cblx0XHR0aHJvdyBuZXcgRXJyb3IoXCJSZWdpc3RlciBvdmVyZmxvdyFcIik7XG5cdH1cblxuXHQvKipcblx0ICogUmV0cmlldmUgYSBzaW5nbGUgdmVjdG9yIGNvbXBvbmVudCB0aGF0J3Mgc3RpbGwgYXZhaWxhYmxlLlxuXHQgKi9cblx0cHVibGljIHJlcXVlc3RGcmVlUmVnQ29tcG9uZW50KCk6U2hhZGVyUmVnaXN0ZXJFbGVtZW50XG5cdHtcblx0XHRmb3IgKHZhciBpOm51bWJlciA9IDA7IGkgPCB0aGlzLl9yZWdDb3VudDsgKytpKSB7XG5cdFx0XHRpZiAodGhpcy5fdXNlZFZlY3RvckNvdW50W2ldID4gMClcblx0XHRcdFx0Y29udGludWU7XG5cblx0XHRcdGZvciAodmFyIGo6bnVtYmVyID0gMDsgaiA8IDQ7ICsraikge1xuXHRcdFx0XHRpZiAodGhpcy5fdXNlZFNpbmdsZUNvdW50W2pdW2ldID09IDApIHtcblx0XHRcdFx0XHRpZiAodGhpcy5fcGVyc2lzdGVudClcblx0XHRcdFx0XHRcdHRoaXMuX3VzZWRTaW5nbGVDb3VudFtqXVtpXSsrO1xuXG5cdFx0XHRcdFx0cmV0dXJuIHRoaXMuX3JlZ2lzdGVyQ29tcG9uZW50c1tqXVtpXTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHRocm93IG5ldyBFcnJvcihcIlJlZ2lzdGVyIG92ZXJmbG93IVwiKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBNYXJrcyBhIHJlZ2lzdGVyIGFzIHVzZWQsIHNvIGl0IGNhbm5vdCBiZSByZXRyaWV2ZWQuIFRoZSByZWdpc3RlciB3b24ndCBiZSBhYmxlIHRvIGJlIHVzZWQgdW50aWwgcmVtb3ZlVXNhZ2Vcblx0ICogaGFzIGJlZW4gY2FsbGVkIHVzYWdlQ291bnQgdGltZXMgYWdhaW4uXG5cdCAqIEBwYXJhbSByZWdpc3RlciBUaGUgcmVnaXN0ZXIgdG8gbWFyayBhcyB1c2VkLlxuXHQgKiBAcGFyYW0gdXNhZ2VDb3VudCBUaGUgYW1vdW50IG9mIHVzYWdlcyB0byBhZGQuXG5cdCAqL1xuXHRwdWJsaWMgYWRkVXNhZ2UocmVnaXN0ZXI6U2hhZGVyUmVnaXN0ZXJFbGVtZW50LCB1c2FnZUNvdW50Om51bWJlcilcblx0e1xuXHRcdGlmIChyZWdpc3Rlci5fY29tcG9uZW50ID4gLTEpXG5cdFx0XHR0aGlzLl91c2VkU2luZ2xlQ291bnRbcmVnaXN0ZXIuX2NvbXBvbmVudF1bcmVnaXN0ZXIuaW5kZXhdICs9IHVzYWdlQ291bnQ7XG5cdFx0ZWxzZVxuXHRcdFx0dGhpcy5fdXNlZFZlY3RvckNvdW50W3JlZ2lzdGVyLmluZGV4XSArPSB1c2FnZUNvdW50O1xuXHR9XG5cblx0LyoqXG5cdCAqIFJlbW92ZXMgYSB1c2FnZSBmcm9tIGEgcmVnaXN0ZXIuIFdoZW4gdXNhZ2VzIHJlYWNoIDAsIHRoZSByZWdpc3RlciBpcyBmcmVlZCBhZ2Fpbi5cblx0ICogQHBhcmFtIHJlZ2lzdGVyIFRoZSByZWdpc3RlciBmb3Igd2hpY2ggdG8gcmVtb3ZlIGEgdXNhZ2UuXG5cdCAqL1xuXHRwdWJsaWMgcmVtb3ZlVXNhZ2UocmVnaXN0ZXI6U2hhZGVyUmVnaXN0ZXJFbGVtZW50KVxuXHR7XG5cdFx0aWYgKHJlZ2lzdGVyLl9jb21wb25lbnQgPiAtMSkge1xuXHRcdFx0aWYgKC0tdGhpcy5fdXNlZFNpbmdsZUNvdW50W3JlZ2lzdGVyLl9jb21wb25lbnRdW3JlZ2lzdGVyLmluZGV4XSA8IDApXG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihcIk1vcmUgdXNhZ2VzIHJlbW92ZWQgdGhhbiBleGlzdCFcIik7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGlmICgtLXRoaXMuX3VzZWRWZWN0b3JDb3VudFtyZWdpc3Rlci5pbmRleF0gPCAwKVxuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoXCJNb3JlIHVzYWdlcyByZW1vdmVkIHRoYW4gZXhpc3QhXCIpO1xuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBEaXNwb3NlcyBhbnkgcmVzb3VyY2VzIHVzZWQgYnkgdGhlIGN1cnJlbnQgUmVnaXN0ZXJQb29sIG9iamVjdC5cblx0ICovXG5cdHB1YmxpYyBkaXNwb3NlKClcblx0e1xuXHRcdHRoaXMuX3ZlY3RvclJlZ2lzdGVycyA9IG51bGw7XG5cdFx0dGhpcy5fcmVnaXN0ZXJDb21wb25lbnRzID0gbnVsbDtcblx0XHR0aGlzLl91c2VkU2luZ2xlQ291bnQgPSBudWxsO1xuXHRcdHRoaXMuX3VzZWRWZWN0b3JDb3VudCA9IG51bGw7XG5cdH1cblxuXHQvKipcblx0ICogSW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IGFueSByZWdpc3RlcnMgYXJlIGluIHVzZS5cblx0ICovXG5cdHB1YmxpYyBoYXNSZWdpc3RlcmVkUmVncygpOmJvb2xlYW5cblx0e1xuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8IHRoaXMuX3JlZ0NvdW50OyArK2kpXG5cdFx0XHRpZiAodGhpcy5pc1JlZ2lzdGVyVXNlZChpKSlcblx0XHRcdFx0cmV0dXJuIHRydWU7XG5cblx0XHRyZXR1cm4gZmFsc2U7XG5cdH1cblxuXHQvKipcblx0ICogSW5pdGlhbGl6ZXMgYWxsIHJlZ2lzdGVycy5cblx0ICovXG5cdHByaXZhdGUgaW5pdFJlZ2lzdGVycyhyZWdOYW1lOnN0cmluZywgcmVnQ291bnQ6bnVtYmVyKVxuXHR7XG5cdFx0dmFyIGhhc2g6c3RyaW5nID0gUmVnaXN0ZXJQb29sLl9pbml0UG9vbChyZWdOYW1lLCByZWdDb3VudCk7XG5cblx0XHR0aGlzLl92ZWN0b3JSZWdpc3RlcnMgPSBSZWdpc3RlclBvb2wuX3JlZ1Bvb2xbaGFzaF07XG5cdFx0dGhpcy5fcmVnaXN0ZXJDb21wb25lbnRzID0gUmVnaXN0ZXJQb29sLl9yZWdDb21wc1Bvb2xbaGFzaF07XG5cblx0XHR0aGlzLl91c2VkVmVjdG9yQ291bnQgPSB0aGlzLl9pbml0QXJyYXkoQXJyYXk8bnVtYmVyPihyZWdDb3VudCksIDApO1xuXG5cdFx0dGhpcy5fdXNlZFNpbmdsZUNvdW50ID0gbmV3IEFycmF5PEFycmF5PG51bWJlcj4+KDQpO1xuXHRcdHRoaXMuX3VzZWRTaW5nbGVDb3VudFswXSA9IHRoaXMuX2luaXRBcnJheShuZXcgQXJyYXk8bnVtYmVyPihyZWdDb3VudCksIDApO1xuXHRcdHRoaXMuX3VzZWRTaW5nbGVDb3VudFsxXSA9IHRoaXMuX2luaXRBcnJheShuZXcgQXJyYXk8bnVtYmVyPihyZWdDb3VudCksIDApO1xuXHRcdHRoaXMuX3VzZWRTaW5nbGVDb3VudFsyXSA9IHRoaXMuX2luaXRBcnJheShuZXcgQXJyYXk8bnVtYmVyPihyZWdDb3VudCksIDApO1xuXHRcdHRoaXMuX3VzZWRTaW5nbGVDb3VudFszXSA9IHRoaXMuX2luaXRBcnJheShuZXcgQXJyYXk8bnVtYmVyPihyZWdDb3VudCksIDApO1xuXHR9XG5cblx0cHJpdmF0ZSBzdGF0aWMgX2luaXRQb29sKHJlZ05hbWU6c3RyaW5nLCByZWdDb3VudDpudW1iZXIpOnN0cmluZ1xuXHR7XG5cdFx0dmFyIGhhc2g6c3RyaW5nID0gcmVnTmFtZSArIHJlZ0NvdW50O1xuXG5cdFx0aWYgKFJlZ2lzdGVyUG9vbC5fcmVnUG9vbFtoYXNoXSAhPSB1bmRlZmluZWQpXG5cdFx0XHRyZXR1cm4gaGFzaDtcblxuXHRcdHZhciB2ZWN0b3JSZWdpc3RlcnM6QXJyYXk8U2hhZGVyUmVnaXN0ZXJFbGVtZW50PiA9IG5ldyBBcnJheTxTaGFkZXJSZWdpc3RlckVsZW1lbnQ+KHJlZ0NvdW50KTtcblx0XHRSZWdpc3RlclBvb2wuX3JlZ1Bvb2xbaGFzaF0gPSB2ZWN0b3JSZWdpc3RlcnM7XG5cblx0XHR2YXIgcmVnaXN0ZXJDb21wb25lbnRzID0gW1xuXHRcdFx0W10sXG5cdFx0XHRbXSxcblx0XHRcdFtdLFxuXHRcdFx0W11cblx0XHRdO1xuXHRcdFJlZ2lzdGVyUG9vbC5fcmVnQ29tcHNQb29sW2hhc2hdID0gcmVnaXN0ZXJDb21wb25lbnRzO1xuXG5cdFx0Zm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgcmVnQ291bnQ7ICsraSkge1xuXG5cdFx0XHR2ZWN0b3JSZWdpc3RlcnNbaV0gPSBuZXcgU2hhZGVyUmVnaXN0ZXJFbGVtZW50KHJlZ05hbWUsIGkpO1xuXG5cdFx0XHRmb3IgKHZhciBqOm51bWJlciA9IDA7IGogPCA0OyArK2opXG5cdFx0XHRcdHJlZ2lzdGVyQ29tcG9uZW50c1tqXVtpXSA9IG5ldyBTaGFkZXJSZWdpc3RlckVsZW1lbnQocmVnTmFtZSwgaSwgaik7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGhhc2g7XG5cdH1cblxuXG5cdC8qKlxuXHQgKiBDaGVjayBpZiB0aGUgdGVtcCByZWdpc3RlciBpcyBlaXRoZXIgdXNlZCBmb3Igc2luZ2xlIG9yIHZlY3RvciB1c2Vcblx0ICovXG5cdHByaXZhdGUgaXNSZWdpc3RlclVzZWQoaW5kZXg6bnVtYmVyKTpib29sZWFuXG5cdHtcblx0XHRpZiAodGhpcy5fdXNlZFZlY3RvckNvdW50W2luZGV4XSA+IDApXG5cdFx0XHRyZXR1cm4gdHJ1ZTtcblxuXHRcdGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8IDQ7ICsraSlcblx0XHRcdGlmICh0aGlzLl91c2VkU2luZ2xlQ291bnRbaV1baW5kZXhdID4gMClcblx0XHRcdFx0cmV0dXJuIHRydWU7XG5cblx0XHRyZXR1cm4gZmFsc2U7XG5cdH1cblxuXG5cdHByaXZhdGUgX2luaXRBcnJheShhOkFycmF5PGFueT4sIHZhbDphbnkpOkFycmF5PGFueT5cblx0e1xuXHRcdHZhciBsOm51bWJlciA9IGEubGVuZ3RoO1xuXG5cdFx0Zm9yICh2YXIgYzpudW1iZXIgPSAwOyBjIDwgbDsgYysrKVxuXHRcdFx0YVtjXSA9IHZhbDtcblxuXHRcdHJldHVybiBhO1xuXHR9XG59XG5cbmV4cG9ydCA9IFJlZ2lzdGVyUG9vbDtcbiJdfQ==