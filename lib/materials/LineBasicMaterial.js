var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var Matrix3D = require("awayjs-core/lib/geom/Matrix3D");
var LineSubGeometry = require("awayjs-display/lib/base/LineSubGeometry");
var ContextGLProgramType = require("awayjs-stagegl/lib/base/ContextGLProgramType");
var StageGLMaterialBase = require("awayjs-stagegl/lib/materials/StageGLMaterialBase");
var LineBasicPass = require("awayjs-stagegl/lib/materials/passes/LineBasicPass");
/**
 * LineMaterial is a material exclusively used to render wireframe objects
 *
 * @see away.entities.Lines
 */
var LineBasicMaterial = (function (_super) {
    __extends(LineBasicMaterial, _super);
    /**
     * Creates a new LineMaterial object.
     *
     * @param thickness The thickness of the wireframe lines.
     */
    function LineBasicMaterial(thickness) {
        if (thickness === void 0) { thickness = 1.25; }
        _super.call(this);
        this._constants = new Array(0, 0, 0, 0);
        this._thickness = thickness;
        this.bothSides = true;
        this._pAddScreenPass(this._screenPass = new LineBasicPass());
        this._calcMatrix = new Matrix3D();
        this._constants[1] = 1 / 255;
    }
    /**
     * @inheritDoc
     */
    LineBasicMaterial.prototype._iGetVertexCode = function (shaderObject, regCache, sharedReg) {
        return "m44 vt0, va0, vc8			\n" + "m44 vt1, va1, vc8			\n" + "sub vt2, vt1, vt0 			\n" + "slt vt5.x, vt0.z, vc7.z			\n" + "sub vt5.y, vc5.x, vt5.x			\n" + "add vt4.x, vt0.z, vc7.z			\n" + "sub vt4.y, vt0.z, vt1.z			\n" + "seq vt4.z, vt4.y vc6.x			\n" + "add vt4.y, vt4.y, vt4.z			\n" + "div vt4.z, vt4.x, vt4.y			\n" + "mul vt4.xyz, vt4.zzz, vt2.xyz	\n" + "add vt3.xyz, vt0.xyz, vt4.xyz	\n" + "mov vt3.w, vc5.x			\n" + "mul vt0, vt0, vt5.yyyy			\n" + "mul vt3, vt3, vt5.xxxx			\n" + "add vt0, vt0, vt3				\n" + "sub vt2, vt1, vt0 			\n" + "nrm vt2.xyz, vt2.xyz			\n" + "nrm vt5.xyz, vt0.xyz			\n" + "mov vt5.w, vc5.x				\n" + "crs vt3.xyz, vt2, vt5			\n" + "nrm vt3.xyz, vt3.xyz			\n" + "mul vt3.xyz, vt3.xyz, va2.xxx	\n" + "mov vt3.w, vc5.x			\n" + "dp3 vt4.x, vt0, vc6			\n" + "mul vt4.x, vt4.x, vc7.x			\n" + "mul vt3.xyz, vt3.xyz, vt4.xxx	\n" + "add vt0.xyz, vt0.xyz, vt3.xyz	\n" + "m44 op, vt0, vc0			\n" + "mov v0, va3				\n";
    };
    /**
     * @inheritDoc
     */
    LineBasicMaterial.prototype._iActivatePass = function (pass, stage, camera) {
        _super.prototype._iActivatePass.call(this, pass, stage, camera);
        var context = stage.context;
        this._constants[0] = this._thickness / ((stage.scissorRect) ? Math.min(stage.scissorRect.width, stage.scissorRect.height) : Math.min(stage.width, stage.height));
        // value to convert distance from camera to model length per pixel width
        this._constants[2] = camera.projection.near;
        context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 5, LineBasicMaterial.pONE_VECTOR, 1);
        context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 6, LineBasicMaterial.pFRONT_VECTOR, 1);
        context.setProgramConstantsFromArray(ContextGLProgramType.VERTEX, 7, this._constants, 1);
        // projection matrix
        context.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX, 0, camera.projection.matrix, true);
    };
    /**
     * @inheritDoc
     */
    LineBasicMaterial.prototype._iRenderPass = function (pass, renderable, stage, camera, viewProjection) {
        _super.prototype._iRenderPass.call(this, pass, renderable, stage, camera, viewProjection);
        var context = stage.context;
        this._calcMatrix.copyFrom(renderable.sourceEntity.sceneTransform);
        this._calcMatrix.append(camera.inverseSceneTransform);
        context.setProgramConstantsFromMatrix(ContextGLProgramType.VERTEX, 8, this._calcMatrix, true);
        context.activateBuffer(0, renderable.getVertexData(LineSubGeometry.START_POSITION_DATA), renderable.getVertexOffset(LineSubGeometry.START_POSITION_DATA), LineSubGeometry.POSITION_FORMAT);
        context.activateBuffer(1, renderable.getVertexData(LineSubGeometry.END_POSITION_DATA), renderable.getVertexOffset(LineSubGeometry.END_POSITION_DATA), LineSubGeometry.POSITION_FORMAT);
        context.activateBuffer(2, renderable.getVertexData(LineSubGeometry.THICKNESS_DATA), renderable.getVertexOffset(LineSubGeometry.THICKNESS_DATA), LineSubGeometry.THICKNESS_FORMAT);
        context.activateBuffer(3, renderable.getVertexData(LineSubGeometry.COLOR_DATA), renderable.getVertexOffset(LineSubGeometry.COLOR_DATA), LineSubGeometry.COLOR_FORMAT);
        context.drawTriangles(context.getIndexBuffer(renderable.getIndexData()), 0, renderable.numTriangles);
    };
    LineBasicMaterial.pONE_VECTOR = Array(1, 1, 1, 1);
    LineBasicMaterial.pFRONT_VECTOR = Array(0, 0, -1, 0);
    return LineBasicMaterial;
})(StageGLMaterialBase);
module.exports = LineBasicMaterial;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF3YXlqcy1zdGFnZWdsL2xpYi9tYXRlcmlhbHMvbGluZWJhc2ljbWF0ZXJpYWwudHMiXSwibmFtZXMiOlsiTGluZUJhc2ljTWF0ZXJpYWwiLCJMaW5lQmFzaWNNYXRlcmlhbC5jb25zdHJ1Y3RvciIsIkxpbmVCYXNpY01hdGVyaWFsLl9pR2V0VmVydGV4Q29kZSIsIkxpbmVCYXNpY01hdGVyaWFsLl9pQWN0aXZhdGVQYXNzIiwiTGluZUJhc2ljTWF0ZXJpYWwuX2lSZW5kZXJQYXNzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFPLFFBQVEsV0FBZ0IsK0JBQStCLENBQUMsQ0FBQztBQUVoRSxJQUFPLGVBQWUsV0FBYyx5Q0FBeUMsQ0FBQyxDQUFDO0FBTS9FLElBQU8sb0JBQW9CLFdBQWEsOENBQThDLENBQUMsQ0FBQztBQUV4RixJQUFPLG1CQUFtQixXQUFhLGtEQUFrRCxDQUFDLENBQUM7QUFJM0YsSUFBTyxhQUFhLFdBQWMsbURBQW1ELENBQUMsQ0FBQztBQUV2RixBQUtBOzs7O0dBREc7SUFDRyxpQkFBaUI7SUFBU0EsVUFBMUJBLGlCQUFpQkEsVUFBNEJBO0lBV2xEQTs7OztPQUlHQTtJQUNIQSxTQWhCS0EsaUJBQWlCQSxDQWdCVkEsU0FBdUJBO1FBQXZCQyx5QkFBdUJBLEdBQXZCQSxnQkFBdUJBO1FBRWxDQSxpQkFBT0EsQ0FBQ0E7UUFiREEsZUFBVUEsR0FBaUJBLElBQUlBLEtBQUtBLENBQVNBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBZWhFQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxTQUFTQSxDQUFDQTtRQUU1QkEsSUFBSUEsQ0FBQ0EsU0FBU0EsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFFdEJBLElBQUlBLENBQUNBLGVBQWVBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLElBQUlBLGFBQWFBLEVBQUVBLENBQUNBLENBQUNBO1FBRTdEQSxJQUFJQSxDQUFDQSxXQUFX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LEVBQUVBLFVBQVVBLENBQUNBLGFBQWFBLENBQUNBLGVBQWVBLENBQUNBLGNBQWNBLENBQUNBLEVBQUVBLFVBQVVBLENBQUNBLGVBQWVBLENBQUNBLGVBQWVBLENBQUNBLGNBQWNBLENBQUNBLEVBQUVBLGVBQWVBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsQ0FBQ0E7UUFDbExBLE9BQU9BLENBQUNBLGNBQWNBLENBQUNBLENBQUNBLEVBQUVBLFVBQVVBLENBQUNBLGFBQWFBLENBQUNBLGVBQWVBLENBQUNBLFVBQVVBLENBQUNBLEVBQUVBLFVBQVVBLENBQUNBLGVBQWVBLENBQUNBLGVBQWVBLENBQUNBLFVBQVVBLENBQUNBLEVBQUVBLGVBQWVBLENBQUNBLFlBQVlBLENBQUNBLENBQUNBO1FBRXRLQSxPQUFPQSxDQUFDQSxhQUFhQSxDQUFDQSxPQUFPQSxDQUFDQSxjQUFjQSxDQUFDQSxVQUFVQSxDQUFDQSxZQUFZQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxVQUFVQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQTtJQUN0R0EsQ0FBQ0E7SUF6SWFKLDZCQUFXQSxHQUFpQkEsS0FBS0EsQ0FBU0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDdERBLCtCQUFhQSxHQUFpQkEsS0FBS0EsQ0FBU0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUF5SXhFQSx3QkFBQ0E7QUFBREEsQ0E1SUEsQUE0SUNBLEVBNUkrQixtQkFBbUIsRUE0SWxEO0FBRUQsQUFBMkIsaUJBQWxCLGlCQUFpQixDQUFDIiwiZmlsZSI6Im1hdGVyaWFscy9MaW5lQmFzaWNNYXRlcmlhbC5qcyIsInNvdXJjZVJvb3QiOiIuLi8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgTWF0cml4M0RcdFx0XHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtY29yZS9saWIvZ2VvbS9NYXRyaXgzRFwiKTtcblxuaW1wb3J0IExpbmVTdWJHZW9tZXRyeVx0XHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLWRpc3BsYXkvbGliL2Jhc2UvTGluZVN1Ykdlb21ldHJ5XCIpO1xuaW1wb3J0IENhbWVyYVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1kaXNwbGF5L2xpYi9lbnRpdGllcy9DYW1lcmFcIik7XG5cbmltcG9ydCBTdGFnZVx0XHRcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9iYXNlL1N0YWdlXCIpO1xuaW1wb3J0IE1hdGVyaWFsUGFzc0RhdGFcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9wb29sL01hdGVyaWFsUGFzc0RhdGFcIik7XG5pbXBvcnQgUmVuZGVyYWJsZUJhc2VcdFx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9wb29sL1JlbmRlcmFibGVCYXNlXCIpO1xuaW1wb3J0IENvbnRleHRHTFByb2dyYW1UeXBlXHRcdFx0PSByZXF1aXJlKFwiYXdheWpzLXN0YWdlZ2wvbGliL2Jhc2UvQ29udGV4dEdMUHJvZ3JhbVR5cGVcIik7XG5pbXBvcnQgSUNvbnRleHRTdGFnZUdMXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvYmFzZS9JQ29udGV4dFN0YWdlR0xcIik7XG5pbXBvcnQgU3RhZ2VHTE1hdGVyaWFsQmFzZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9tYXRlcmlhbHMvU3RhZ2VHTE1hdGVyaWFsQmFzZVwiKTtcbmltcG9ydCBTaGFkZXJPYmplY3RCYXNlXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvbWF0ZXJpYWxzL2NvbXBpbGF0aW9uL1NoYWRlck9iamVjdEJhc2VcIik7XG5pbXBvcnQgU2hhZGVyUmVnaXN0ZXJDYWNoZVx0XHRcdD0gcmVxdWlyZShcImF3YXlqcy1zdGFnZWdsL2xpYi9tYXRlcmlhbHMvY29tcGlsYXRpb24vU2hhZGVyUmVnaXN0ZXJDYWNoZVwiKTtcbmltcG9ydCBTaGFkZXJSZWdpc3RlckRhdGFcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvbWF0ZXJpYWxzL2NvbXBpbGF0aW9uL1NoYWRlclJlZ2lzdGVyRGF0YVwiKTtcbmltcG9ydCBMaW5lQmFzaWNQYXNzXHRcdFx0XHQ9IHJlcXVpcmUoXCJhd2F5anMtc3RhZ2VnbC9saWIvbWF0ZXJpYWxzL3Bhc3Nlcy9MaW5lQmFzaWNQYXNzXCIpO1xuXG4vKipcbiAqIExpbmVNYXRlcmlhbCBpcyBhIG1hdGVyaWFsIGV4Y2x1c2l2ZWx5IHVzZWQgdG8gcmVuZGVyIHdpcmVmcmFtZSBvYmplY3RzXG4gKlxuICogQHNlZSBhd2F5LmVudGl0aWVzLkxpbmVzXG4gKi9cbmNsYXNzIExpbmVCYXNpY01hdGVyaWFsIGV4dGVuZHMgU3RhZ2VHTE1hdGVyaWFsQmFzZVxue1xuXHRwdWJsaWMgc3RhdGljIHBPTkVfVkVDVE9SOkFycmF5PG51bWJlcj4gPSBBcnJheTxudW1iZXI+KDEsIDEsIDEsIDEpO1xuXHRwdWJsaWMgc3RhdGljIHBGUk9OVF9WRUNUT1I6QXJyYXk8bnVtYmVyPiA9IEFycmF5PG51bWJlcj4oMCwgMCwgLTEsIDApO1xuXG5cdHByaXZhdGUgX2NvbnN0YW50czpBcnJheTxudW1iZXI+ID0gbmV3IEFycmF5PG51bWJlcj4oMCwgMCwgMCwgMCk7XG5cdHByaXZhdGUgX2NhbGNNYXRyaXg6TWF0cml4M0Q7XG5cdHByaXZhdGUgX3RoaWNrbmVzczpudW1iZXI7XG5cblx0cHJpdmF0ZSBfc2NyZWVuUGFzczpMaW5lQmFzaWNQYXNzO1xuXG5cdC8qKlxuXHQgKiBDcmVhdGVzIGEgbmV3IExpbmVNYXRlcmlhbCBvYmplY3QuXG5cdCAqXG5cdCAqIEBwYXJhbSB0aGlja25lc3MgVGhlIHRoaWNrbmVzcyBvZiB0aGUgd2lyZWZyYW1lIGxpbmVzLlxuXHQgKi9cblx0Y29uc3RydWN0b3IodGhpY2tuZXNzOm51bWJlciA9IDEuMjUpXG5cdHtcblx0XHRzdXBlcigpO1xuXG5cdFx0dGhpcy5fdGhpY2tuZXNzID0gdGhpY2tuZXNzO1xuXG5cdFx0dGhpcy5ib3RoU2lkZXMgPSB0cnVlO1xuXG5cdFx0dGhpcy5fcEFkZFNjcmVlblBhc3ModGhpcy5fc2NyZWVuUGFzcyA9IG5ldyBMaW5lQmFzaWNQYXNzKCkpO1xuXG5cdFx0dGhpcy5fY2FsY01hdHJpeCA9IG5ldyBNYXRyaXgzRCgpO1xuXG5cdFx0dGhpcy5fY29uc3RhbnRzWzFdID0gMS8yNTU7XG5cdH1cblxuXG5cdC8qKlxuXHQgKiBAaW5oZXJpdERvY1xuXHQgKi9cblx0cHVibGljIF9pR2V0VmVydGV4Q29kZShzaGFkZXJPYmplY3Q6U2hhZGVyT2JqZWN0QmFzZSwgcmVnQ2FjaGU6U2hhZGVyUmVnaXN0ZXJDYWNoZSwgc2hhcmVkUmVnOlNoYWRlclJlZ2lzdGVyRGF0YSk6c3RyaW5nXG5cdHtcblx0XHRyZXR1cm4gXCJtNDQgdnQwLCB2YTAsIHZjOFx0XHRcdFxcblwiICsgLy8gdHJhbnNmb3JtIFEwIHRvIGV5ZSBzcGFjZVxuXHRcdFx0XCJtNDQgdnQxLCB2YTEsIHZjOFx0XHRcdFxcblwiICsgLy8gdHJhbnNmb3JtIFExIHRvIGV5ZSBzcGFjZVxuXHRcdFx0XCJzdWIgdnQyLCB2dDEsIHZ0MCBcdFx0XHRcXG5cIiArIC8vIEwgPSBRMSAtIFEwXG5cblx0XHRcdC8vIHRlc3QgaWYgYmVoaW5kIGNhbWVyYSBuZWFyIHBsYW5lXG5cdFx0XHQvLyBpZiAwIC0gUTAueiA8IENhbWVyYS5uZWFyIHRoZW4gdGhlIHBvaW50IG5lZWRzIHRvIGJlIGNsaXBwZWRcblx0XHRcdC8vXCJuZWcgdnQ1LngsIHZ0MC56XHRcdFx0XHRcXG5cIiArIC8vIDAgLSBRMC56XG5cdFx0XHRcInNsdCB2dDUueCwgdnQwLnosIHZjNy56XHRcdFx0XFxuXCIgKyAvLyBiZWhpbmQgPSAoIDAgLSBRMC56IDwgLUNhbWVyYS5uZWFyICkgPyAxIDogMFxuXHRcdFx0XCJzdWIgdnQ1LnksIHZjNS54LCB2dDUueFx0XHRcdFxcblwiICsgLy8gIWJlaGluZCA9IDEgLSBiZWhpbmRcblxuXHRcdFx0Ly8gcCA9IHBvaW50IG9uIHRoZSBwbGFuZSAoMCwwLC1uZWFyKVxuXHRcdFx0Ly8gbiA9IHBsYW5lIG5vcm1hbCAoMCwwLC0xKVxuXHRcdFx0Ly8gRCA9IFExIC0gUTBcblx0XHRcdC8vIHQgPSAoIGRvdCggbiwgKCBwIC0gUTAgKSApIC8gKCBkb3QoIG4sIGQgKVxuXG5cdFx0XHQvLyBzb2x2ZSBmb3IgdCB3aGVyZSBsaW5lIGNyb3NzZXMgQ2FtZXJhLm5lYXJcblx0XHRcdFwiYWRkIHZ0NC54LCB2dDAueiwgdmM3LnpcdFx0XHRcXG5cIiArIC8vIFEwLnogKyAoIC1DYW1lcmEubmVhciApXG5cdFx0XHRcInN1YiB2dDQueSwgdnQwLnosIHZ0MS56XHRcdFx0XFxuXCIgKyAvLyBRMC56IC0gUTEuelxuXG5cdFx0XHQvLyBmaXggZGl2aWRlIGJ5IHplcm8gZm9yIGhvcml6b250YWwgbGluZXNcblx0XHRcdFwic2VxIHZ0NC56LCB2dDQueSB2YzYueFx0XHRcdFxcblwiICsgLy8gb2Zmc2V0ID0gKFEwLnogLSBRMS56KT09MCA/IDEgOiAwXG5cdFx0XHRcImFkZCB2dDQueSwgdnQ0LnksIHZ0NC56XHRcdFx0XFxuXCIgKyAvLyAoIFEwLnogLSBRMS56ICkgKyBvZmZzZXRcblxuXHRcdFx0XCJkaXYgdnQ0LnosIHZ0NC54LCB2dDQueVx0XHRcdFxcblwiICsgLy8gdCA9ICggUTAueiAtIG5lYXIgKSAvICggUTAueiAtIFExLnogKVxuXG5cdFx0XHRcIm11bCB2dDQueHl6LCB2dDQuenp6LCB2dDIueHl6XHRcXG5cIiArIC8vIHQoTClcblx0XHRcdFwiYWRkIHZ0My54eXosIHZ0MC54eXosIHZ0NC54eXpcdFxcblwiICsgLy8gUWNsaXBwZWQgPSBRMCArIHQoTClcblx0XHRcdFwibW92IHZ0My53LCB2YzUueFx0XHRcdFxcblwiICsgLy8gUWNsaXBwZWQudyA9IDFcblxuXHRcdFx0Ly8gSWYgbmVjZXNzYXJ5LCByZXBsYWNlIFEwIHdpdGggbmV3IFFjbGlwcGVkXG5cdFx0XHRcIm11bCB2dDAsIHZ0MCwgdnQ1Lnl5eXlcdFx0XHRcXG5cIiArIC8vICFiZWhpbmQgKiBRMFxuXHRcdFx0XCJtdWwgdnQzLCB2dDMsIHZ0NS54eHh4XHRcdFx0XFxuXCIgKyAvLyBiZWhpbmQgKiBRY2xpcHBlZFxuXHRcdFx0XCJhZGQgdnQwLCB2dDAsIHZ0M1x0XHRcdFx0XFxuXCIgKyAvLyBuZXdRMCA9IFEwICsgUWNsaXBwZWRcblxuXHRcdFx0Ly8gY2FsY3VsYXRlIHNpZGUgdmVjdG9yIGZvciBsaW5lXG5cdFx0XHRcInN1YiB2dDIsIHZ0MSwgdnQwIFx0XHRcdFxcblwiICsgLy8gTCA9IFExIC0gUTBcblx0XHRcdFwibnJtIHZ0Mi54eXosIHZ0Mi54eXpcdFx0XHRcXG5cIiArIC8vIG5vcm1hbGl6ZSggTCApXG5cdFx0XHRcIm5ybSB2dDUueHl6LCB2dDAueHl6XHRcdFx0XFxuXCIgKyAvLyBEID0gbm9ybWFsaXplKCBRMSApXG5cdFx0XHRcIm1vdiB2dDUudywgdmM1LnhcdFx0XHRcdFxcblwiICsgLy8gRC53ID0gMVxuXHRcdFx0XCJjcnMgdnQzLnh5eiwgdnQyLCB2dDVcdFx0XHRcXG5cIiArIC8vIFMgPSBMIHggRFxuXHRcdFx0XCJucm0gdnQzLnh5eiwgdnQzLnh5elx0XHRcdFxcblwiICsgLy8gbm9ybWFsaXplKCBTIClcblxuXHRcdFx0Ly8gZmFjZSB0aGUgc2lkZSB2ZWN0b3IgcHJvcGVybHkgZm9yIHRoZSBnaXZlbiBwb2ludFxuXHRcdFx0XCJtdWwgdnQzLnh5eiwgdnQzLnh5eiwgdmEyLnh4eFx0XFxuXCIgKyAvLyBTICo9IHdlaWdodFxuXHRcdFx0XCJtb3YgdnQzLncsIHZjNS54XHRcdFx0XFxuXCIgKyAvLyBTLncgPSAxXG5cblx0XHRcdC8vIGNhbGN1bGF0ZSB0aGUgYW1vdW50IHJlcXVpcmVkIHRvIG1vdmUgYXQgdGhlIHBvaW50J3MgZGlzdGFuY2UgdG8gY29ycmVzcG9uZCB0byB0aGUgbGluZSdzIHBpeGVsIHdpZHRoXG5cdFx0XHQvLyBzY2FsZSB0aGUgc2lkZSB2ZWN0b3IgYnkgdGhhdCBhbW91bnRcblx0XHRcdFwiZHAzIHZ0NC54LCB2dDAsIHZjNlx0XHRcdFxcblwiICsgLy8gZGlzdGFuY2UgPSBkb3QoIHZpZXcgKVxuXHRcdFx0XCJtdWwgdnQ0LngsIHZ0NC54LCB2YzcueFx0XHRcdFxcblwiICsgLy8gZGlzdGFuY2UgKj0gdnBzb2Rcblx0XHRcdFwibXVsIHZ0My54eXosIHZ0My54eXosIHZ0NC54eHhcdFxcblwiICsgLy8gUy54eXogKj0gcGl4ZWxTY2FsZUZhY3RvclxuXG5cdFx0XHQvLyBhZGQgc2NhbGVkIHNpZGUgdmVjdG9yIHRvIFEwIGFuZCB0cmFuc2Zvcm0gdG8gY2xpcCBzcGFjZVxuXHRcdFx0XCJhZGQgdnQwLnh5eiwgdnQwLnh5eiwgdnQzLnh5elx0XFxuXCIgKyAvLyBRMCArIFNcblxuXHRcdFx0XCJtNDQgb3AsIHZ0MCwgdmMwXHRcdFx0XFxuXCIgKyAvLyB0cmFuc2Zvcm0gUTAgdG8gY2xpcCBzcGFjZVxuXG5cdFx0XHQvLyBpbnRlcnBvbGF0ZSBjb2xvclxuXHRcdFx0XCJtb3YgdjAsIHZhM1x0XHRcdFx0XFxuXCI7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBfaUFjdGl2YXRlUGFzcyhwYXNzOk1hdGVyaWFsUGFzc0RhdGEsIHN0YWdlOlN0YWdlLCBjYW1lcmE6Q2FtZXJhKVxuXHR7XG5cdFx0c3VwZXIuX2lBY3RpdmF0ZVBhc3MocGFzcywgc3RhZ2UsIGNhbWVyYSk7XG5cblx0XHR2YXIgY29udGV4dDpJQ29udGV4dFN0YWdlR0wgPSA8SUNvbnRleHRTdGFnZUdMPiBzdGFnZS5jb250ZXh0O1xuXG5cdFx0dGhpcy5fY29uc3RhbnRzWzBdID0gdGhpcy5fdGhpY2tuZXNzLygoc3RhZ2Uuc2Npc3NvclJlY3QpPyBNYXRoLm1pbihzdGFnZS5zY2lzc29yUmVjdC53aWR0aCwgc3RhZ2Uuc2Npc3NvclJlY3QuaGVpZ2h0KSA6IE1hdGgubWluKHN0YWdlLndpZHRoLCBzdGFnZS5oZWlnaHQpKTtcblxuXHRcdC8vIHZhbHVlIHRvIGNvbnZlcnQgZGlzdGFuY2UgZnJvbSBjYW1lcmEgdG8gbW9kZWwgbGVuZ3RoIHBlciBwaXhlbCB3aWR0aFxuXHRcdHRoaXMuX2NvbnN0YW50c1syXSA9IGNhbWVyYS5wcm9qZWN0aW9uLm5lYXI7XG5cblx0XHRjb250ZXh0LnNldFByb2dyYW1Db25zdGFudHNGcm9tQXJyYXkoQ29udGV4dEdMUHJvZ3JhbVR5cGUuVkVSVEVYLCA1LCBMaW5lQmFzaWNNYXRlcmlhbC5wT05FX1ZFQ1RPUiwgMSk7XG5cdFx0Y29udGV4dC5zZXRQcm9ncmFtQ29uc3RhbnRzRnJvbUFycmF5KENvbnRleHRHTFByb2dyYW1UeXBlLlZFUlRFWCwgNiwgTGluZUJhc2ljTWF0ZXJpYWwucEZST05UX1ZFQ1RPUiwgMSk7XG5cdFx0Y29udGV4dC5zZXRQcm9ncmFtQ29uc3RhbnRzRnJvbUFycmF5KENvbnRleHRHTFByb2dyYW1UeXBlLlZFUlRFWCwgNywgdGhpcy5fY29uc3RhbnRzLCAxKTtcblxuXHRcdC8vIHByb2plY3Rpb24gbWF0cml4XG5cdFx0Y29udGV4dC5zZXRQcm9ncmFtQ29uc3RhbnRzRnJvbU1hdHJpeChDb250ZXh0R0xQcm9ncmFtVHlwZS5WRVJURVgsIDAsIGNhbWVyYS5wcm9qZWN0aW9uLm1hdHJpeCwgdHJ1ZSk7XG5cdH1cblxuXHQvKipcblx0ICogQGluaGVyaXREb2Ncblx0ICovXG5cdHB1YmxpYyBfaVJlbmRlclBhc3MocGFzczpNYXRlcmlhbFBhc3NEYXRhLCByZW5kZXJhYmxlOlJlbmRlcmFibGVCYXNlLCBzdGFnZTpTdGFnZSwgY2FtZXJhOkNhbWVyYSwgdmlld1Byb2plY3Rpb246TWF0cml4M0QpXG5cdHtcblx0XHRzdXBlci5faVJlbmRlclBhc3MocGFzcywgcmVuZGVyYWJsZSwgc3RhZ2UsIGNhbWVyYSwgdmlld1Byb2plY3Rpb24pO1xuXG5cdFx0dmFyIGNvbnRleHQ6SUNvbnRleHRTdGFnZUdMID0gPElDb250ZXh0U3RhZ2VHTD4gc3RhZ2UuY29udGV4dDtcblx0XHR0aGlzLl9jYWxjTWF0cml4LmNvcHlGcm9tKHJlbmRlcmFibGUuc291cmNlRW50aXR5LnNjZW5lVHJhbnNmb3JtKTtcblx0XHR0aGlzLl9jYWxjTWF0cml4LmFwcGVuZChjYW1lcmEuaW52ZXJzZVNjZW5lVHJhbnNmb3JtKTtcblxuXHRcdGNvbnRleHQuc2V0UHJvZ3JhbUNvbnN0YW50c0Zyb21NYXRyaXgoQ29udGV4dEdMUHJvZ3JhbVR5cGUuVkVSVEVYLCA4LCB0aGlzLl9jYWxjTWF0cml4LCB0cnVlKTtcblxuXHRcdGNvbnRleHQuYWN0aXZhdGVCdWZmZXIoMCwgcmVuZGVyYWJsZS5nZXRWZXJ0ZXhEYXRhKExpbmVTdWJHZW9tZXRyeS5TVEFSVF9QT1NJVElPTl9EQVRBKSwgcmVuZGVyYWJsZS5nZXRWZXJ0ZXhPZmZzZXQoTGluZVN1Ykdlb21ldHJ5LlNUQVJUX1BPU0lUSU9OX0RBVEEpLCBMaW5lU3ViR2VvbWV0cnkuUE9TSVRJT05fRk9STUFUKTtcblx0XHRjb250ZXh0LmFjdGl2YXRlQnVmZmVyKDEsIHJlbmRlcmFibGUuZ2V0VmVydGV4RGF0YShMaW5lU3ViR2VvbWV0cnkuRU5EX1BPU0lUSU9OX0RBVEEpLCByZW5kZXJhYmxlLmdldFZlcnRleE9mZnNldChMaW5lU3ViR2VvbWV0cnkuRU5EX1BPU0lUSU9OX0RBVEEpLCBMaW5lU3ViR2VvbWV0cnkuUE9TSVRJT05fRk9STUFUKTtcblx0XHRjb250ZXh0LmFjdGl2YXRlQnVmZmVyKDIsIHJlbmRlcmFibGUuZ2V0VmVydGV4RGF0YShMaW5lU3ViR2VvbWV0cnkuVEhJQ0tORVNTX0RBVEEpLCByZW5kZXJhYmxlLmdldFZlcnRleE9mZnNldChMaW5lU3ViR2VvbWV0cnkuVEhJQ0tORVNTX0RBVEEpLCBMaW5lU3ViR2VvbWV0cnkuVEhJQ0tORVNTX0ZPUk1BVCk7XG5cdFx0Y29udGV4dC5hY3RpdmF0ZUJ1ZmZlcigzLCByZW5kZXJhYmxlLmdldFZlcnRleERhdGEoTGluZVN1Ykdlb21ldHJ5LkNPTE9SX0RBVEEpLCByZW5kZXJhYmxlLmdldFZlcnRleE9mZnNldChMaW5lU3ViR2VvbWV0cnkuQ09MT1JfREFUQSksIExpbmVTdWJHZW9tZXRyeS5DT0xPUl9GT1JNQVQpO1xuXG5cdFx0Y29udGV4dC5kcmF3VHJpYW5nbGVzKGNvbnRleHQuZ2V0SW5kZXhCdWZmZXIocmVuZGVyYWJsZS5nZXRJbmRleERhdGEoKSksIDAsIHJlbmRlcmFibGUubnVtVHJpYW5nbGVzKTtcblx0fVxufVxuXG5leHBvcnQgPSBMaW5lQmFzaWNNYXRlcmlhbDsiXX0=